<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jong-Hoon Kim">
<meta name="dcterms.date" content="2024-02-05">

<title>Jong-Hoon Kim’s Blog - How GPT works 1: Add one word at a time</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jong-Hoon Kim’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kimfinale" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/tarzanthoreau" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">How GPT works 1: Add one word at a time</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">GPT2</div>
    <div class="quarto-category">LLM</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jong-Hoon Kim </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 5, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>스티븐 울프램 (<a href="https://www.stephenwolfram.com/">Stephen Wolfram</a>)이 쓴 챗GPT에 관한 블로그 <a href="https://writings.stephenwolfram.com/2023/02/what-is-chatgpt-doing-and-why-does-it-work/">What Is ChatGPT Doing … and Why Does It Work?</a>를 읽고 난 후 ChatGPT에 더 흥미가 생겼다. 블로그 내용을 잘 이해하기 위해 한글로 번역하고 내 생각과 파이썬 코드를 더하여 블로그로 만들고자 하였다. 원본에 충실한 번역은 아니고 내 생각을 더해가면서 작성하였다. ChatGPT에 대한 기초 이해가 없어 아래 <a href="https://huggingface.co/blog/how-to-generate">블로그</a>와 <a href="https://cdn.openai.com/better-language-models/language_models_are_unsupervised_multitask_learners.pdf">논문</a>을 참조하였다.</p>
<p>울프램이 블로그에 썼듯이 ChatGPT가 하는 것은 한 마다로 말해 기존 문장의 끝에 한 번에 한 단어씩 더할 뿐이다. 단어 (word) 보다는 토큰 (token)이라는 용어가 정확한 말이다. 토큰은 단어, 문장 부호, 혹 단어의 일부가 될 수도 있다. 영어에 약 50,000개의 토큰이 있다고 한다. 편의상 이 글에서는 토큰 대신 단어를 사용하겠다.</p>
<p>한 번에 하나씩 단어를 더할 뿐인데 사람이 작성한 것 같은 긴 글을 쓸 수 있는 것이 놀랍다. 주어진 문장의 다음에 50,000개의 단어 중에 어떤 것을 쓸지 ChatGPT는 어떻게 결정할까? 인터넷이나, 전자책 등을 이용해서 기존의 문장을 학습한 후 ChatGPT는 각 문장 (들)의 다음에 올 수 있는 단어의 빈도수를 기반으로 50000개의 단어 각각에 확률을 부어하고 그 확률에 기반하여 다음 단어를 선택한다. 다만 확률이 제일 높은 단어만을 고르는 것도 아니고 전적으로 확률에 기반하여 고르는 것도 아니다. 여러가지 방법이 있고 확률이 낮은 단어들도 사용되는 빈도를 결정하는 모수가 소위 temperature라고 불리는 모수이다. 이 모수는 0과 1사이의 값을 갖는데 temperature가 0이면 확률이 제일 높은 단어만을 고르게 되고 0.8정도의 값일때 사람이 작성한 문장과 가정 비슷한 문장을 만들어 낸다고 한다.</p>
<p>아래 파이썬 코드로 특정한 문장 이후에 올 단어의 확률을 알아보자. 울프램의 블로그에서처럼 GPT2를 사용하였다. GPT2는 개인용 컴퓨터에서 구동하는 데도 문제가 없다.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> AutoModelForCausalLM, AutoTokenizer</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the model and tokenizer</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> AutoTokenizer.from_pretrained(<span class="st">"gpt2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Downloading:   0%|          | 0.00/26.0 [00:00&lt;?, ?B/s]
Downloading: 100%|##########| 26.0/26.0 [00:00&lt;00:00, 12.4kB/s]

Downloading:   0%|          | 0.00/665 [00:00&lt;?, ?B/s]
Downloading: 100%|##########| 665/665 [00:00&lt;00:00, 344kB/s]

Downloading:   0%|          | 0.00/1.04M [00:00&lt;?, ?B/s]
Downloading:   3%|3         | 31.7k/1.04M [00:00&lt;00:05, 176kB/s]
Downloading:  10%|9         | 100k/1.04M [00:00&lt;00:03, 292kB/s] 
Downloading:  22%|##2       | 232k/1.04M [00:00&lt;00:01, 485kB/s]
Downloading:  50%|#####     | 526k/1.04M [00:00&lt;00:00, 920kB/s]
Downloading: 100%|##########| 1.04M/1.04M [00:00&lt;00:00, 1.38MB/s]

Downloading:   0%|          | 0.00/456k [00:00&lt;?, ?B/s]
Downloading:   7%|7         | 33.8k/456k [00:00&lt;00:02, 192kB/s]
Downloading:  22%|##1       | 99.3k/456k [00:00&lt;00:01, 290kB/s]
Downloading:  54%|#####4    | 247k/456k [00:00&lt;00:00, 525kB/s] 
Downloading: 100%|##########| 456k/456k [00:00&lt;00:00, 818kB/s]

Downloading:   0%|          | 0.00/1.36M [00:00&lt;?, ?B/s]
Downloading:   2%|2         | 33.8k/1.36M [00:00&lt;00:06, 195kB/s]
Downloading:   7%|7         | 99.3k/1.36M [00:00&lt;00:04, 290kB/s]
Downloading:  18%|#8        | 247k/1.36M [00:00&lt;00:02, 523kB/s] 
Downloading:  39%|###8      | 525k/1.36M [00:00&lt;00:00, 913kB/s]
Downloading:  81%|########1 | 1.10M/1.36M [00:00&lt;00:00, 1.71MB/s]
Downloading: 100%|##########| 1.36M/1.36M [00:00&lt;00:00, 1.45MB/s]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AutoModelForCausalLM.from_pretrained(<span class="st">"gpt2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Downloading:   0%|          | 0.00/548M [00:00&lt;?, ?B/s]
Downloading:   0%|          | 2.23M/548M [00:00&lt;00:24, 22.2MB/s]
Downloading:   1%|          | 4.73M/548M [00:00&lt;00:22, 23.8MB/s]
Downloading:   1%|1         | 7.11M/548M [00:00&lt;00:24, 22.2MB/s]
Downloading:   2%|1         | 9.72M/548M [00:00&lt;00:22, 23.6MB/s]
Downloading:   2%|2         | 12.2M/548M [00:00&lt;00:22, 24.0MB/s]
Downloading:   3%|2         | 14.6M/548M [00:00&lt;00:22, 23.5MB/s]
Downloading:   3%|3         | 17.0M/548M [00:00&lt;00:23, 23.1MB/s]
Downloading:   4%|3         | 19.3M/548M [00:00&lt;00:23, 22.8MB/s]
Downloading:   4%|3         | 21.7M/548M [00:00&lt;00:22, 23.1MB/s]
Downloading:   4%|4         | 24.2M/548M [00:01&lt;00:22, 23.7MB/s]
Downloading:   5%|4         | 26.6M/548M [00:01&lt;00:22, 23.3MB/s]
Downloading:   5%|5         | 28.9M/548M [00:01&lt;00:22, 23.4MB/s]
Downloading:   6%|5         | 31.4M/548M [00:01&lt;00:21, 23.8MB/s]
Downloading:   6%|6         | 33.9M/548M [00:01&lt;00:21, 23.9MB/s]
Downloading:   7%|6         | 36.3M/548M [00:01&lt;00:22, 22.5MB/s]
Downloading:   7%|7         | 38.5M/548M [00:01&lt;00:23, 21.8MB/s]
Downloading:   7%|7         | 40.7M/548M [00:01&lt;00:23, 21.2MB/s]
Downloading:   8%|7         | 42.9M/548M [00:01&lt;00:25, 20.1MB/s]
Downloading:   8%|8         | 44.9M/548M [00:02&lt;00:25, 20.0MB/s]
Downloading:   9%|8         | 46.9M/548M [00:02&lt;00:24, 20.1MB/s]
Downloading:   9%|9         | 49.4M/548M [00:02&lt;00:23, 21.2MB/s]
Downloading:   9%|9         | 51.6M/548M [00:02&lt;00:23, 21.5MB/s]
Downloading:  10%|9         | 53.9M/548M [00:02&lt;00:22, 22.1MB/s]
Downloading:  10%|#         | 56.9M/548M [00:02&lt;00:20, 24.3MB/s]
Downloading:  11%|#         | 59.7M/548M [00:02&lt;00:19, 25.3MB/s]
Downloading:  11%|#1        | 62.2M/548M [00:02&lt;00:19, 25.1MB/s]
Downloading:  12%|#1        | 64.8M/548M [00:02&lt;00:19, 25.3MB/s]
Downloading:  12%|#2        | 67.4M/548M [00:02&lt;00:19, 25.2MB/s]
Downloading:  13%|#2        | 69.9M/548M [00:03&lt;00:19, 25.1MB/s]
Downloading:  13%|#3        | 72.5M/548M [00:03&lt;00:18, 25.3MB/s]
Downloading:  14%|#3        | 75.0M/548M [00:03&lt;00:18, 25.2MB/s]
Downloading:  14%|#4        | 77.8M/548M [00:03&lt;00:18, 25.9MB/s]
Downloading:  15%|#4        | 80.4M/548M [00:03&lt;00:18, 25.3MB/s]
Downloading:  15%|#5        | 82.9M/548M [00:03&lt;00:18, 25.4MB/s]
Downloading:  16%|#5        | 85.5M/548M [00:03&lt;00:18, 24.4MB/s]
Downloading:  16%|#6        | 87.9M/548M [00:03&lt;00:19, 23.4MB/s]
Downloading:  16%|#6        | 90.3M/548M [00:03&lt;00:21, 21.6MB/s]
Downloading:  17%|#6        | 92.5M/548M [00:03&lt;00:21, 21.4MB/s]
Downloading:  17%|#7        | 94.7M/548M [00:04&lt;00:20, 21.7MB/s]
Downloading:  18%|#7        | 97.0M/548M [00:04&lt;00:20, 21.9MB/s]
Downloading:  18%|#8        | 99.6M/548M [00:04&lt;00:19, 23.1MB/s]
Downloading:  19%|#8        | 102M/548M [00:04&lt;00:18, 23.9MB/s] 
Downloading:  19%|#9        | 105M/548M [00:04&lt;00:18, 24.1MB/s]
Downloading:  20%|#9        | 107M/548M [00:04&lt;00:17, 24.6MB/s]
Downloading:  20%|##        | 110M/548M [00:04&lt;00:17, 25.5MB/s]
Downloading:  21%|##        | 113M/548M [00:04&lt;00:17, 25.4MB/s]
Downloading:  21%|##1       | 115M/548M [00:04&lt;00:17, 25.4MB/s]
Downloading:  21%|##1       | 118M/548M [00:05&lt;00:16, 25.6MB/s]
Downloading:  22%|##1       | 120M/548M [00:05&lt;00:17, 24.2MB/s]
Downloading:  22%|##2       | 123M/548M [00:05&lt;00:17, 25.0MB/s]
Downloading:  23%|##2       | 126M/548M [00:05&lt;00:17, 24.5MB/s]
Downloading:  23%|##3       | 128M/548M [00:05&lt;00:17, 23.9MB/s]
Downloading:  24%|##3       | 131M/548M [00:05&lt;00:16, 24.6MB/s]
Downloading:  24%|##4       | 133M/548M [00:05&lt;00:16, 24.5MB/s]
Downloading:  25%|##4       | 136M/548M [00:05&lt;00:16, 24.8MB/s]
Downloading:  25%|##5       | 138M/548M [00:05&lt;00:16, 24.7MB/s]
Downloading:  26%|##5       | 141M/548M [00:05&lt;00:16, 24.9MB/s]
Downloading:  26%|##6       | 143M/548M [00:06&lt;00:16, 24.8MB/s]
Downloading:  27%|##6       | 146M/548M [00:06&lt;00:16, 24.8MB/s]
Downloading:  27%|##7       | 148M/548M [00:06&lt;00:15, 25.0MB/s]
Downloading:  28%|##7       | 151M/548M [00:06&lt;00:15, 25.6MB/s]
Downloading:  28%|##8       | 154M/548M [00:06&lt;00:16, 23.4MB/s]
Downloading:  28%|##8       | 156M/548M [00:06&lt;00:17, 22.7MB/s]
Downloading:  29%|##8       | 159M/548M [00:06&lt;00:16, 23.5MB/s]
Downloading:  29%|##9       | 161M/548M [00:06&lt;00:16, 24.1MB/s]
Downloading:  30%|##9       | 164M/548M [00:06&lt;00:16, 23.9MB/s]
Downloading:  30%|###       | 166M/548M [00:06&lt;00:15, 24.9MB/s]
Downloading:  31%|###       | 170M/548M [00:07&lt;00:13, 27.3MB/s]
Downloading:  31%|###1      | 173M/548M [00:07&lt;00:13, 28.1MB/s]
Downloading:  32%|###2      | 175M/548M [00:07&lt;00:13, 28.0MB/s]
Downloading:  33%|###2      | 178M/548M [00:07&lt;00:13, 26.9MB/s]
Downloading:  33%|###3      | 181M/548M [00:07&lt;00:13, 26.6MB/s]
Downloading:  34%|###3      | 184M/548M [00:07&lt;00:14, 24.8MB/s]
Downloading:  34%|###3      | 186M/548M [00:07&lt;00:15, 23.4MB/s]
Downloading:  34%|###4      | 189M/548M [00:07&lt;00:14, 24.5MB/s]
Downloading:  35%|###4      | 191M/548M [00:07&lt;00:14, 24.5MB/s]
Downloading:  35%|###5      | 194M/548M [00:08&lt;00:14, 24.7MB/s]
Downloading:  36%|###5      | 197M/548M [00:08&lt;00:13, 26.2MB/s]
Downloading:  36%|###6      | 200M/548M [00:08&lt;00:13, 26.2MB/s]
Downloading:  37%|###6      | 202M/548M [00:08&lt;00:12, 27.0MB/s]
Downloading:  37%|###7      | 205M/548M [00:08&lt;00:13, 25.8MB/s]
Downloading:  38%|###8      | 209M/548M [00:08&lt;00:12, 28.2MB/s]
Downloading:  39%|###8      | 211M/548M [00:08&lt;00:12, 27.6MB/s]
Downloading:  39%|###9      | 215M/548M [00:08&lt;00:11, 29.6MB/s]
Downloading:  40%|###9      | 218M/548M [00:08&lt;00:10, 30.4MB/s]
Downloading:  40%|####      | 221M/548M [00:08&lt;00:10, 30.5MB/s]
Downloading:  41%|####      | 224M/548M [00:09&lt;00:10, 29.5MB/s]
Downloading:  42%|####1     | 228M/548M [00:09&lt;00:10, 30.9MB/s]
Downloading:  42%|####2     | 231M/548M [00:09&lt;00:10, 30.1MB/s]
Downloading:  43%|####2     | 234M/548M [00:09&lt;00:11, 28.2MB/s]
Downloading:  43%|####3     | 237M/548M [00:09&lt;00:11, 27.2MB/s]
Downloading:  44%|####3     | 240M/548M [00:09&lt;00:11, 26.6MB/s]
Downloading:  44%|####4     | 242M/548M [00:09&lt;00:12, 25.3MB/s]
Downloading:  45%|####4     | 245M/548M [00:09&lt;00:12, 24.4MB/s]
Downloading:  45%|####5     | 247M/548M [00:10&lt;00:12, 23.2MB/s]
Downloading:  46%|####5     | 250M/548M [00:10&lt;00:18, 16.3MB/s]
Downloading:  46%|####5     | 252M/548M [00:10&lt;00:17, 17.4MB/s]
Downloading:  46%|####6     | 254M/548M [00:10&lt;00:15, 18.6MB/s]
Downloading:  47%|####6     | 256M/548M [00:10&lt;00:15, 18.4MB/s]
Downloading:  47%|####7     | 258M/548M [00:10&lt;00:15, 19.3MB/s]
Downloading:  48%|####7     | 261M/548M [00:10&lt;00:13, 20.6MB/s]
Downloading:  48%|####8     | 263M/548M [00:10&lt;00:12, 22.1MB/s]
Downloading:  48%|####8     | 266M/548M [00:11&lt;00:13, 21.6MB/s]
Downloading:  49%|####8     | 268M/548M [00:11&lt;00:12, 21.6MB/s]
Downloading:  49%|####9     | 270M/548M [00:11&lt;00:12, 21.5MB/s]
Downloading:  50%|####9     | 272M/548M [00:11&lt;00:13, 21.1MB/s]
Downloading:  50%|#####     | 274M/548M [00:11&lt;00:13, 20.5MB/s]
Downloading:  50%|#####     | 277M/548M [00:11&lt;00:12, 21.5MB/s]
Downloading:  51%|#####     | 279M/548M [00:11&lt;00:12, 22.3MB/s]
Downloading:  51%|#####1    | 282M/548M [00:11&lt;00:11, 23.1MB/s]
Downloading:  52%|#####1    | 284M/548M [00:11&lt;00:11, 23.2MB/s]
Downloading:  52%|#####2    | 286M/548M [00:11&lt;00:11, 22.2MB/s]
Downloading:  53%|#####2    | 289M/548M [00:12&lt;00:12, 20.5MB/s]
Downloading:  53%|#####3    | 291M/548M [00:12&lt;00:12, 20.1MB/s]
Downloading:  53%|#####3    | 293M/548M [00:12&lt;00:12, 19.8MB/s]
Downloading:  54%|#####3    | 295M/548M [00:12&lt;00:13, 19.1MB/s]
Downloading:  54%|#####4    | 297M/548M [00:12&lt;00:13, 18.4MB/s]
Downloading:  55%|#####4    | 299M/548M [00:12&lt;00:12, 19.9MB/s]
Downloading:  55%|#####4    | 301M/548M [00:12&lt;00:12, 20.1MB/s]
Downloading:  55%|#####5    | 303M/548M [00:12&lt;00:11, 21.3MB/s]
Downloading:  56%|#####5    | 306M/548M [00:12&lt;00:11, 21.0MB/s]
Downloading:  56%|#####6    | 308M/548M [00:13&lt;00:10, 22.0MB/s]
Downloading:  57%|#####6    | 310M/548M [00:13&lt;00:11, 21.1MB/s]
Downloading:  57%|#####7    | 313M/548M [00:13&lt;00:10, 22.3MB/s]
Downloading:  58%|#####7    | 315M/548M [00:13&lt;00:10, 22.8MB/s]
Downloading:  58%|#####7    | 318M/548M [00:13&lt;00:10, 22.7MB/s]
Downloading:  58%|#####8    | 320M/548M [00:13&lt;00:10, 21.1MB/s]
Downloading:  59%|#####8    | 322M/548M [00:13&lt;00:10, 22.1MB/s]
Downloading:  59%|#####9    | 325M/548M [00:13&lt;00:10, 21.7MB/s]
Downloading:  60%|#####9    | 327M/548M [00:13&lt;00:10, 22.0MB/s]
Downloading:  60%|######    | 329M/548M [00:13&lt;00:10, 21.1MB/s]
Downloading:  60%|######    | 331M/548M [00:14&lt;00:10, 19.8MB/s]
Downloading:  61%|######    | 333M/548M [00:14&lt;00:11, 19.1MB/s]
Downloading:  61%|######1   | 335M/548M [00:14&lt;00:10, 19.5MB/s]
Downloading:  62%|######1   | 338M/548M [00:14&lt;00:10, 20.4MB/s]
Downloading:  62%|######1   | 340M/548M [00:14&lt;00:10, 20.0MB/s]
Downloading:  62%|######2   | 342M/548M [00:14&lt;00:10, 20.0MB/s]
Downloading:  63%|######2   | 344M/548M [00:14&lt;00:10, 20.0MB/s]
Downloading:  63%|######3   | 346M/548M [00:14&lt;00:09, 20.3MB/s]
Downloading:  64%|######3   | 348M/548M [00:14&lt;00:09, 22.0MB/s]
Downloading:  64%|######3   | 351M/548M [00:15&lt;00:08, 22.0MB/s]
Downloading:  64%|######4   | 353M/548M [00:15&lt;00:08, 22.8MB/s]
Downloading:  65%|######4   | 355M/548M [00:15&lt;00:08, 22.2MB/s]
Downloading:  65%|######5   | 358M/548M [00:15&lt;00:08, 22.5MB/s]
Downloading:  66%|######5   | 360M/548M [00:15&lt;00:08, 21.8MB/s]
Downloading:  66%|######6   | 363M/548M [00:15&lt;00:07, 23.5MB/s]
Downloading:  67%|######6   | 365M/548M [00:15&lt;00:08, 21.9MB/s]
Downloading:  67%|######7   | 367M/548M [00:15&lt;00:08, 22.2MB/s]
Downloading:  67%|######7   | 370M/548M [00:15&lt;00:08, 22.1MB/s]
Downloading:  68%|######7   | 372M/548M [00:16&lt;00:08, 21.4MB/s]
Downloading:  68%|######8   | 374M/548M [00:16&lt;00:08, 21.5MB/s]
Downloading:  69%|######8   | 377M/548M [00:16&lt;00:07, 23.2MB/s]
Downloading:  69%|######9   | 380M/548M [00:16&lt;00:06, 25.0MB/s]
Downloading:  70%|######9   | 382M/548M [00:16&lt;00:07, 22.3MB/s]
Downloading:  70%|#######   | 384M/548M [00:16&lt;00:07, 21.1MB/s]
Downloading:  71%|#######   | 387M/548M [00:16&lt;00:07, 21.4MB/s]
Downloading:  71%|#######1  | 389M/548M [00:16&lt;00:07, 22.6MB/s]
Downloading:  72%|#######1  | 392M/548M [00:16&lt;00:06, 24.0MB/s]
Downloading:  72%|#######2  | 395M/548M [00:16&lt;00:05, 27.0MB/s]
Downloading:  73%|#######2  | 398M/548M [00:17&lt;00:05, 26.4MB/s]
Downloading:  73%|#######3  | 402M/548M [00:17&lt;00:05, 28.6MB/s]
Downloading:  74%|#######3  | 405M/548M [00:17&lt;00:04, 29.9MB/s]
Downloading:  74%|#######4  | 408M/548M [00:17&lt;00:04, 29.6MB/s]
Downloading:  75%|#######4  | 411M/548M [00:17&lt;00:04, 30.0MB/s]
Downloading:  76%|#######5  | 415M/548M [00:17&lt;00:04, 32.1MB/s]
Downloading:  76%|#######6  | 419M/548M [00:17&lt;00:03, 35.6MB/s]
Downloading:  77%|#######7  | 424M/548M [00:17&lt;00:03, 38.4MB/s]
Downloading:  78%|#######8  | 428M/548M [00:17&lt;00:03, 39.5MB/s]
Downloading:  79%|#######8  | 432M/548M [00:17&lt;00:02, 40.3MB/s]
Downloading:  80%|#######9  | 437M/548M [00:18&lt;00:02, 41.5MB/s]
Downloading:  81%|########  | 441M/548M [00:18&lt;00:02, 42.9MB/s]
Downloading:  81%|########1 | 446M/548M [00:18&lt;00:02, 41.0MB/s]
Downloading:  82%|########2 | 450M/548M [00:18&lt;00:02, 40.9MB/s]
Downloading:  83%|########2 | 454M/548M [00:18&lt;00:02, 40.2MB/s]
Downloading:  84%|########3 | 458M/548M [00:18&lt;00:02, 35.3MB/s]
Downloading:  84%|########4 | 462M/548M [00:18&lt;00:02, 29.9MB/s]
Downloading:  85%|########4 | 465M/548M [00:18&lt;00:02, 28.5MB/s]
Downloading:  85%|########5 | 468M/548M [00:19&lt;00:03, 25.5MB/s]
Downloading:  86%|########5 | 470M/548M [00:19&lt;00:03, 23.5MB/s]
Downloading:  86%|########6 | 473M/548M [00:19&lt;00:03, 22.7MB/s]
Downloading:  87%|########6 | 475M/548M [00:19&lt;00:03, 22.3MB/s]
Downloading:  87%|########7 | 477M/548M [00:19&lt;00:03, 22.5MB/s]
Downloading:  88%|########7 | 480M/548M [00:19&lt;00:03, 21.8MB/s]
Downloading:  88%|########7 | 482M/548M [00:19&lt;00:03, 21.7MB/s]
Downloading:  88%|########8 | 484M/548M [00:19&lt;00:02, 22.5MB/s]
Downloading:  89%|########8 | 487M/548M [00:20&lt;00:02, 23.4MB/s]
Downloading:  89%|########9 | 490M/548M [00:20&lt;00:02, 24.0MB/s]
Downloading:  90%|########9 | 492M/548M [00:20&lt;00:02, 24.2MB/s]
Downloading:  90%|######### | 494M/548M [00:20&lt;00:03, 15.5MB/s]
Downloading:  91%|######### | 497M/548M [00:20&lt;00:03, 16.6MB/s]
Downloading:  91%|######### | 499M/548M [00:20&lt;00:02, 17.4MB/s]
Downloading:  91%|#########1| 501M/548M [00:20&lt;00:02, 18.1MB/s]
Downloading:  92%|#########1| 503M/548M [00:20&lt;00:02, 18.5MB/s]
Downloading:  92%|#########2| 505M/548M [00:21&lt;00:02, 19.5MB/s]
Downloading:  92%|#########2| 507M/548M [00:21&lt;00:02, 19.3MB/s]
Downloading:  93%|#########2| 509M/548M [00:21&lt;00:01, 20.2MB/s]
Downloading:  93%|#########3| 512M/548M [00:21&lt;00:01, 21.9MB/s]
Downloading:  94%|#########3| 515M/548M [00:21&lt;00:01, 23.6MB/s]
Downloading:  94%|#########4| 518M/548M [00:21&lt;00:01, 25.2MB/s]
Downloading:  95%|#########4| 520M/548M [00:21&lt;00:01, 26.2MB/s]
Downloading:  95%|#########5| 523M/548M [00:21&lt;00:00, 25.6MB/s]
Downloading:  96%|#########5| 526M/548M [00:21&lt;00:00, 25.6MB/s]
Downloading:  96%|#########6| 528M/548M [00:21&lt;00:00, 25.0MB/s]
Downloading:  97%|#########6| 531M/548M [00:22&lt;00:00, 25.3MB/s]
Downloading:  97%|#########7| 534M/548M [00:22&lt;00:00, 25.9MB/s]
Downloading:  98%|#########7| 537M/548M [00:22&lt;00:00, 27.3MB/s]
Downloading:  98%|#########8| 540M/548M [00:22&lt;00:00, 28.5MB/s]
Downloading:  99%|#########9| 543M/548M [00:22&lt;00:00, 30.4MB/s]
Downloading: 100%|##########| 548M/548M [00:22&lt;00:00, 24.3MB/s]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Move model to the appropriate device</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>torch_device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>model.to(torch_device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GPT2LMHeadModel(
  (transformer): GPT2Model(
    (wte): Embedding(50257, 768)
    (wpe): Embedding(1024, 768)
    (drop): Dropout(p=0.1, inplace=False)
    (h): ModuleList(
      (0): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (1): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (2): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (3): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (4): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (5): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (6): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (7): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (8): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (9): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (10): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
      (11): GPT2Block(
        (ln_1): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (attn): GPT2Attention(
          (c_attn): Conv1D()
          (c_proj): Conv1D()
          (attn_dropout): Dropout(p=0.1, inplace=False)
          (resid_dropout): Dropout(p=0.1, inplace=False)
        )
        (ln_2): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
        (mlp): GPT2MLP(
          (c_fc): Conv1D()
          (c_proj): Conv1D()
          (act): NewGELUActivation()
          (dropout): Dropout(p=0.1, inplace=False)
        )
      )
    )
    (ln_f): LayerNorm((768,), eps=1e-05, elementwise_affine=True)
  )
  (lm_head): Linear(in_features=768, out_features=50257, bias=False)
)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode the input text</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> tokenizer(<span class="st">"I enjoy walking with my cute dog"</span>, return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> inputs.to(torch_device)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get model output (logits)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> model(<span class="op">**</span>inputs)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    logits <span class="op">=</span> outputs.logits</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Select logits of the last token and get the top 10 tokens</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>last_token_logits <span class="op">=</span> logits[<span class="dv">0</span>, <span class="op">-</span><span class="dv">1</span>, :]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># the number of tokens</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(last_token_logits)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>50257</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert logits to probabilities</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>probs <span class="op">=</span> torch.softmax(last_token_logits, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the  probability distribution</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>plt.hist(probs, bins<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.xscale('log', base=10)</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.yscale('log', base=10)</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="614"></p>
</div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
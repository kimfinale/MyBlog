<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jong-Hoon Kim">
<meta name="dcterms.date" content="2023-10-12">

<title>Jong-Hoon Kim’s Blog - Regression with censorted data: POLYMOD data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jong-Hoon Kim’s Blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/kimfinale" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/tarzanthoreau" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Regression with censorted data: POLYMOD data</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">regression</div>
                <div class="quarto-category">contact</div>
                <div class="quarto-category">censor</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Jong-Hoon Kim </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 12, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="data-prep" class="level3">
<h3 class="anchored" data-anchor-id="data-prep">Data prep</h3>
<p>This post describes the process to analyze the POLYMOD data set, which can be downloaded from <a href="http://www.socialcontactdata.org/">Social Contact Data</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"C:/Users/jonghoon.kim/Documents/myblog/posts/nb-censored-regression/2008_Mossong_POLYMOD_participant_common.csv"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"C:/Users/jonghoon.kim/Documents/myblog/posts/nb-censored-regression/2008_Mossong_POLYMOD_contact_common.csv"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># count the number of contacts for each participant using part_id variable</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>d2 <span class="sc">|&gt;</span> </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(part_id) <span class="sc">|&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">contacts =</span> <span class="fu">n</span>()) <span class="ot">-&gt;</span> d_contacts</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(d, d_contacts, <span class="at">by=</span><span class="st">"part_id"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># add household information</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"C:/Users/jonghoon.kim/Documents/myblog/posts/nb-stan/2008_Mossong_POLYMOD_hh_common.csv"</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(d, d3, <span class="at">by=</span><span class="st">"hh_id"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># add day of week information</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>d4 <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"C:/Users/jonghoon.kim/Documents/myblog/posts/nb-stan/2008_Mossong_POLYMOD_sday.csv"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(d, d4, <span class="at">by=</span><span class="st">"part_id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="age-group" class="level3">
<h3 class="anchored" data-anchor-id="age-group">Age group</h3>
<p>Categorize the age group into different 10 age groups: 0-4, 5-9, 10-14, 15-19, 20 to 70 by 10 years and 70 and above</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dat</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>age_grp <span class="ot">&lt;-</span> <span class="dv">99</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d)) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(d<span class="sc">$</span>part_age[i])){</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(d<span class="sc">$</span>part_age[i] <span class="sc">&lt;</span> <span class="dv">5</span>){</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      d<span class="sc">$</span>age_grp[i] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (d<span class="sc">$</span>part_age[i] <span class="sc">&gt;=</span> <span class="dv">5</span> <span class="sc">&amp;&amp;</span> d<span class="sc">$</span>part_age[i] <span class="sc">&lt;</span> <span class="dv">20</span>){</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>){</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(d<span class="sc">$</span>part_age[i] <span class="sc">&gt;=</span> <span class="dv">5</span><span class="sc">*</span>j <span class="sc">&amp;&amp;</span> d<span class="sc">$</span>part_age[i] <span class="sc">&lt;</span> (<span class="dv">5</span><span class="sc">*</span>j<span class="sc">+</span><span class="dv">5</span>)){</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>          d<span class="sc">$</span>age_grp[i] <span class="ot">&lt;-</span> j</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (d<span class="sc">$</span>part_age[i] <span class="sc">&gt;=</span> <span class="dv">20</span> <span class="sc">&amp;&amp;</span> d<span class="sc">$</span>part_age[i] <span class="sc">&lt;</span> <span class="dv">70</span>){</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>){</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (d<span class="sc">$</span>part_age[i] <span class="sc">&gt;=</span> (<span class="dv">10</span><span class="sc">+</span><span class="dv">10</span><span class="sc">*</span>k) <span class="sc">&amp;&amp;</span> d<span class="sc">$</span>part_age[i] <span class="sc">&lt;</span> (<span class="dv">20</span><span class="sc">+</span><span class="dv">10</span><span class="sc">*</span>k)){</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>          d<span class="sc">$</span>age_grp[i] <span class="ot">&lt;-</span> k<span class="sc">+</span><span class="dv">3</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>      d<span class="sc">$</span>age_grp[i] <span class="ot">&lt;-</span> <span class="dv">9</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>hh_size_grp <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(d<span class="sc">$</span>hh_size <span class="sc">&gt;</span> <span class="dv">4</span>, <span class="dv">5</span>, <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(d<span class="sc">$</span>hh_size), d<span class="sc">$</span>hh_size, <span class="cn">NA</span>))</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co"># d$gender_grp &lt;- ifelse(d$part_gender == "F", "F", </span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co">#                        ifelse(d$part_gender == "M", "M", NA))</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> d</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>age_grp <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(dat<span class="sc">$</span>age_grp)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>hh_size_grp <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(dat<span class="sc">$</span>hh_size_grp)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>gender <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(dat<span class="sc">$</span>part_gender)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>dayofweek <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(dat<span class="sc">$</span>dayofweek)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="weighting" class="level3">
<h3 class="anchored" data-anchor-id="weighting">Weighting</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># hh &lt;- fread("posts/nb-stan/2008_Mossong_POLYMOD_hh_common.csv")</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># d3 &lt;- left_join(d2, hh, by="hh_id") </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # match by country, household size, age group</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># library(readxl)</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Determining a row and a column is simply based on the way it is imported  rio::import_list("posts/nb-stan/sampling_weight.xlsx")</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dat</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>age_row <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d)) {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  ag <span class="ot">&lt;-</span> d<span class="sc">$</span>part_age[i]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(ag)){</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (ag <span class="sc">&gt;=</span> (j<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">5</span> <span class="sc">&amp;</span> ag <span class="sc">&lt;</span> (j<span class="dv">-1</span>)<span class="sc">*</span><span class="dv">5</span><span class="sc">+</span><span class="dv">5</span>) {</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        d<span class="sc">$</span>age_row[i] <span class="ot">&lt;-</span> j</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (ag <span class="sc">&gt;=</span> <span class="dv">70</span>) {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        d<span class="sc">$</span>age_row[i] <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{}</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>hh_col <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d)) {</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  hs <span class="ot">&lt;-</span> d<span class="sc">$</span>hh_size[i]</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(hs)){</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) {</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (hs <span class="sc">==</span> j) {</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        d<span class="sc">$</span>hh_col[i] <span class="ot">&lt;-</span> j</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="cf">if</span> (hs <span class="sc">&gt;</span> <span class="dv">4</span>) {</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        d<span class="sc">$</span>hh_col[i] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>{}</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>wt <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>wlist <span class="ot">&lt;-</span> rio<span class="sc">::</span><span class="fu">import_list</span>(<span class="st">"C:/Users/jonghoon.kim/Documents/myblog/posts/nb-stan/sampling_weight.xlsx"</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>cnames <span class="ot">&lt;-</span> <span class="fu">names</span>(wlist)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cnames)) {</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  wtable <span class="ot">&lt;-</span> wlist[[i]]</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  w1 <span class="ot">&lt;-</span> wtable[wtable<span class="sc">$</span><span class="st">`</span><span class="at">Household size</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Ratio C/S"</span>,] <span class="co"># sampling weight</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  W <span class="ot">&lt;-</span> w1[<span class="sc">!</span><span class="fu">is.na</span>(w1<span class="sc">$</span><span class="st">`</span><span class="at">Household size</span><span class="st">`</span>),] <span class="co"># remove the first row</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># View(W)</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d)){</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(d<span class="sc">$</span>country[j] <span class="sc">==</span> cnames[i]) {</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>      d<span class="sc">$</span>wt[j] <span class="ot">&lt;-</span> W[d<span class="sc">$</span>age_row[j], d<span class="sc">$</span>hh_col[j]<span class="sc">+</span><span class="dv">2</span>]</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="co"># grep("-", as.character(d$wt), value = T)</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="co"># hist(as.numeric(d$wt))</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> d</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>wt <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(dat<span class="sc">$</span>wt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-for-fitting-only-complete-cases" class="level3">
<h3 class="anchored" data-anchor-id="data-for-fitting-only-complete-cases">data for fitting only complete cases</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dat_ <span class="ot">&lt;-</span> dat</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> dat[<span class="fu">complete.cases</span>(dat),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="negbin-regression-no-censoring-and-no-weighting" class="level3">
<h3 class="anchored" data-anchor-id="negbin-regression-no-censoring-and-no-weighting">NegBin regression: no censoring and no weighting</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(contacts <span class="sc">~</span> age_grp, <span class="at">data =</span> dat)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = contacts ~ age_grp, data = dat, init.theta = 2.349538851, 
    link = log)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.33297    0.02847  81.959  &lt; 2e-16 ***
age_grp1     0.34973    0.03963   8.826  &lt; 2e-16 ***
age_grp2     0.57379    0.03861  14.862  &lt; 2e-16 ***
age_grp3     0.53545    0.03908  13.702  &lt; 2e-16 ***
age_grp4     0.28592    0.03733   7.660 1.86e-14 ***
age_grp5     0.31980    0.03780   8.460  &lt; 2e-16 ***
age_grp6     0.29453    0.03707   7.946 1.93e-15 ***
age_grp7     0.18429    0.03716   4.959 7.09e-07 ***
age_grp8    -0.09048    0.03958  -2.286   0.0223 *  
age_grp9    -0.38437    0.05435  -7.072 1.53e-12 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(2.3495) family taken to be 1)

    Null deviance: 8082.4  on 7068  degrees of freedom
Residual deviance: 7381.8  on 7059  degrees of freedom
AIC: 49343

Number of Fisher Scoring iterations: 1

              Theta:  2.3495 
          Std. Err.:  0.0452 

 2 x log-likelihood:  -49321.1310 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(m1<span class="sc">$</span>coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    age_grp1    age_grp2    age_grp3    age_grp4    age_grp5 
 10.3085271   1.4186911   1.7749820   1.7082181   1.3309824   1.3768472 
   age_grp6    age_grp7    age_grp8    age_grp9 
  1.3424987   1.2023627   0.9134947   0.6808798 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(contacts <span class="sc">~</span> age_grp <span class="sc">+</span> gender, <span class="at">data =</span> dat)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = contacts ~ age_grp + gender, data = dat, init.theta = 2.349707617, 
    link = log)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.17344    0.22777   9.542  &lt; 2e-16 ***
age_grp1     0.34959    0.03963   8.822  &lt; 2e-16 ***
age_grp2     0.57371    0.03861  14.858  &lt; 2e-16 ***
age_grp3     0.53633    0.03908  13.724  &lt; 2e-16 ***
age_grp4     0.28630    0.03733   7.670 1.72e-14 ***
age_grp5     0.32009    0.03781   8.466  &lt; 2e-16 ***
age_grp6     0.29474    0.03708   7.949 1.88e-15 ***
age_grp7     0.18458    0.03717   4.966 6.83e-07 ***
age_grp8    -0.09034    0.03958  -2.282   0.0225 *  
age_grp9    -0.38435    0.05436  -7.071 1.54e-12 ***
genderF      0.15734    0.22647   0.695   0.4872    
genderM      0.16193    0.22650   0.715   0.4746    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(2.3497) family taken to be 1)

    Null deviance: 8082.9  on 7068  degrees of freedom
Residual deviance: 7381.7  on 7057  degrees of freedom
AIC: 49347

Number of Fisher Scoring iterations: 1

              Theta:  2.3497 
          Std. Err.:  0.0452 

 2 x log-likelihood:  -49320.5770 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(m2<span class="sc">$</span>coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    age_grp1    age_grp2    age_grp3    age_grp4    age_grp5 
  8.7884482   1.4184916   1.7748444   1.7097191   1.3314962   1.3772500 
   age_grp6    age_grp7    age_grp8    age_grp9     genderF     genderM 
  1.3427729   1.2027150   0.9136204   0.6808923   1.1703919   1.1757819 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(contacts <span class="sc">~</span> age_grp <span class="sc">+</span> gender <span class="sc">+</span> hh_size_grp , <span class="at">data =</span> dat)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = contacts ~ age_grp + gender, data = dat, init.theta = 2.349707617, 
    link = log)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.17344    0.22777   9.542  &lt; 2e-16 ***
age_grp1     0.34959    0.03963   8.822  &lt; 2e-16 ***
age_grp2     0.57371    0.03861  14.858  &lt; 2e-16 ***
age_grp3     0.53633    0.03908  13.724  &lt; 2e-16 ***
age_grp4     0.28630    0.03733   7.670 1.72e-14 ***
age_grp5     0.32009    0.03781   8.466  &lt; 2e-16 ***
age_grp6     0.29474    0.03708   7.949 1.88e-15 ***
age_grp7     0.18458    0.03717   4.966 6.83e-07 ***
age_grp8    -0.09034    0.03958  -2.282   0.0225 *  
age_grp9    -0.38435    0.05436  -7.071 1.54e-12 ***
genderF      0.15734    0.22647   0.695   0.4872    
genderM      0.16193    0.22650   0.715   0.4746    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(2.3497) family taken to be 1)

    Null deviance: 8082.9  on 7068  degrees of freedom
Residual deviance: 7381.7  on 7057  degrees of freedom
AIC: 49347

Number of Fisher Scoring iterations: 1

              Theta:  2.3497 
          Std. Err.:  0.0452 

 2 x log-likelihood:  -49320.5770 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(m2<span class="sc">$</span>coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    age_grp1    age_grp2    age_grp3    age_grp4    age_grp5 
  8.7884482   1.4184916   1.7748444   1.7097191   1.3314962   1.3772500 
   age_grp6    age_grp7    age_grp8    age_grp9     genderF     genderM 
  1.3427729   1.2027150   0.9136204   0.6808923   1.1703919   1.1757819 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>m4 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(contacts <span class="sc">~</span> age_grp <span class="sc">+</span> gender <span class="sc">+</span> hh_size_grp <span class="sc">+</span> country, <span class="at">data =</span> dat)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(m4)</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(m4<span class="sc">$</span>coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)     age_grp1     age_grp2     age_grp3     age_grp4     age_grp5 
   7.9783529    1.3826990    1.6788360    1.6795779    1.4291836    1.4218836 
    age_grp6     age_grp7     age_grp8     age_grp9      genderF      genderM 
   1.3794212    1.2970777    1.0517192    0.8024462    0.9246153    0.9178280 
hh_size_grp2 hh_size_grp3 hh_size_grp4 hh_size_grp5    countryDE    countryFI 
   1.1028791    1.1305982    1.2716075    1.3868936    0.7150799    0.9508057 
   countryGB    countryIT    countryLU    countryNL    countryPL 
   0.9813781    1.6313411    1.4373405    1.2477011    1.3254063 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>m5 <span class="ot">&lt;-</span> <span class="fu">glm.nb</span>(contacts <span class="sc">~</span> age_grp <span class="sc">+</span> gender <span class="sc">+</span> hh_size_grp <span class="sc">+</span> country <span class="sc">+</span> dayofweek, <span class="at">data =</span> dat)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># summary(m4)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(m5<span class="sc">$</span>coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)     age_grp1     age_grp2     age_grp3     age_grp4     age_grp5 
   6.1164006    1.3774273    1.6712925    1.6697736    1.4329588    1.4093123 
    age_grp6     age_grp7     age_grp8     age_grp9      genderF      genderM 
   1.3686718    1.2879141    1.0492799    0.8092407    0.9324001    0.9251257 
hh_size_grp2 hh_size_grp3 hh_size_grp4 hh_size_grp5    countryDE    countryFI 
   1.1033402    1.1244116    1.2651689    1.3816597    0.7081939    0.9473682 
   countryGB    countryIT    countryLU    countryNL    countryPL   dayofweek1 
   0.9772421    1.6303023    1.4052212    1.2451789    1.3256406    1.3211173 
  dayofweek2   dayofweek3   dayofweek4   dayofweek5   dayofweek6 
   1.3993730    1.3886852    1.3856028    1.4418376    1.1546267 </code></pre>
</div>
</div>
</section>
<section id="take-censoring-into-account" class="level3">
<h3 class="anchored" data-anchor-id="take-censoring-into-account">Take censoring into account</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> m5</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">model.matrix</span>(m)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ini = c(coef(m1), log_theta = log(summary(m1)$theta))</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>init <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">coef</span>(m), <span class="at">size=</span><span class="fu">summary</span>(m)<span class="sc">$</span>theta)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>negll_censor <span class="ot">&lt;-</span> <span class="cf">function</span>(par, y, X, <span class="at">ul=</span><span class="dv">400</span>) {</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># parameters</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  size <span class="ot">=</span> par[<span class="fu">length</span>(par)] </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">=</span> par[<span class="sc">-</span><span class="fu">length</span>(par)]</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create indicator depending on chosen limit</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  indicator <span class="ot">=</span> y <span class="sc">&lt;</span> ul</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># linear predictor</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> <span class="fu">exp</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># log likelihood</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  ll <span class="ot">=</span> <span class="fu">sum</span>(indicator <span class="sc">*</span> <span class="fu">dnbinom</span>(y, <span class="at">mu=</span>mu, <span class="at">size=</span>size, <span class="at">log=</span>T) <span class="sc">+</span> </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>             (<span class="dv">1</span><span class="sc">-</span>indicator) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pnbinom</span>(ul, <span class="at">mu=</span>mu, <span class="at">size=</span>size, <span class="at">lower=</span><span class="dv">0</span>)), <span class="at">na.rm=</span>T)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="sc">-</span>ll)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par=</span>init, </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>            negll_censor,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> dat<span class="sc">$</span>contacts,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">X =</span> X,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul =</span> <span class="dv">100</span>,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">method =</span> <span class="st">"Nelder-Mead"</span>,</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit=</span><span class="fl">1e3</span>, <span class="at">reltol=</span><span class="fl">1e-10</span>))</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(m))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)     age_grp1     age_grp2     age_grp3     age_grp4     age_grp5 
   6.1164006    1.3774273    1.6712925    1.6697736    1.4329588    1.4093123 
    age_grp6     age_grp7     age_grp8     age_grp9      genderF      genderM 
   1.3686718    1.2879141    1.0492799    0.8092407    0.9324001    0.9251257 
hh_size_grp2 hh_size_grp3 hh_size_grp4 hh_size_grp5    countryDE    countryFI 
   1.1033402    1.1244116    1.2651689    1.3816597    0.7081939    0.9473682 
   countryGB    countryIT    countryLU    countryNL    countryPL   dayofweek1 
   0.9772421    1.6303023    1.4052212    1.2451789    1.3256406    1.3211173 
  dayofweek2   dayofweek3   dayofweek4   dayofweek5   dayofweek6 
   1.3993730    1.3886852    1.3856028    1.4418376    1.1546267 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(fit<span class="sc">$</span>par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)     age_grp1     age_grp2     age_grp3     age_grp4     age_grp5 
   6.1164006    1.3774273    1.6712925    1.6697736    1.4329588    1.4093123 
    age_grp6     age_grp7     age_grp8     age_grp9      genderF      genderM 
   1.3686718    1.2879141    1.0492799    0.8092407    0.9324001    0.9251257 
hh_size_grp2 hh_size_grp3 hh_size_grp4 hh_size_grp5    countryDE    countryFI 
   1.1033402    1.1244116    1.2651689    1.3816597    0.7081939    0.9473682 
   countryGB    countryIT    countryLU    countryNL    countryPL   dayofweek1 
   0.9772421    1.6303023    1.4052212    1.2451789    1.3256406    1.3211173 
  dayofweek2   dayofweek3   dayofweek4   dayofweek5   dayofweek6         size 
   1.3993730    1.3886852    1.3856028    1.4418376    1.1546267   20.7585935 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par=</span>init, </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>            negll_censor,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> dat<span class="sc">$</span>contacts,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">X =</span> X,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul =</span> <span class="dv">29</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">method =</span> <span class="st">"Nelder-Mead"</span>,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit=</span><span class="fl">1e3</span>, <span class="at">reltol=</span><span class="fl">1e-10</span>))</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>fit1<span class="sc">$</span>par</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)     age_grp1     age_grp2     age_grp3     age_grp4     age_grp5 
  1.55650171   0.26327129   0.35056064   0.40212335   0.29412063   0.29883071 
    age_grp6     age_grp7     age_grp8     age_grp9      genderF      genderM 
  0.26734320   0.25083388   0.07239037  -0.10357844  -0.01523367  -0.01901654 
hh_size_grp2 hh_size_grp3 hh_size_grp4 hh_size_grp5    countryDE    countryFI 
  0.16833922   0.21734592   0.32287273   0.35571366  -0.24600748   0.05530841 
   countryGB    countryIT    countryLU    countryNL    countryPL   dayofweek1 
  0.06276664   0.33895987   0.22789886   0.18352321   0.20689205   0.28371164 
  dayofweek2   dayofweek3   dayofweek4   dayofweek5   dayofweek6         size 
  0.33680996   0.30048954   0.32608935   0.33103190   0.20037492   4.44495113 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(m))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)     age_grp1     age_grp2     age_grp3     age_grp4     age_grp5 
   6.1164006    1.3774273    1.6712925    1.6697736    1.4329588    1.4093123 
    age_grp6     age_grp7     age_grp8     age_grp9      genderF      genderM 
   1.3686718    1.2879141    1.0492799    0.8092407    0.9324001    0.9251257 
hh_size_grp2 hh_size_grp3 hh_size_grp4 hh_size_grp5    countryDE    countryFI 
   1.1033402    1.1244116    1.2651689    1.3816597    0.7081939    0.9473682 
   countryGB    countryIT    countryLU    countryNL    countryPL   dayofweek1 
   0.9772421    1.6303023    1.4052212    1.2451789    1.3256406    1.3211173 
  dayofweek2   dayofweek3   dayofweek4   dayofweek5   dayofweek6 
   1.3993730    1.3886852    1.3856028    1.4418376    1.1546267 </code></pre>
</div>
</div>
<p>Censoring &amp; Weighting</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> m2</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="fu">model.matrix</span>(m)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ini = c(coef(m1), log_theta = log(summary(m1)$theta))</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>init <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">coef</span>(m), <span class="at">size=</span><span class="fu">summary</span>(m)<span class="sc">$</span>theta)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>negll_censor_weight <span class="ot">&lt;-</span> <span class="cf">function</span>(par, y, X, wt, <span class="at">ul=</span><span class="dv">400</span>) {</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># parameters</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  size <span class="ot">=</span> par[<span class="fu">length</span>(par)] </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">=</span> par[<span class="sc">-</span><span class="fu">length</span>(par)]</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create indicator depending on chosen limit</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  indicator <span class="ot">=</span> y <span class="sc">&lt;</span> ul</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># linear predictor</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  mu <span class="ot">=</span> <span class="fu">exp</span>(X <span class="sc">%*%</span> beta)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># log likelihood</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  ll <span class="ot">=</span> <span class="fu">sum</span>(wt<span class="sc">*</span>(indicator <span class="sc">*</span> <span class="fu">dnbinom</span>(y, <span class="at">mu=</span>mu, <span class="at">size=</span>size, <span class="at">log=</span>T)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>indicator) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">pnbinom</span>(ul, <span class="at">mu=</span>mu, <span class="at">size=</span>size, <span class="at">lower=</span><span class="dv">0</span>))), <span class="at">na.rm=</span>T)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="sc">-</span>ll)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par=</span>init, </span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>            negll_censor_weight,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> dat<span class="sc">$</span>contacts,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">X =</span> X,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">wt =</span> <span class="dv">1</span>,</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul =</span> <span class="dv">100</span>,</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">method =</span> <span class="st">"Nelder-Mead"</span>,</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit=</span><span class="fl">1e3</span>, <span class="at">reltol=</span><span class="fl">1e-10</span>))</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">coef</span>(m))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    age_grp1    age_grp2    age_grp3    age_grp4    age_grp5 
  8.7884482   1.4184916   1.7748444   1.7097191   1.3314962   1.3772500 
   age_grp6    age_grp7    age_grp8    age_grp9     genderF     genderM 
  1.3427729   1.2027150   0.9136204   0.6808923   1.1703919   1.1757819 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(fit<span class="sc">$</span>par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    age_grp1    age_grp2    age_grp3    age_grp4    age_grp5 
  8.7884482   1.4184916   1.7748444   1.7097191   1.3314962   1.3772500 
   age_grp6    age_grp7    age_grp8    age_grp9     genderF     genderM 
  1.3427729   1.2027150   0.9136204   0.6808923   1.1703919   1.1757819 
       size 
 10.4825044 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par=</span>init, </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>            negll_censor_weight,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> dat<span class="sc">$</span>contacts,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">X =</span> X,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">wt =</span> dat<span class="sc">$</span>wt,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul =</span> <span class="dv">100</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">method =</span> <span class="st">"Nelder-Mead"</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit=</span><span class="fl">1e3</span>, <span class="at">reltol=</span><span class="fl">1e-10</span>))</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(fit1<span class="sc">$</span>par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    age_grp1    age_grp2    age_grp3    age_grp4    age_grp5 
  8.5527535   1.4173855   1.7640880   1.7215878   1.3900556   1.4072774 
   age_grp6    age_grp7    age_grp8    age_grp9     genderF     genderM 
  1.3571761   1.2292570   0.9496953   0.6885751   1.1954926   1.2172033 
       size 
 10.0819778 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fit2 <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="at">par=</span>init, </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>            negll_censor_weight,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> dat<span class="sc">$</span>contacts,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">X =</span> X,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">wt =</span> dat<span class="sc">$</span>wt,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">ul =</span> <span class="dv">29</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">method =</span> <span class="st">"Nelder-Mead"</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit=</span><span class="fl">1e3</span>, <span class="at">reltol=</span><span class="fl">1e-10</span>))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(fit2<span class="sc">$</span>par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    age_grp1    age_grp2    age_grp3    age_grp4    age_grp5 
 10.4571277   1.2726430   1.3611041   1.3721239   1.1848953   1.2582844 
   age_grp6    age_grp7    age_grp8    age_grp9     genderF     genderM 
  1.1844952   1.1156677   0.9145495   0.7512633   0.8753061   0.8994316 
       size 
 32.7962833 </code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
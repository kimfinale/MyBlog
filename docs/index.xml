<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Jong-Hoon Kim&#39;s Blog</title>
<link>https://kimfinale.github.io/myblog/index.html</link>
<atom:link href="https://kimfinale.github.io/myblog/index.xml" rel="self" type="application/rss+xml"/>
<description>Jong-Hoon Kim&#39;s Blog</description>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Mon, 27 Nov 2023 15:00:00 GMT</lastBuildDate>
<item>
  <title>SIR model in Stan: Euler method</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/index.html</link>
  <description><![CDATA[ 




<section id="sir-model-in-stan" class="level3">
<h3 class="anchored" data-anchor-id="sir-model-in-stan">SIR model in Stan</h3>
<p>I developed a SIR model and solved it an Euler method and generated a fake data as a sequence of noisy observation of daily incidence. I could have used the ODE solving routine available in Stan as in my previous <a href="https://www.jonghoonk.com/posts/ode-in-stan/">post</a>. However, an SIR model solved via the Euler method can be extended mor easily (e.g., stochatic model). I also suspect it would be easier to combine with the other statistical modeling techinques (e.g., hierarchical model), which I am going to post later.</p>
<section id="simulate-the-data" class="level4">
<h4 class="anchored" data-anchor-id="simulate-the-data">Simulate the data</h4>
<p>Generate <img src="https://latex.codecogs.com/png.latex?y_%7B1:N%7D"> as a sequence of noisy observations of a daily incidence. Almost the same Stan model is used twice: once to create fake data and the second time to estimate parameters via HMC.</p>
</section>
<section id="stan-model-to-create-fake-data" class="level4">
<h4 class="anchored" data-anchor-id="stan-model-to-create-fake-data">Stan model to create fake data</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">stan_code_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb1-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; N; // length of the data</span></span>
<span id="cb1-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; iter_per_day;</span></span>
<span id="cb1-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real dt;</span></span>
<span id="cb1-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; S0;</span></span>
<span id="cb1-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; I0;</span></span>
<span id="cb1-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; R0;</span></span>
<span id="cb1-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; CI0;</span></span>
<span id="cb1-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; phi;</span></span>
<span id="cb1-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; gamma;</span></span>
<span id="cb1-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; beta;</span></span>
<span id="cb1-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-18"></span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb1-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N] daily_inf;</span></span>
<span id="cb1-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] S;</span></span>
<span id="cb1-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] I;</span></span>
<span id="cb1-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] R;</span></span>
<span id="cb1-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] CI;</span></span>
<span id="cb1-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb1-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; st; // susceptible at time t</span></span>
<span id="cb1-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; it;</span></span>
<span id="cb1-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; rt;</span></span>
<span id="cb1-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; cit;  // cumulative infections at time t</span></span>
<span id="cb1-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n; // total population size</span></span>
<span id="cb1-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n_si; // number moving from S to I</span></span>
<span id="cb1-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n_ir; // number moving from I to R</span></span>
<span id="cb1-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb1-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  S[1] = S0;</span></span>
<span id="cb1-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  I[1] = I0;</span></span>
<span id="cb1-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  R[1] = R0;</span></span>
<span id="cb1-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  CI[1] = CI0;</span></span>
<span id="cb1-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb1-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 2:(N+1)) {</span></span>
<span id="cb1-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    st = S[i-1];</span></span>
<span id="cb1-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    it = I[i-1];</span></span>
<span id="cb1-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    rt = R[i-1];</span></span>
<span id="cb1-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    cit = CI[i-1];</span></span>
<span id="cb1-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (j in 1:iter_per_day) {</span></span>
<span id="cb1-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n = st + it + rt;</span></span>
<span id="cb1-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n_si = dt * beta * st * it / n;</span></span>
<span id="cb1-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n_ir = dt * gamma * it;</span></span>
<span id="cb1-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      st = st - n_si;</span></span>
<span id="cb1-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      it = it + n_si - n_ir;</span></span>
<span id="cb1-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      rt = rt + n_ir;</span></span>
<span id="cb1-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      cit = cit + n_si;</span></span>
<span id="cb1-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb1-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    S[i] = st;</span></span>
<span id="cb1-55"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    I[i] = it;</span></span>
<span id="cb1-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    R[i] = rt;</span></span>
<span id="cb1-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    CI[i] = cit;</span></span>
<span id="cb1-58"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb1-59"></span>
<span id="cb1-60"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 2:(N+1)) {</span></span>
<span id="cb1-61"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    daily_inf[i-1] = CI[i] - CI[i-1];</span></span>
<span id="cb1-62"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb1-63"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-64"></span>
<span id="cb1-65"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb1-66"></span>
<span id="cb1-67"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-68"></span>
<span id="cb1-69"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">generated quantities {</span></span>
<span id="cb1-70"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[N] int y_sim;</span></span>
<span id="cb1-71"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 1:N) {</span></span>
<span id="cb1-72"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_sim[i] = neg_binomial_2_rng(daily_inf[i] + 1e-6, phi);</span></span>
<span id="cb1-73"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    //y_sim[i] = poisson_rng(daily_inf[i] + 1e-6);</span></span>
<span id="cb1-74"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb1-75"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-76"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div>
</div>
</section>
</section>
<section id="section" class="level1">
<h1></h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-4">mod_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_model</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model_code=</span>stan_code_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-5"></span>
<span id="cb2-6">N<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>31L </span>
<span id="cb2-7">S0<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">999</span></span>
<span id="cb2-8">I0<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-9">dt<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb2-10"></span>
<span id="cb2-11">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span>N,</span>
<span id="cb2-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S0=</span>S0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I0=</span>I0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">CI0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_per_day=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>dt),</span>
<span id="cb2-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamma=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dt=</span>dt)</span>
<span id="cb2-14"></span>
<span id="cb2-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb2-16"></span>
<span id="cb2-17">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sampling</span>(mod_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data,</span>
<span id="cb2-18">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,</span>
<span id="cb2-19">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb2-20">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb2-21">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">algorithm =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fixed_param"</span>)</span>
<span id="cb2-22"></span>
<span id="cb2-23">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(fit)</span>
<span id="cb2-24">y_sim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> df[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^y_sim.*"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(df))]</span>
<span id="cb2-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_sim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]))</span>
<span id="cb2-26"></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># saveRDS(y_sim, "stan_sir_daily_inc_NB.rds")</span></span></code></pre></div>
</div>
<section id="stan-model-to-estimate-parameters" class="level3">
<h3 class="anchored" data-anchor-id="stan-model-to-estimate-parameters">Stan model to estimate parameters</h3>
<p>Note that there are two parameters in the parameters block</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">stan_code_est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb3-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; N;</span></span>
<span id="cb3-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; iter_per_day;</span></span>
<span id="cb3-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real dt;</span></span>
<span id="cb3-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; y[N];</span></span>
<span id="cb3-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; S0;</span></span>
<span id="cb3-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; I0;</span></span>
<span id="cb3-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; R0;</span></span>
<span id="cb3-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; CI0;</span></span>
<span id="cb3-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; phi;</span></span>
<span id="cb3-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; r;</span></span>
<span id="cb3-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb3-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; gamma;</span></span>
<span id="cb3-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; beta;</span></span>
<span id="cb3-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-19"></span>
<span id="cb3-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb3-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N] daily_inf;</span></span>
<span id="cb3-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] S;</span></span>
<span id="cb3-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] I;</span></span>
<span id="cb3-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] R;</span></span>
<span id="cb3-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] CI;</span></span>
<span id="cb3-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb3-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; st; // susceptible at time t</span></span>
<span id="cb3-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; it;</span></span>
<span id="cb3-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; rt;</span></span>
<span id="cb3-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; cit;  // cumulative infections at time t</span></span>
<span id="cb3-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n; // total population size</span></span>
<span id="cb3-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n_si; // number moving from S to I</span></span>
<span id="cb3-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n_ir; // number moving from I to R</span></span>
<span id="cb3-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb3-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  S[1] = S0;</span></span>
<span id="cb3-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  I[1] = I0;</span></span>
<span id="cb3-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  R[1] = R0;</span></span>
<span id="cb3-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  CI[1] = CI0;</span></span>
<span id="cb3-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb3-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 2:(N+1)) {</span></span>
<span id="cb3-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    st = S[i-1];</span></span>
<span id="cb3-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    it = I[i-1];</span></span>
<span id="cb3-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    rt = R[i-1];</span></span>
<span id="cb3-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    cit = CI[i-1];</span></span>
<span id="cb3-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (j in 1:iter_per_day) {</span></span>
<span id="cb3-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n = st + it + rt;</span></span>
<span id="cb3-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n_si = dt * beta * st * it / n;</span></span>
<span id="cb3-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n_ir = dt * gamma * it;</span></span>
<span id="cb3-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      st = st - n_si;</span></span>
<span id="cb3-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      it = it + n_si - n_ir;</span></span>
<span id="cb3-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      rt = rt + n_ir;</span></span>
<span id="cb3-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      cit = cit + n_si;</span></span>
<span id="cb3-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb3-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    S[i] = st;</span></span>
<span id="cb3-55"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    I[i] = it;</span></span>
<span id="cb3-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    R[i] = rt;</span></span>
<span id="cb3-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    CI[i] = cit;</span></span>
<span id="cb3-58"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb3-59"></span>
<span id="cb3-60"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 2:(N+1)) {</span></span>
<span id="cb3-61"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    daily_inf[i-1] = CI[i] - CI[i-1];</span></span>
<span id="cb3-62"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb3-63"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-64"></span>
<span id="cb3-65"></span>
<span id="cb3-66"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb3-67"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  beta ~ exponential(r);</span></span>
<span id="cb3-68"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  gamma ~ exponential(r);</span></span>
<span id="cb3-69"></span>
<span id="cb3-70"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  y ~ neg_binomial_2(daily_inf + 1e-6, phi);</span></span>
<span id="cb3-71"></span>
<span id="cb3-72"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}"</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-4"></span>
<span id="cb4-5">mod_est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_model</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model_code=</span>stan_code_est, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-6"></span>
<span id="cb4-7">y_sim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stan_sir_daily_inc_NB.rds"</span>)</span>
<span id="cb4-8"></span>
<span id="cb4-9">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(y_sim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb4-10">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(y), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S0=</span>S0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I0=</span>I0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">CI0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_per_day=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>dt), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dt=</span>dt)</span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb4-13"></span>
<span id="cb4-14">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sampling</span>(mod_est, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data,</span>
<span id="cb4-15">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>,</span>
<span id="cb4-16">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb4-17">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb4-18"></span>
<span id="cb4-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># saveRDS(fit, "stan_sir_daily_inc_NB_fit.rds")</span></span></code></pre></div>
</div>
<p>Trace plot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb5-2">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stan_sir_daily_inc_NB_fit.rds"</span>)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">traceplot</span>(fit, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="plot-the-results" class="level4">
<h4 class="anchored" data-anchor-id="plot-the-results">Plot the results</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb6-2">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb6-4"></span>
<span id="cb6-5">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(fit)</span>
<span id="cb6-6">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>)]</span>
<span id="cb6-7">dlong <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(d, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>),</span>
<span id="cb6-8">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"param"</span>)        </span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dlong$param &lt;- as.factor(dlong$param)</span></span>
<span id="cb6-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb6-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(dlong)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>value))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>param, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dlong, param <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dlong, param <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("sir_euler_stan_param.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>


</section>
</section>
</section>

 ]]></description>
  <category>R</category>
  <category>Stan</category>
  <category>Euler method</category>
  <category>SIR model</category>
  <guid>https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/index.html</guid>
  <pubDate>Mon, 27 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/sir_euler_stan_param.png" medium="image" type="image/png"/>
</item>
<item>
  <title>Estimating a time-to-event distribution in Stan</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/truncation-in-stan/index.html</link>
  <description><![CDATA[ 




<section id="stan-instead-of-optim" class="level3">
<h3 class="anchored" data-anchor-id="stan-instead-of-optim">Stan instead of optim</h3>
<p>As in the previous post, letâ€™s create a sample through a non-homogeneous process for the infection events and a Gamma distribution for the serial (or generation) interval.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb1-2">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-3">tmax <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># maximum time of first event</span></span>
<span id="cb1-4">r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.14</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># growth rate</span></span>
<span id="cb1-5">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"double"</span>, n)</span>
<span id="cb1-6">i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-7">ct <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate sample through a nonhomogeneous Poisson process</span></span>
<span id="cb1-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> (ct <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tmax) {</span>
<span id="cb1-10">  t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rexp</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ct))</span>
<span id="cb1-11">  ct <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ct <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> t</span>
<span id="cb1-12">  X[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ct</span>
<span id="cb1-13">  i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-14">}</span>
<span id="cb1-15">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X[X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters for the serial interval</span></span>
<span id="cb1-18">shape_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span></span>
<span id="cb1-19">scale_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span></span>
<span id="cb1-20"></span>
<span id="cb1-21">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>X)</span>
<span id="cb1-22">si <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(X), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>shape_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>scale_true)</span>
<span id="cb1-23">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> si</span>
<span id="cb1-24"></span>
<span id="cb1-25">tau <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># truncation time</span></span>
<span id="cb1-26">under_tau <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tau </span>
<span id="cb1-27">newdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[under_tau,]</span>
<span id="cb1-28"></span>
<span id="cb1-29">numerator_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, y, parms){</span>
<span id="cb1-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb1-31">}</span>
<span id="cb1-32"></span>
<span id="cb1-33">denominator_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(t, parms, tmax) {</span>
<span id="cb1-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>t)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(tmax<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>t, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb1-35">}</span>
<span id="cb1-36"></span>
<span id="cb1-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># single likelihood</span></span>
<span id="cb1-38">ll_right_trunc_exp_growth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms,x,y,tmax){</span>
<span id="cb1-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numerator_func</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>parms)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integrate</span>(denominator_func,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper=</span>tmax, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>parms, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>value)</span>
<span id="cb1-40">}</span>
<span id="cb1-41"></span>
<span id="cb1-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sum of negative log likelihoods</span></span>
<span id="cb1-43">nll_right_trunc_exp_growth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, X, Y, tmax){</span>
<span id="cb1-44">  sll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-45">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(X)) {</span>
<span id="cb1-46">    sll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sll <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ll_right_trunc_exp_growth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>parms,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>X[i],<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>Y[i],<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax)</span>
<span id="cb1-47">  }</span>
<span id="cb1-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>sll)</span>
<span id="cb1-49">}</span>
<span id="cb1-50"></span>
<span id="cb1-51">res_optim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb1-52">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll_right_trunc_exp_growth, </span>
<span id="cb1-53">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X, </span>
<span id="cb1-54">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y,</span>
<span id="cb1-55">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax,</span>
<span id="cb1-56">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb1-57">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span></code></pre></div>
</div>
<section id="stan-program" class="level4">
<h4 class="anchored" data-anchor-id="stan-program">Stan program</h4>
<p>Gamma distribution accounting for truncation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">stan_code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb2-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb2-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int&lt;lower = 0&gt; N; // number of records</span></span>
<span id="cb2-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    vector&lt;lower = 0&gt;[N] X;</span></span>
<span id="cb2-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    vector&lt;lower = 0&gt;[N] Y;</span></span>
<span id="cb2-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real tau;</span></span>
<span id="cb2-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb2-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real shape;</span></span>
<span id="cb2-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real scale;</span></span>
<span id="cb2-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb2-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    shape ~ exponential(0.1);</span></span>
<span id="cb2-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    scale ~ exponential(0.1);</span></span>
<span id="cb2-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    target += gamma_lpdf(Y - X | shape, 1/scale) - gamma_lcdf(tau-X | shape, 1/scale);</span></span>
<span id="cb2-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}"</span>    </span></code></pre></div>
</div>
<p>Gamma distribution accounting for truncation and exponential growth of infections</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">stan_code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">functions {</span></span>
<span id="cb3-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real denominator_density(real x,</span></span>
<span id="cb3-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           real xc,                </span></span>
<span id="cb3-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           array[] real theta,     </span></span>
<span id="cb3-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           array[] real x_r,                        </span></span>
<span id="cb3-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           array[] int x_i){</span></span>
<span id="cb3-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real shape = theta[1];</span></span>
<span id="cb3-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real scale = theta[2];</span></span>
<span id="cb3-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb3-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    return exp(0.14 * x) * gamma_cdf(33 - x, shape, 1/scale);</span></span>
<span id="cb3-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb3-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb3-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int&lt;lower = 0&gt; N; // number of records</span></span>
<span id="cb3-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    vector&lt;lower = 0&gt;[N] X;</span></span>
<span id="cb3-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    vector&lt;lower = 0&gt;[N] Y;</span></span>
<span id="cb3-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real tau;</span></span>
<span id="cb3-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real r;</span></span>
<span id="cb3-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-21"></span>
<span id="cb3-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed data{     </span></span>
<span id="cb3-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[0] real x_r;</span></span>
<span id="cb3-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[0] int x_i;  </span></span>
<span id="cb3-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">} </span></span>
<span id="cb3-26"></span>
<span id="cb3-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb3-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real shape;</span></span>
<span id="cb3-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real scale;</span></span>
<span id="cb3-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-31"></span>
<span id="cb3-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb3-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] log_exp_r;</span></span>
<span id="cb3-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (n in 1:N)</span></span>
<span id="cb3-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    log_exp_r[n] = log(exp(r*X[n]));</span></span>
<span id="cb3-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-37"></span>
<span id="cb3-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb3-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    shape ~ exponential(0.1);</span></span>
<span id="cb3-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    scale ~ exponential(0.1);</span></span>
<span id="cb3-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb3-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (i in 1:N)</span></span>
<span id="cb3-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      target += log(exp(r*X[i])) + gamma_lpdf(Y[i] - X[i] | shape, 1/scale) -                          log(integrate_1d(denominator_density, 0, tau,</span></span>
<span id="cb3-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           {shape, scale}, x_r, x_i, 1e-2));</span></span>
<span id="cb3-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">     </span></span>
<span id="cb3-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}"</span></span></code></pre></div>
</div>
</section>
<section id="compile-and-sample" class="level4">
<h4 class="anchored" data-anchor-id="compile-and-sample">Compile and sample</h4>
<p><code>integrate_1d(denominator_density, 0, tau, {shape, scale}, x_r, x_i, 1e-3)</code> cause errors. Four of the two samplers generated samples if the rel_tol is increased to 1e-2 for <code>seed=42</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-4">mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_model</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model_code=</span>stan_code, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-5">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(newdf), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tau=</span>tau, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span>r)</span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># smp &lt;- sampling(object=mod, data=data, seed=33, chains=4, iter=2000)</span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># saveRDS(smp, "stan_trunc_smp_20231124.rds")</span></span></code></pre></div>
</div>
<p>Letâ€™s explore the posterior distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">smp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stan_trunc_smp_20231124.rds"</span>)</span>
<span id="cb5-2">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(smp)</span>
<span id="cb5-3">pr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)</span>
<span id="cb5-4">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(df[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>)],</span>
<span id="cb5-5">                           <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span>pr)))</span>
<span id="cb5-6"></span>
<span id="cb5-7">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>)</span>
<span id="cb5-8">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(shape_true, scale_true)</span>
<span id="cb5-9">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>optim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> res_optim<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par</span>
<span id="cb5-10">d</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           50%     2.5%    97.5%  name true    optim
shape 2.085903 1.760453 2.448298 shape  2.2 2.090817
scale 3.484215 2.680270 4.770225 scale  3.3 3.482427</code></pre>
</div>
</div>
<p>Letâ€™s plot the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb7-3">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>()</span>
<span id="cb7-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(d)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">2.5%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">97.5%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">50%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stan"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True value"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>optim, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Optim"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stan"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>,</span>
<span id="cb7-10">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True value"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Optim"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Median estimates with 95% CrI"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>),</span>
<span id="cb7-14">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(theta[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(theta[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>()</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/truncation-in-stan/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("right_trunc_stan.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>)]</span>
<span id="cb9-2">dlong <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(d, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>),</span>
<span id="cb9-3">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"param"</span>)        </span>
<span id="cb9-4">dlong<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(dlong<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param)</span>
<span id="cb9-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb9-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(dlong)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>value))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>param, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dlong, param <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span>shape_true), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dlong, param <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span>scale_true), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/truncation-in-stan/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>news</category>
  <category>code</category>
  <category>analysis</category>
  <guid>https://kimfinale.github.io/myblog/posts/truncation-in-stan/index.html</guid>
  <pubDate>Thu, 23 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/truncation-in-stan/right_trunc_stan.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Estimating a time-to-event distribution from right-truncated data</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/right-truncation2/index.html</link>
  <description><![CDATA[ 




<p><a href="https://pubmed.ncbi.nlm.nih.gov/34931911/">Seamen writes</a>: Data on time to an event are said to be right truncated if they come from a set of individuals who have been randomly sampled from a population using a sampling mechanism that selects only individuals who have experienced the event by a given time, called the truncation time.</p>
<p>The analysis of right-truncated data requires statistical methods that account for the fact that each of the sampled individuals must have experienced the final event by their truncation time.</p>
<p>Letâ€™s assume that we are interested in estimating the serial interval and let <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> denote the times of symptom onset of the infector and the infectee, with <img src="https://latex.codecogs.com/png.latex?0%5Cleq%20X%20%5Cleq%20Y">. Let <img src="https://latex.codecogs.com/png.latex?T=Y-X"> denote the serial interval. Let <img src="https://latex.codecogs.com/png.latex?f_T%5E%E2%88%97(t)"> and <img src="https://latex.codecogs.com/png.latex?F_T%5E%E2%88%97(t)"> denote, respectively, the probability density (or mass) function of <img src="https://latex.codecogs.com/png.latex?T"> and the distribution function of <img src="https://latex.codecogs.com/png.latex?T">. We obtain an i.i.d. sample, <img src="https://latex.codecogs.com/png.latex?(x_1,%20t_1),%20.%20.%20.%20,%20(x_n,%20t_n)">, from the probability distribution of <img src="https://latex.codecogs.com/png.latex?(X,%20T)"> given <img src="https://latex.codecogs.com/png.latex?X%20+%20T%20%E2%89%A4%20%5Ctau"> for some <img src="https://latex.codecogs.com/png.latex?%5Ctau%20%3E%200">.</p>
<p><img src="https://latex.codecogs.com/png.latex?f_%7BX,%20T%7D(x,t%7CX+T%20%5Cleq%20%5Ctau)%20=%20%5Cfrac%7Bf_X(x)%20f%5E*_T(t)I(x+t%20%5Cleq%20%5Ctau)%7D%7B%5Cint_0%5E%7B%5Ctau%7D%20f_X(x')%20F%5E*_T(%5Ctau-x')%5Ctext%7Bd%7Dx'%7D"> , where <img src="https://latex.codecogs.com/png.latex?f_X%20(x)"> denotes the conditional probability density (or mass) function of <img src="https://latex.codecogs.com/png.latex?X"> given <img src="https://latex.codecogs.com/png.latex?X%20%5Cleq%20%5Ctau">, and <img src="https://latex.codecogs.com/png.latex?I(%5Ccdot)"> denotes the indicator function. If <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?T"> are discrete, we shall assume, without loss of generality, that <img src="https://latex.codecogs.com/png.latex?%5Ctau"> is an integer. We should like to estimate <img src="https://latex.codecogs.com/png.latex?F%5E%E2%88%97_T(t)"></p>
<p>If we assume no truncation (i.e., <img src="https://latex.codecogs.com/png.latex?F%5E*_T(%5Ctau-x)=1~%20%5Cforall%20x">)</p>
<section id="during-an-initial-period-of-an-epidemic" class="level3">
<h3 class="anchored" data-anchor-id="during-an-initial-period-of-an-epidemic">During an initial period of an epidemic</h3>
<p><a href="https://pubmed.ncbi.nlm.nih.gov/34931911/">Seamen</a> provides two approaches to formulating a likelihood that can be applied during the initial period of an epidemic. The first approach is: <img src="https://latex.codecogs.com/png.latex?f_X%20(x;r)%20=%20%20%5Cfrac%7B%5Ctext%7Bexp%7D(rx)%7D%7B%5Cint_0%5E%7B%5Ctau%7D%5Ctext%7Bexp%7D(rs)ds%20%7D=%5Cfrac%7Br%5Ctext%7Bexp%7D(rx)%7D%7B%5Ctext%7Bexp%7D(r%5Ctau)%20-%201%20%7D%20%5Cpropto%20%5Ctext%7Bexp%7D(rx)">, and <img src="https://latex.codecogs.com/png.latex?T%20%5Csim%20%5Ctext%7BGamma%7D(%5Ctheta_1,%20%5Ctheta_2)">.</p>
</section>
<section id="experiment" class="level3">
<h3 class="anchored" data-anchor-id="experiment">Experiment</h3>
<p>Letâ€™s first create samples where infectees (<img src="https://latex.codecogs.com/png.latex?X">) are created through a non-homogeneous Poisson process where rate, <img src="https://latex.codecogs.com/png.latex?h">, is modeled as an exponential growth with a rate, <img src="https://latex.codecogs.com/png.latex?r">, (i.e., <img src="https://latex.codecogs.com/png.latex?h=%5Ctext%7Bexp%7D(rt)">.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb1-2">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-3">tmax <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># first events that happened only before time 30</span></span>
<span id="cb1-4">r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.14</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># growth rate</span></span>
<span id="cb1-5">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"double"</span>, n)</span>
<span id="cb1-6">i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-7">ct <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate sample through a nonhomogeneous Poisson process</span></span>
<span id="cb1-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> (ct <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tmax) {</span>
<span id="cb1-10">  t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rexp</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ct))</span>
<span id="cb1-11">  ct <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ct <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> t</span>
<span id="cb1-12">  X[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ct</span>
<span id="cb1-13">  i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-14">}</span>
<span id="cb1-15">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X[X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters for the serial interval</span></span>
<span id="cb1-18">shape_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span></span>
<span id="cb1-19">scale_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span></span>
<span id="cb1-20"></span>
<span id="cb1-21">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>X)</span>
<span id="cb1-22">si <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(X), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>shape_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>scale_true)</span>
<span id="cb1-23">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> si</span>
<span id="cb1-24"></span>
<span id="cb1-25">tmax <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># truncation time</span></span>
<span id="cb1-26">under_tmax <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tmax </span>
<span id="cb1-27">newdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[under_tmax,]</span>
<span id="cb1-28"></span>
<span id="cb1-29">nll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, X, Y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb1-30">res1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y,</span>
<span id="cb1-31">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb1-32">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span>
<span id="cb1-33"></span>
<span id="cb1-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span></span>
<span id="cb1-35">nll_right_trunc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, X, Y, tmax) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(Y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(tmax<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])))</span>
<span id="cb1-36"></span>
<span id="cb1-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the following would not work. why?</span></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># nll_right_trunc &lt;- function(parms, X, Y, tmax) -sum(log(dgamma(Y-X, shape=parms[[1]], scale=parms[[2]])/pgamma(tmax, shape=parms[[1]], scale=parms[[2]])))</span></span>
<span id="cb1-39"></span>
<span id="cb1-40">res2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb1-41">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll_right_trunc, </span>
<span id="cb1-42">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X, </span>
<span id="cb1-43">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y,</span>
<span id="cb1-44">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax,</span>
<span id="cb1-45">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb1-46">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span></code></pre></div>
</div>
</section>
<section id="exponential-growth-for-x" class="level3">
<h3 class="anchored" data-anchor-id="exponential-growth-for-x">Exponential growth for <img src="https://latex.codecogs.com/png.latex?X"></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">numerator_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, y, parms){</span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb2-3">}</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># using the full probability density function</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># numerator_func &lt;- function(x, y, parms){</span></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   exp(r*x)/(exp(r*tmax)-1)*dgamma(y-x, shape=parms[[1]], scale=parms[[2]])</span></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># }</span></span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># uniform distribution - same as the vanilla truncation assumption</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># numerator_func &lt;- function(x, y, parms){</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   dgamma(y-x, shape=parms[[1]], scale=parms[[2]])</span></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># }</span></span>
<span id="cb2-14"></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NB: x is not used in this formuation but is included as params to make consistent w/ other alternative formulations</span></span>
<span id="cb2-16">denominator_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(t, x, parms, tmax) {</span>
<span id="cb2-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>t)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(tmax<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>t, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb2-18">}</span>
<span id="cb2-19"></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the following would not give the correct answer. why?</span></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># denominator_func &lt;- function(t, x, parms, tmax) {</span></span>
<span id="cb2-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   exp(r*t)*pgamma(tmax-x-t, shape=parms[[1]], scale=parms[[2]])</span></span>
<span id="cb2-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># }</span></span>
<span id="cb2-24"></span>
<span id="cb2-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># same as the vanialla truncation model</span></span>
<span id="cb2-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># denominator_func &lt;- function(t, x, parms, tmax) {</span></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   dgamma(tmax-x-t, shape=parms[[1]], scale=parms[[2]])</span></span>
<span id="cb2-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># }</span></span>
<span id="cb2-29"></span>
<span id="cb2-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># single likelihood</span></span>
<span id="cb2-31">ll_right_trunc_exp_growth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms,x,y,tmax){</span>
<span id="cb2-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numerator_func</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>parms)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integrate</span>(denominator_func,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper=</span>tmax, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>parms, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>value)</span>
<span id="cb2-33">}</span>
<span id="cb2-34"></span>
<span id="cb2-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sum of negative log likelihoods</span></span>
<span id="cb2-36">nll_right_trunc_exp_growth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, X, Y, tmax){</span>
<span id="cb2-37">  sll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb2-38">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(X)) {</span>
<span id="cb2-39">    sll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sll <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ll_right_trunc_exp_growth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>parms,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>X[i],<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>Y[i],<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax)</span>
<span id="cb2-40">  }</span>
<span id="cb2-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>sll)</span>
<span id="cb2-42">}</span>
<span id="cb2-43"></span>
<span id="cb2-44">res3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb2-45">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll_right_trunc_exp_growth, </span>
<span id="cb2-46">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X, </span>
<span id="cb2-47">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y,</span>
<span id="cb2-48">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax,</span>
<span id="cb2-49">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb2-50">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span>
<span id="cb2-51"></span>
<span id="cb2-52">parmdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">true =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(shape_true, scale_true, shape_true<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>scale_true))</span>
<span id="cb2-53">parmdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>no_trunc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prod</span>(res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par))</span>
<span id="cb2-54">parmdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>trunc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prod</span>(res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par))</span>
<span id="cb2-55">parmdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>trunc_exp_growth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(res3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prod</span>(res3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par))</span>
<span id="cb2-56"></span>
<span id="cb2-57">parmdf</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  true no_trunc    trunc trunc_exp_growth
1 2.20 2.115872 1.932797         2.100084
2 3.30 2.273549 3.684688         3.427339
3 7.26 4.810538 7.121754         7.197701</code></pre>
</div>
</div>
<p>Parameter estimates based on the methods that account for right truncation and exponential growth appear to match better with the true values than the those based on the method that accounts only for right truncation.</p>
</section>
<section id="plot" class="level3">
<h3 class="anchored" data-anchor-id="plot">Plot</h3>
<p>Letâ€™s plot the distribution</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e5</span></span>
<span id="cb4-2">x0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>shape_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>scale_true)</span>
<span id="cb4-3">x1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb4-4">x2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb4-5">x3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb4-6"></span>
<span id="cb4-7">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No truncation"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Right truncated"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Right truncated, exp growth"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span>n), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(x0,x1,x2,x3))</span>
<span id="cb4-8"></span>
<span id="cb4-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb4-10">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>()</span>
<span id="cb4-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb4-12"></span>
<span id="cb4-13">df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>model))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, </span>
<span id="cb4-17">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/right-truncation2/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("right_trunc2.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>


</section>

 ]]></description>
  <category>right truncation</category>
  <category>exponential growth</category>
  <category>Poisson process</category>
  <guid>https://kimfinale.github.io/myblog/posts/right-truncation2/index.html</guid>
  <pubDate>Wed, 22 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/right-truncation2/right_trunc2.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Estimating serial interval: doubly interval-censored data</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/double-interval-censoring/index.html</link>
  <description><![CDATA[ 




<p>We start simple. Our task is to estimate parameters of a probability density function used to model the serial interval. Suppose dates of onsets of infectors, <img src="https://latex.codecogs.com/png.latex?A">, and infectees, <img src="https://latex.codecogs.com/png.latex?B">, are given as specific dates. Then the likelihood function for the serial interval may be written down as follows:<br>
<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D(X;%5Ctheta)%20=%20%5Cprod_%7Bi=1%7D%5E%7Bn%7D%20f_%7B%5Ctheta%7D(B_i%20-%20A_i)">, where <img src="https://latex.codecogs.com/png.latex?f"> is the probability density function for the serial interval with the unknown parameters, <img src="https://latex.codecogs.com/png.latex?%5Ctheta">.</p>
<p>Now suppose that the dates of symptom onset of the infectors are given as intervals. We can use the following argument also for the case where dates of symptom onset of the infectees are given as intervals. In this case, the above likelihood function may be modified as follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D(X;%5Ctheta)%20=%20%5Cprod_%7Bi=1%7D%5E%7Bn%7D%20%5Cint_%7BA%5EL_i%7D%5E%7BA%5ER_i%7D%20f_%7B%5Ctheta%7D(B_i-a)%20~%5Ctext%7Bd%7Da"> , where <img src="https://latex.codecogs.com/png.latex?A%5EL,%20A%5ER,%20B"> present the times for lower end and upper bound on the potential dates of symptom onset of the infector, and the symptom onset time of the infectee, respectively.</p>
<p>Now suppose that both the dates of onset of the infectors and infectees are given as intervals. This is so called the doubly interval-censored data discussed by <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.3659">Reich <em>et al</em> 2009</a>. The likelihood function may be given as follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D(X;%5Ctheta,%5Clambda)%20=%20%5Cprod_%7Bi=1%7D%5E%7Bn%7D%20%5Cint_%7BA%5EL_i%7D%5E%7BA%5ER_i%7D%20%5Cint_%7BB%5EL_i%7D%5E%7BB%5ER_i%7D%20h_%7B%5Clambda%7D(a)%20f_%7B%5Ctheta%7D(b-a)%20~%5Ctext%7Bd%7Db%20%5Ctext%7Bd%7Da"> , where <img src="https://latex.codecogs.com/png.latex?A%5EL,%20A%5ER,%20B%5EL,%20B%5ER"> present the times for left and right boundaires on the possible onset times of the infector, <img src="https://latex.codecogs.com/png.latex?A">, and the infectee, <img src="https://latex.codecogs.com/png.latex?B">, respectively. <img src="https://latex.codecogs.com/png.latex?h_%7B%5Clambda%7D(x)"> represents the probability density function for the time of symptom onset of the infector, which we assume follows a uniform distribution.</p>
<p>More detailed analyses of doubly interval-censored data were discussed by <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.3659">Reich <em>et al</em> 2009</a>. The same concept has recently been applied to estimation of serial interval of CVODI-19 by <a href="https://www.ijidonline.com/article/S1201-9712(20)30119-3/fulltext#supplementaryMaterial">Nishiura <em>et al</em>. 2020</a>.</p>
<p>In the following codes, we create the fake data set and add intervals such that the serial intervals may become shorter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb1-2">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb1-3">shape_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span></span>
<span id="cb1-4">scale_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">onset_infector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-7">onset_infectee <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> onset_infector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>shape_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>scale_true)</span>
<span id="cb1-8">nll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb1-9">res1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>onset_infectee <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> onset_infector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb1-10">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># singly interval-censored data</span></span>
<span id="cb1-13">tau <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-14">AL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> onset_infector </span>
<span id="cb1-15">AR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> onset_infector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tau <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this will lead to shorter serial interval</span></span>
<span id="cb1-16"></span>
<span id="cb1-17">nll_single_censor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, AL, AR, B){</span>
<span id="cb1-18">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>AR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])))</span>
<span id="cb1-19">}</span>
<span id="cb1-20"></span>
<span id="cb1-21">res2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll_single_censor, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">AL=</span>AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">AR=</span>AR, </span>
<span id="cb1-22">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">B=</span>onset_infectee, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb1-23">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># doubly interval-censored data</span></span>
<span id="cb1-26">BL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> onset_infectee <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tau <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this will lead to even shorter serial interval</span></span>
<span id="cb1-27">BR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> onset_infectee</span>
<span id="cb1-28"></span>
<span id="cb1-29">nll_double_censor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, AL, AR, BL, BR){</span>
<span id="cb1-30">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunif</span>(AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min=</span>AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max=</span>AR)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(BR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(BL<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>AR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]))))</span>
<span id="cb1-31">}</span>
<span id="cb1-32"></span>
<span id="cb1-33">res3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll_double_censor, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">AL=</span>AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">AR=</span>AR,</span>
<span id="cb1-34">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">BL=</span>BL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">BR=</span>BR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb1-35">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span>
<span id="cb1-36"></span>
<span id="cb1-37">x1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb1-38">x2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb1-39">x3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb1-40"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(x1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.1677  3.8165  6.4303  7.5411 10.3268 36.0535 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(x2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
 0.03203  1.37089  3.37988  4.70497  6.48863 38.89572 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(x3)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
 0.00001  0.36330  1.48009  2.92934  4.04038 46.12810 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No censoring"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Singly interval-censored"</span>,</span>
<span id="cb7-2">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Doubly interval-censored"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>),</span>
<span id="cb7-3">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(x1,x2, x3))</span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb7-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb7-7"></span>
<span id="cb7-8">df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>model))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, </span>
<span id="cb7-12">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/double-interval-censoring/index_files/figure-html/no_censoring-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("double_interval_censor.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>



 ]]></description>
  <category>R</category>
  <category>serial interval</category>
  <category>interval censoring</category>
  <guid>https://kimfinale.github.io/myblog/posts/double-interval-censoring/index.html</guid>
  <pubDate>Thu, 16 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/double-interval-censoring/double_interval_censor.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Estimating serial interval for a growing epidemic</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/right-truncation/index.html</link>
  <description><![CDATA[ 




<p>In this case, the above likelihood function may be modified as follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D(X;%5Ctheta)%20=%20%5Cprod_%7Bi=1%7D%5E%7Bn%7D%20f_%7B%5Ctheta%7D(B_i-A_i)"> , where <img src="https://latex.codecogs.com/png.latex?A%5EL,%20A%5ER,%20B"> present the times for lower end and upper bound on the potential dates of symptom onset of the infector, and the symptom onset time of the infectee, respectively.</p>
<p><img src="https://latex.codecogs.com/png.latex?f%5Et_%7B%5Ctheta%7D(B_i-A_i)%20=%20%5Cfrac%7Bf_%7B%5Ctheta%7D(B_i-A_i)%7D%7BF(T-A_i)%7D"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb1-2">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-3">shape_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span></span>
<span id="cb1-4">scale_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb1-7">si <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>shape_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>scale_true)</span>
<span id="cb1-8">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>B <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> si</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>B)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 57.03661</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>B)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.3967 13.9763 22.4103 22.4031 30.3811 57.0366 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">Tmax <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span></span>
<span id="cb5-2">under_Tmax <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>B <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> Tmax</span>
<span id="cb5-3"></span>
<span id="cb5-4">newdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[under_Tmax,]</span>
<span id="cb5-5"></span>
<span id="cb5-6">nll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, A, B) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb5-7">res1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">B=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>B,</span>
<span id="cb5-8">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb5-9">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span>
<span id="cb5-10">res1</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 2.366494 2.735134

$value
[1] 2389.103

$counts
function gradient 
     101       NA 

$convergence
[1] 0

$message
NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">nll_right_trunc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, A, B, Tmax) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(Tmax<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])))</span>
<span id="cb7-2"></span>
<span id="cb7-3">res2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb7-4">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll_right_trunc, </span>
<span id="cb7-5">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">A=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>A, </span>
<span id="cb7-6">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">B=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>B,</span>
<span id="cb7-7">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tmax=</span>Tmax,</span>
<span id="cb7-8">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb7-9">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span>
<span id="cb7-10">res2</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 2.230993 3.230118

$value
[1] 2317.955

$counts
function gradient 
     115       NA 

$convergence
[1] 0

$message
NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e5</span></span>
<span id="cb9-2">x1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb9-3">x2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb9-4"></span>
<span id="cb9-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(x1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
 0.01066  3.36629  5.58653  6.47582  8.62659 44.32536 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(x2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.0263  3.6574  6.1697  7.2078  9.6218 43.8174 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No truncation"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Right truncated"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span>n), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(x1,x2))</span>
<span id="cb13-2"></span>
<span id="cb13-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb13-4">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>()</span>
<span id="cb13-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb13-6"></span>
<span id="cb13-7">df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>model))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, </span>
<span id="cb13-11">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/right-truncation/index_files/figure-html/no_censoring-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("right_trunc.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>



 ]]></description>
  <category>R</category>
  <category>serial interval</category>
  <category>interval censoring</category>
  <guid>https://kimfinale.github.io/myblog/posts/right-truncation/index.html</guid>
  <pubDate>Thu, 16 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/right-truncation/right_trunc.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Estimating serial interval: interval cenoring</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/interval-censoring/index.html</link>
  <description><![CDATA[ 




<section id="vanilla-maximum-likelihood-estimation" class="level3">
<h3 class="anchored" data-anchor-id="vanilla-maximum-likelihood-estimation">Vanilla maximum likelihood estimation</h3>
<p>Suppose dates of onsets of infectors, <img src="https://latex.codecogs.com/png.latex?t%5E%7BA%7D">, and infectees, <img src="https://latex.codecogs.com/png.latex?t%5E%7BB%7D">, are given as specific dates. Then the likelihood function for the serial interval may be written down as follows:<br>
<img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D%20=%20%5Cprod_%7Bi=1%7D%5E%7Bn%7D%20f(t%5E%7BB%7D_i%20-%20t%5E%0A%7BA%7D_i)"> , where <img src="https://latex.codecogs.com/png.latex?f"> is a probability density function for the serial interval, which we assume follows a Gamma distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb1-2">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb1-3">shape_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span></span>
<span id="cb1-4">scale_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">onset_infector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span>n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-7">onset_infectee <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> onset_infector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>shape_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>scale_true)</span>
<span id="cb1-8">nll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb1-9">res1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>onset_infectee <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> onset_infector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb1-10">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span></code></pre></div>
</div>
</section>
<section id="mle-with-interval-censoring" class="level3">
<h3 class="anchored" data-anchor-id="mle-with-interval-censoring">MLE with interval censoring</h3>
<p>Now suppose that the dates of onset of the infectors are given as intervals. In this case, the above likelihood function may be modified as follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D%20=%20%5Cprod_%7Bi=1%7D%5E%7Bn%7D%20%5Cint_%7Bt%5E%7BA%7D_%7BLi%7D%7D%5E%7Bt%5E%7BA%7D_%7BRi%7D%7D%20g(%5Ctau)%20f(t%5E%7BB%7D_i-%5Ctau)%20~%5Ctext%7Bd%7D%5Ctau"> , where <img src="https://latex.codecogs.com/png.latex?t%5EA_L,%20t%5EA_R,%20t%5EB"> present the times for lower end and upper end of the interval for the time of onset of the infector, and the onset time of the infectee, respectively. <img src="https://latex.codecogs.com/png.latex?g(x)"> represents the probability density function for the time of symptom onset of the infector, which we assume follows a uniform distribution.</p>
<p>This is a simplified version of doubly interval-censored data analysis, which was discussed by <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.3659">Reich <em>et al</em> 2009</a>. The same concept has recently been applied to estimation of serial interval of CVODI-19 by <a href="https://www.ijidonline.com/article/S1201-9712(20)30119-3/fulltext#supplementaryMaterial">Nishiura <em>et al</em>. 2020</a>. I will cover the doubly interval-censored data in a future post.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb2-2">L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-3">R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>L <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this will lead to potentially shorter serial interval</span></span>
<span id="cb2-4">AL <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> onset_infector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> L</span>
<span id="cb2-5">AR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> onset_infector <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> R</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x</span></span>
<span id="cb2-8">nll_interval_censor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, AL, AR, t){</span>
<span id="cb2-9">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dunif</span>(AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min=</span>AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max=</span>AR)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>AR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]))))</span>
<span id="cb2-10">}</span>
<span id="cb2-11"></span>
<span id="cb2-12">res2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll_interval_censor, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">AL=</span>AL, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">AR=</span>AR, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t=</span>onset_infectee, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb2-13">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span>
<span id="cb2-14"></span>
<span id="cb2-15">x1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb2-16">x2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>res2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb2-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(x1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.1677  3.7743  6.2386  7.3706 10.0134 36.0535 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(x2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
 0.05973  2.01266  3.88932  4.85497  6.77875 20.17723 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"No censoring"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Interval censoring"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(x1,x2))</span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb6-5"></span>
<span id="cb6-6">df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>model))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, </span>
<span id="cb6-10">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>()) </span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/interval-censoring/index_files/figure-html/uniform_interval-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>serial interval</category>
  <category>interval censoring</category>
  <category>MLE</category>
  <guid>https://kimfinale.github.io/myblog/posts/interval-censoring/index.html</guid>
  <pubDate>Tue, 14 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/interval-censoring/interval_censor.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Branching process model 2</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/branching_process2/index.html</link>
  <description><![CDATA[ 




<section id="branching-process-model" class="level3">
<h3 class="anchored" data-anchor-id="branching-process-model">Branching process model</h3>
<p>In the branching process model, the number of secondary infections is realized as a random number (e.g., Poission or Negative binomial).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">R0_mean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-2">popsize <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># population size for each iteration</span></span>
<span id="cb1-3">nrun <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of iterations to compute the mean</span></span>
<span id="cb1-4">outbreaks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, nrun) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to store outbreak size for each iteration</span></span>
<span id="cb1-5">init_inf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initially infected people</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (r <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>nrun) {</span>
<span id="cb1-8">  pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>popsize)</span>
<span id="cb1-9">  pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span></span>
<span id="cb1-10">  pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>init_inf] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span></span>
<span id="cb1-11">  pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>run_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> r</span>
<span id="cb1-12">  pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_inf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb1-13">  pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_inf[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>init_inf] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-14">  nS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)</span>
<span id="cb1-15">  nI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)</span>
<span id="cb1-16">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(pop)</span>
<span id="cb1-17">  cnt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> init_inf <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># infecteds are placed from the first position</span></span>
<span id="cb1-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> (nI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> nS <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb1-19">    row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)</span>
<span id="cb1-20">    nI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(row)</span>
<span id="cb1-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(nI)) {</span>
<span id="cb1-22">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># cat("i =", i, "\n")</span></span>
<span id="cb1-23">      pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status[row[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span></span>
<span id="cb1-24">      offspring <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rpois</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda=</span>R0_mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>nS<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N)</span>
<span id="cb1-25">      nS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> nS <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> offspring</span>
<span id="cb1-26">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(offspring)) {</span>
<span id="cb1-27">        pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status[cnt] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span></span>
<span id="cb1-28">        pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_inf[cnt] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time_inf[row[i]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-29">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb1-30">        cnt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-31">      }</span>
<span id="cb1-32">    }</span>
<span id="cb1-33">  }</span>
<span id="cb1-34">  outbreaks[[r]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pop</span>
<span id="cb1-35">}</span>
<span id="cb1-36"></span>
<span id="cb1-37">outbreak_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(outbreaks, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(x) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>))</span>
<span id="cb1-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(outbreak_size) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minor and major outbreaks</span></span>
<span id="cb1-39">major_outbreaks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> outbreak_size <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span></span>
<span id="cb1-40"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(outbreak_size[major_outbreaks])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>popsize <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only major outbreaks</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7960679</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">outbks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list_rbind</span>(outbreaks)</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/branching_process2/index_files/figure-html/sir_branch-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">outbks[major_outbreaks,] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(time_inf)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>time_inf))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/branching_process2/index_files/figure-html/sir_branch-2.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>branching process</category>
  <category>final epidemic size</category>
  <guid>https://kimfinale.github.io/myblog/posts/branching_process2/index.html</guid>
  <pubDate>Mon, 13 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/branching_process2/thumbnail.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Modeling philosophy</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/modeling-philosophy/index.html</link>
  <description><![CDATA[ 




<p>ê°ì—¼ë³‘ ì „íŒŒë¥¼ ì´í•´í•˜ëŠ” ë°ì—ëŠ” ìˆ˜ë¦¬ ëª¨í˜• (model)ì´ ì•„ì£¼ ì¤‘ìš”í•œ ì—­í• ì„ í•œë‹¤. ê·¸ëŸ°ë° í˜„ì‹¤ê³¼ëŠ” ëª¨í˜•ì„ í†µí•´ì„œ ì–´ë–»ê²Œ í˜„ì‹¤ì— ëŒ€í•´ ë°°ìš¸ ìˆ˜ ìžˆì„ê¹Œ? <a href="https://plato.stanford.edu/entries/models-science/#EpisCognFuncMode">ìŠ¤íƒ í¬ë“œ ì² í•™ ë°±ê³¼ì‚¬ì „</a>ì— ì´ëŸ¬í•œ ë‚´ìš©ì„ ë‹´ê³  ìžˆëŠ” ë¶€ë¶„ì´ ìžˆì–´ ì—¬ê¸°ì— ì •ë¦¬ë¥¼ í•´ë³¸ë‹¤. ì•„ì§ ë§Œì¡±í•œ ë§Œí•œ í•´ë‹µì„ ì°¾ì§€ëŠ” ëª»í–ˆë‹¤.</p>
<p>ì² í•™ìžë“¤ì€ ëª¨í˜•ì„ ë§Œë“¤ê³  (building), ì¡°ìž‘í•˜ê³  (manipulation), ì ìš©í•˜ê³  (application), í‰ê°€í•¨ (evaluation)ìœ¼ë¡œì¨ í˜„ì‹¤ì— ëŒ€í•´ ì¶”ë¡  (reasoning) ì„ í•  ìˆ˜ ìžˆë‹¤ê³  ê¸°ìˆ í•˜ê³  ìžˆëŠ” ê²ƒ ê°™ë‹¤. ì´ëŸ° ê³¼ì •ì„ â€œsurrogative reasoningâ€ í˜¹ì€ â€œmodel-based reasoningâ€ ì´ë¼ëŠ” ìš©ì–´ë¡œ í‘œí˜„í•˜ê¸°ë„ í–ˆë‹¤. ì¶”ë¡  ê³¼ì •ì€ ëª¨í˜• ìžì²´ë¥¼ ì´í•´í•˜ëŠ” ê³¼ì •ê³¼ ê·¸ ëª¨í˜•ì— ëŒ€í•œ ì´í•´ë¥¼ í˜„ì‹¤ì— ì ìš©í•˜ëŠ” ê³¼ì • ë‘ ê°€ì§€ë¡œ ë‚˜ëˆ„ì–´ ë³¼ ìˆ˜ ìžˆë‹¤. ëª¨í˜•ì„ ë§Œë“œëŠ” ê³¼ì •ì€ ëª¨í˜•ì˜ ì—¬ëŸ¬ ë¶€ë¶„ë“¤ì´ ì–´ë–»ê²Œ ì„œë¡œ ë§žì•„ ë“¤ì–´ê°€ëŠ” ì§€ ì•Œê²Œ ë˜ëŠ” ê³¼ì •ì´ë‹¤. ëª¨í˜•ì„ ì¡°ìž‘í•˜ëŠ” ê³¼ì •ì€ ëª¨í˜•ì„ ëª¨ìˆ˜(parameter)ë¥¼ ë³€í™”ì‹œì¼œê°€ë©° ì‹œë¬¼ë ˆì´ì…˜ì„ í†µí•´ ê·¸ ê²°ê³¼ë¥¼ í™•ì¸í•˜ëŠ” ê³¼ì •ì´ ë  ê²ƒì´ë‹¤. ëª¨í˜•ì„ ë§Œë“¤ê³  ì¡°ìž‘í•¨ìœ¼ë¡œì¨ ì•Œê²Œëœ ì§€ì‹ì„ ì–´ë–»ê²Œ ê·¸ ëŒ€ìƒì¸ (target system)ì¸ í˜„ì‹¤ì˜ ì–¸ì–´ë¡œ ë³€ì—­í•  ìˆ˜ ìžˆì„ê¹Œ? ëª¨í˜•ì´ í˜„ì‹¤ì˜ ì¼ë¶€ë¥¼ ë‚˜íƒ€ë‚´ë„ë¡ (represent) ë§Œë“¤ì–´ ì¡Œë‹¤ë©´ ì¦‰ ë‹¤ì‹œ ë§í•´ ìš°ë¦¬ê°€ ì•Œê³ ìž í•˜ëŠ” í˜„ì‹¤ (ì˜ˆë¥¼ ë“¤ë©´ ë°±ì‹  ì ‘ì¢… ì‹œì— ê°ì—¼ìžìˆ˜ì˜ ê°ì†Œ ì •ë„)ì— ìƒì‘í•˜ëŠ” ë¶€ë¶„ì´ ëª¨í˜•ì— êµ¬í˜„ë˜ì–´ ìžˆë‹¤ë©´ ëª¨í˜•ì„ í†µí•´ì„œ ì–»ì€ ì§€ì‹ì´ í˜„ì‹¤ì— ì ìš©ë  ìˆ˜ ìžˆì„ ê²ƒ ê°™ë‹¤. ê·¸ëŸ°ë° ëª¨í˜•ì— êµ¬í˜„ëœ ë¶€ë¶„ì´ í˜„ì‹¤ì„ ìž˜ ë°˜ì˜í•˜ëŠ”ì§€ë¥¼ ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìžˆì„ê¹Œ?</p>



 ]]></description>
  <category>modeling</category>
  <category>philosophy</category>
  <guid>https://kimfinale.github.io/myblog/posts/modeling-philosophy/index.html</guid>
  <pubDate>Mon, 13 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/modeling-philosophy/sep-man-red.png" medium="image" type="image/png" height="150" width="100"/>
</item>
<item>
  <title>Final epidemic size: uniroot vs.Â optimize</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/rootsolve_optimize/index.html</link>
  <description><![CDATA[ 




<section id="final-size-of-an-epidemic" class="level3">
<h3 class="anchored" data-anchor-id="final-size-of-an-epidemic">Final size of an epidemic</h3>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3506030/">Miller 2012</a> shows that the final size of an epidmic for a well-mixed population can be derived in the following way. We divide the population into susceptible, infected, and recovered fractions: <img src="https://latex.codecogs.com/png.latex?S(t),%20I(t),%20and%20R(t)"> respectively. Assuming a large population, constant transmission and recovery rates, and mass action mixing, we have</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cdot%7BS%7D=%20-%5Cbeta%20IS,%20~%5Cdot%7BI%7D=%5Cbeta%20IS%20-%5Cgamma%20I,%20~%5Cdot%7BR%7D=%5Cgamma%20I"> We can remove <img src="https://latex.codecogs.com/png.latex?%5Cdot%7BR%7D"> since <img src="https://latex.codecogs.com/png.latex?S+I+R=1">. From the equation, we can have the following relationship.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BdS%7D%7BdI%7D=%20-1%20+%20%5Cfrac%7B%5Cgamma%7D%7B%5Cbeta%20S%7D"> Solving this equation gives the following: <img src="https://latex.codecogs.com/png.latex?%20I(t)%20=%20-S(t)%20+%20%5Cfrac%7B%5Cgamma%7D%7B%5Cbeta%7D%20%5Ctext%7Bln%7D%20S(t)%20+%20C"></p>
<p>We can find <img src="https://latex.codecogs.com/png.latex?C=1"> using the initial conditions (<img src="https://latex.codecogs.com/png.latex?I%5Crightarrow%200,%20S%5Crightarrow%200">). Then, using <img src="https://latex.codecogs.com/png.latex?I(%5Cinfty)=0"> gives the following relationship</p>
<p><img src="https://latex.codecogs.com/png.latex?S(%5Cinfty)%20=%201%20%E2%88%92%20%5Ctext%7Bexp%7D%5Cleft%5B-R_0%5Cleft(1-S(%5Cinfty)%5Cright)%5Cright%5D"> Using the <img src="https://latex.codecogs.com/png.latex?R(%5Cinfty)=1-S(%5Cinfty)">, we can get the following equation for the final size of an epidemic, <img src="https://latex.codecogs.com/png.latex?R(%5Cinfty)">:</p>
<p><img src="https://latex.codecogs.com/png.latex?R(%5Cinfty)%20=%201%20%E2%88%92%20%5Ctext%7Bexp%7D%5Cleft%5B-R_0R(%5Cinfty)%5Cright%5D"> Letâ€™s use the above relationship to compute the final epidemic size nuerically</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">final_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(R, R0){</span>
<span id="cb1-2">  R <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>R0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R)</span>
<span id="cb1-3">}</span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># lower bound set at 0.1 to avoid R=0, which is also a solution</span></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uniroot</span>(final_size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>root</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.796811</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0vec =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>))) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># as  </span></span>
<span id="cb3-2">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sizevec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>R0vec, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uniroot</span>(final_size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span>x)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>root)</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb3-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(R0vec, sizevec)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R[0]"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final epidemic size"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/rootsolve_optimize/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("epidemicsize_R.png", p, units="in", width=3.4, height=2.7)</span></span></code></pre></div>
</div>
<p>Instead of <code>uniroot</code>, <code>optimize</code> function can be used to find the solution for the above equation. However, <code>optimize</code> gives the correct answer when the function was squared.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optimize</span>(final_size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$minimum
[1] 0.3465758

$objective
[1] -0.1534264</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">final_size_sq <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(R, R0){</span>
<span id="cb7-2">  (R <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>R0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb7-3">}</span>
<span id="cb7-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optimize</span>(final_size_sq, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$minimum
[1] 0.7968155

$objective
[1] 3.933157e-12</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>epidemic</category>
  <category>size</category>
  <category>R</category>
  <category>uniroot</category>
  <category>optimize</category>
  <guid>https://kimfinale.github.io/myblog/posts/rootsolve_optimize/index.html</guid>
  <pubDate>Thu, 09 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/rootsolve_optimize/epidemicsize_R.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>SEIR model</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/seir-models/index.html</link>
  <description><![CDATA[ 




<section id="susceptible-exposed-infective-recovered-seir-ëª¨í˜•" class="level3">
<h3 class="anchored" data-anchor-id="susceptible-exposed-infective-recovered-seir-ëª¨í˜•">Susceptible-Exposed-Infective-Recovered (SEIR) ëª¨í˜•</h3>
<p>SEIR ëª¨í˜•ì€ ìž ë³µê¸°ê°€ ì–´ëŠ ì •ë„ ê¸´ ê°ì—¼ë³‘ (ì˜ˆë¥¼ ë“¤ì–´ ì½”ë¡œë‚˜19)ì˜ ì „íŒŒë¥¼ ëª¨í˜•í•˜ëŠ” ë° ì‚¬ìš©í•œë‹¤. ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” SEIR ëª¨í˜•ì„ ë§Œë“œëŠ” ë°©ë²•ì„ ì•Œì•„ë³¸ë‹¤. ê²°ì •ë¡ ì  (deterministic) ê·¸ë¦¬ê³  í™•ë¥ ë¡ ì  (stochastic) ë°©ë²•ìœ¼ë¡œ SEIR ëª¨í˜•ì„ Rì–¸ì–´ë¡œ ë§Œë“¤ì–´ ë³¸ë‹¤.</p>
<section id="deterministic-model" class="level4">
<h4 class="anchored" data-anchor-id="deterministic-model">Deterministic model</h4>
<p>ê²°ì •ë¡ ì  ëª¨í˜•ì€ ì£¼ë¡œ ë¯¸ë¶„ì‹ (differential equation)ì„ ì´ìš©í•˜ì—¬ êµ¬í˜„í•œë‹¤. <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bequation%7D%20%5Cbegin%7Bsplit%7D%20%20%5Cfrac%7BdS%7D%7Bdt%7D%20&amp;=%20-%20%5Cbeta%20S%5Cfrac%7BI%7D%7BN%7D%5C%5C%20%5Cfrac%7BdE%7D%7Bdt%7D%20&amp;=%20%5Cbeta%20S%5Cfrac%7BI%7D%7BN%7D%20-%20%5Cepsilon%20E%5C%5C%20%5Cfrac%7BdI%7D%7Bdt%7D%20&amp;=%20%5Cepsilon%20E%20-%20%5Cgamma%20I%5C%5C%20%5Cfrac%7BdR%7D%7Bdt%7D%20&amp;=%20%5Cgamma%20I%20%5Cend%7Bsplit%7D%20%5Cend%7Bequation%7D"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">seir_ode <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(t, y, params) {</span>
<span id="cb1-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># state variables </span></span>
<span id="cb1-3">  S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]; E <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]; I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]; R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>];</span>
<span id="cb1-4">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>]] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># beta = transmission rate</span></span>
<span id="cb1-5">  epsilon <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"epsilon"</span>]] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1/epsilon = latent period</span></span>
<span id="cb1-6">  gamma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>]] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1/gamma = duration of infectiousness</span></span>
<span id="cb1-7">  </span>
<span id="cb1-8">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> E <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> R <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># total population size</span></span>
<span id="cb1-9">  muSE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> beta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> N <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rate from S to E</span></span>
<span id="cb1-10">  muEI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> epsilon <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> E <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rate from E to I, i.e., 1/epsilon = latent period</span></span>
<span id="cb1-11">  muIR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gamma <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> I <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rate from I to R</span></span>
<span id="cb1-12">  </span>
<span id="cb1-13">  dS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> muSE <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rate of change for S</span></span>
<span id="cb1-14">  dE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> muSE <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> muEI <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rate of change for E</span></span>
<span id="cb1-15">  dI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> muEI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> muIR <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rate of change for I</span></span>
<span id="cb1-16">  dR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> muIR <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rate of change for R</span></span>
<span id="cb1-17">  </span>
<span id="cb1-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(dS, dE, dI, dR))) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># return as a list to use deSolve package</span></span>
<span id="cb1-19">}</span></code></pre></div>
</div>
<p>ë¯¸ë¶„ì‹ì„ ì ë¶„í•˜ì—¬ SEIR ë³€ìˆ˜ë“¤ì˜ ì‹œê°„ì— ë”°ë¥¸ ì¶”ì´ë¥¼ ì‚´íŽ´ë³´ìž. ì ë¶„ì€ deSolve íŒ¨í‚¤ì§€ì˜ ode í•¨ìˆ˜ë¥¼ ì´ìš©í•œë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">I0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initially infected people</span></span>
<span id="cb2-2">y0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> I0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">E =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I =</span> I0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initial values for state variables</span></span>
<span id="cb2-3">params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameter input for the SIR model</span></span>
<span id="cb2-4">params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>epsilon <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb2-5">params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gamma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb2-6">params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>  </span>
<span id="cb2-7">tend <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># simulation end time 50 days</span></span>
<span id="cb2-8">times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, tend, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># daily output for 150 days</span></span>
<span id="cb2-9"></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ODE integration using the deSolve package</span></span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(deSolve)</span>
<span id="cb2-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to use %&gt;%</span></span>
<span id="cb2-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ode</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span>times, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func=</span>seir_ode, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>params) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>() <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> out</span>
<span id="cb2-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># turn the data into a long format for easier plot</span></span>
<span id="cb2-16">outlong <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> out <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"State"</span>)</span>
<span id="cb2-17"></span>
<span id="cb2-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb2-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb2-20">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>()</span>
<span id="cb2-21"></span>
<span id="cb2-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(outlong, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>State)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time (day)'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Proportion'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb2-26">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) </span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/seir-models/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="í™•ë¥ ë¡ ì -ëª¨í˜•" class="level4">
<h4 class="anchored" data-anchor-id="í™•ë¥ ë¡ ì -ëª¨í˜•">í™•ë¥ ë¡ ì  ëª¨í˜•</h4>
<p>ë‘ ê°€ì§€ ë°©ì‹ìœ¼ë¡œ í™•ë¥ ë¡ ì  ëª¨í˜•ì„ êµ¬í˜„í•˜ì—¬ ë³¸ë‹¤. ì²«ë²ˆì§¸ëŠ” <img src="https://latex.codecogs.com/png.latex?%5Ctau">-leaping ë°©ë²•ê³¼ ìœ ì‚¬í•˜ë‚˜ í‘¸ì•„ì†¡ ë¶„í¬ ëŒ€ì‹  binomial ë¶„í¬ë¥¼ ì‚¬ìš©í•œë‹¤. í‘¸ì•„ì†¡ ë¶„í¬ì™€ ë‹¬ë¦¬ ìƒí•œì„ ì´ ì •í•´ì§€ë¯€ë¡œ ê° ìƒíƒœ ë³€ìˆ˜ê°€ ìŒìˆ˜ë¡œ ê°€ëŠ” ê²ƒì„ ë§‰ì„ ìˆ˜ ìžˆëŠ” ìž‡ì ì´ ìžˆë‹¤. Sì—ì„œ Eë¡œ ë‹¨ìœ„ ì‹œê°„ <img src="https://latex.codecogs.com/png.latex?%5Cdelta"> ë™ì•ˆ ì´ë™í•˜ëŠ” ìˆ˜ëŠ” ì•„ëž˜ì™€ ê°™ì´ ì •í•´ì§„ë‹¤. <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bequation%7D%20%5Cbegin%7Bsplit%7D%20%20%5CDelta%20N_%7BSE%7D%20&amp;=%20%5Ctextrm%7BBinomial%7D%5Cleft(%20S(t),%201-%5Ctextrm%7Bexp%7D%5B%7B-r_%7BSE%7D%5Cdelta%20%7D%5D%5Cright)%20%5C%5C%20S(t+%5Cdelta)%20&amp;=%20S(t)%20-%20%5CDelta%20N_%7BSE%7D%5C%20%5Cend%7Bsplit%7D%20%5Cend%7Bequation%7D"> ë¹„ìŠ·í•œ ë°©ë²•ìœ¼ë¡œ <img src="https://latex.codecogs.com/png.latex?E">ì—ì„œ <img src="https://latex.codecogs.com/png.latex?I"> ê·¸ë¦¬ê³  <img src="https://latex.codecogs.com/png.latex?I">ì—ì„œ <img src="https://latex.codecogs.com/png.latex?R">ë¡œ ë³€í•˜ëŠ” ìˆ˜ë¥¼ ê³„ì‚°í•˜ì—¬ ì•„ëž˜ì™€ ê°™ì´ êµ¬í˜„í•œë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">seir_stoch_step <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> (y, params, delta) {</span>
<span id="cb3-2">  </span>
<span id="cb3-3">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>]]</span>
<span id="cb3-4">  epsilon <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"epsilon"</span>]]</span>
<span id="cb3-5">  gamma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>]] </span>
<span id="cb3-6"></span>
<span id="cb3-7">  S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>]; E <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span>]; I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>]; R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>];</span>
<span id="cb3-8"></span>
<span id="cb3-9">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> E <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> R</span>
<span id="cb3-10">  rSE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> beta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> N</span>
<span id="cb3-11">  rEI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> epsilon</span>
<span id="cb3-12">  rIR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gamma</span>
<span id="cb3-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of events over the time step, delta, modeled as binomial random variable     </span></span>
<span id="cb3-14">  nSE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, S, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> rSE <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> delta))</span>
<span id="cb3-15">  nEI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, E, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> rEI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> delta))</span>
<span id="cb3-16">  nIR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, I, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> rIR <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> delta))</span>
<span id="cb3-17"></span>
<span id="cb3-18">  dSdt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> nSE</span>
<span id="cb3-19">  dEdt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nSE <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> nEI</span>
<span id="cb3-20">  dIdt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nEI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> nIR</span>
<span id="cb3-21">  dRdt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nIR</span>
<span id="cb3-22">  dCEdt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nSE</span>
<span id="cb3-23">  dCIdt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> nEI</span>
<span id="cb3-24"></span>
<span id="cb3-25"> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(dSdt, dEdt, dIdt, dRdt)))</span>
<span id="cb3-26">}</span></code></pre></div>
</div>
<p>ìœ„ í•¨ìˆ˜ëŠ” í•œ ë²ˆì˜<img src="https://latex.codecogs.com/png.latex?%5Cdelta">ë™ì•ˆ ë³€í™”ë¥¼ ì¶œë ¥í•˜ê¸° ë•Œë¬¸ì— ì›í•˜ëŠ” ê¸°ê°„ ë™ì•ˆ ì—°ì†í•´ì„œ ê³„ì‚°í•˜ê¸° ìœ„í•´ ì•„ëž˜ì™€ ê°™ì€ í•¨ìˆ˜ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ë§Œë“ ë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">stoch_solve <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(func, y, times, params, delta) {</span>
<span id="cb4-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># times indicate the times for which we want to see outputs</span></span>
<span id="cb4-3">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(times), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)))</span>
<span id="cb4-4">  out[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(times[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], y)</span>
<span id="cb4-5">  row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb4-6">  </span>
<span id="cb4-7">  substeps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>((times[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>times[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>delta)</span>
<span id="cb4-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(times)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) {</span>
<span id="cb4-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (t2 <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>substeps) {</span>
<span id="cb4-10">      y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">func</span>(y, params, delta))</span>
<span id="cb4-11">    }</span>
<span id="cb4-12">    out[row, ] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(t, y)</span>
<span id="cb4-13">    row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> row <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-14">  }</span>
<span id="cb4-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(out) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(y))</span>
<span id="cb4-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span> (out)</span>
<span id="cb4-17">}</span></code></pre></div>
</div>
<p>ìœ„ stoch_solve í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ ê³„ì‚°í•˜ê³  í”Œë¡¯íŒ…ì„ í•´ë³¸ë‹¤. ODE ëª¨í˜•ì˜ ê²°ê³¼ëŠ” proportionìœ¼ë¡œ ì£¼ì–´ì ¸ ìžˆìœ¼ë‹ˆ 1,000ì„ ê³±í•œ í›„ ë¹„êµí•˜ë©´ ê²°ê³¼ê°€ í¬ê²Œ ë‹¤ë¥´ì§€ ì•ŠìŒì„ ì•Œ ìˆ˜ ìžˆë‹¤. stoch_solveë¥¼ ì—¬ë ¤ ë²ˆ ì‹¤í–‰í•˜ì—¬ í‰ê· ì„ ë¹„êµí•˜ë©´ ê·¸ë¦¬ê³ <img src="https://latex.codecogs.com/png.latex?%5Cdelta">ì„ ìž‘ê²Œ í•  ìˆ˜ë¡ ODE ëª¨í˜•ì˜ ê²°ê³¼ì™€ ê°€ê¹Œì›Œì§„ë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stoch_solve</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func =</span> seir_stoch_step, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>y0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params =</span> params, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delta=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb5-2">reslong <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(res, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"State"</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(reslong, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> State)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time (day)'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Number'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb5-8">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) </span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/seir-models/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="gillespie-algorithm" class="level4">
<h4 class="anchored" data-anchor-id="gillespie-algorithm">Gillespie algorithm</h4>
<p>ìœ„ì—ì„œ ê¸°ìˆ í•œ í™•ë¥ ë¡ ì  ë°©ë²•ì€ ìš°ë¦¬ê°€ ì´ë¯¸ ì •í•œ time interval <img src="https://latex.codecogs.com/png.latex?%5Cdelta">ì— ë”°ë¼ ì˜¤ì°¨ê°€ ë°œìƒí•˜ëŠ” ë°˜ë©´ Gillespie algorithm ì„ ì´ìš©í•´ì„œ í†µê³„ì ìœ¼ë¡œ ì •í™•í•œ stochastic simulation ì„ í•  ìˆ˜ ìžˆë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">seir_gillespie <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(y, params) {</span>
<span id="cb6-2">  S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>]</span>
<span id="cb6-3">  E <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span>]</span>
<span id="cb6-4">  I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>]</span>
<span id="cb6-5">  R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>]</span>
<span id="cb6-6">  </span>
<span id="cb6-7">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>]]</span>
<span id="cb6-8">  epsilon <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"epsilon"</span>]]</span>
<span id="cb6-9">  gamma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>]]</span>
<span id="cb6-10">  </span>
<span id="cb6-11">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> E <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> R</span>
<span id="cb6-12">  event_occurred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb6-13">  tau <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {<span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## no need to proceed if no one is infectious or no one is susceptible</span></span>
<span id="cb6-15">    rate_StoE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> beta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> N</span>
<span id="cb6-16">    rate_EtoI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> epsilon <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> E</span>
<span id="cb6-17">    rate_ItoR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gamma <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> I</span>
<span id="cb6-18">    </span>
<span id="cb6-19">    rate_all <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(rate_StoE, rate_EtoI, rate_ItoR) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># event rates</span></span>
<span id="cb6-20">    tau <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rexp</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(rate_all)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time to the next event</span></span>
<span id="cb6-21">    event <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(rate_all), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> rate_all) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># next event</span></span>
<span id="cb6-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (event <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb6-23">      S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-24">      E <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> E <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-25">    }</span>
<span id="cb6-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (event <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) {</span>
<span id="cb6-27">      E <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> E <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-28">      I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-29">    }</span>
<span id="cb6-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (event <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) {</span>
<span id="cb6-31">      I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-32">      R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> R <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-33">    }</span>
<span id="cb6-34">    event_occurred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>;</span>
<span id="cb6-35">  }</span>
<span id="cb6-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(S, E, I, R),</span>
<span id="cb6-37">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tau =</span> tau,</span>
<span id="cb6-38">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">event_occurred =</span> event_occurred))</span>
<span id="cb6-39">}</span></code></pre></div>
</div>
<p>seir_gillespieëŠ” í•œ ë²ˆì˜ event í›„ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ë¯€ë¡œ ì•„ëž˜ì™€ ê°™ì´ ì¶”ê°€ì ì¸ í•¨ìˆ˜ë¥¼ êµ¬ì„±í•˜ì—¬ ì‹œë¬¼ë ˆì´ì…˜ì„ í•œë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">run_seir_gillespie <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(func, tend, y, params, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">report_dt =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb7-2">  res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(y)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># store the simulation results</span></span>
<span id="cb7-3">  t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-4">  yt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y</span>
<span id="cb7-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> (t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tend) {</span>
<span id="cb7-6">    sim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">func</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> yt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params =</span> params) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># one event according to the Gillespie algorithm</span></span>
<span id="cb7-7">    t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sim<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>tau</span>
<span id="cb7-8">    yt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y</span>
<span id="cb7-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> report_dt) { <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add to the result only when the t is reaches report dt</span></span>
<span id="cb7-10">      res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(res, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(t, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(yt)))</span>
<span id="cb7-11">      report_dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> report_dt  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-12">    }</span>
<span id="cb7-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>sim<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>event_occurred)</span>
<span id="cb7-14">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb7-15">  }</span>
<span id="cb7-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span> (res)</span>
<span id="cb7-17">}</span></code></pre></div>
</div>
<p>ì‹œë¬¼ë ˆì´ì…˜ ê²°ê³¼ë¥¼ í”Œë¡¯íŒ… í•œë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run_seir_gillespie</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func =</span> seir_gillespie, </span>
<span id="cb8-2">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tend =</span> tend, </span>
<span id="cb8-3">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, </span>
<span id="cb8-4">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params =</span> params, </span>
<span id="cb8-5">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">report_dt =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-6"></span>
<span id="cb8-7">reslong <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(res, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"State"</span>)</span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(reslong, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> State)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time (day)'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Number'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb8-13">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb8-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gillespie algorithm"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/seir-models/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("gillespie.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>


</section>
</section>

 ]]></description>
  <category>SEIR</category>
  <category>deterministic</category>
  <category>stochastic</category>
  <category>Gillespie&#39;s algorithm</category>
  <guid>https://kimfinale.github.io/myblog/posts/seir-models/index.html</guid>
  <pubDate>Wed, 08 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/seir-models/gillespie.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Branching process model</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/branching_process/index.html</link>
  <description><![CDATA[ 




<section id="branching-process-model" class="level3">
<h3 class="anchored" data-anchor-id="branching-process-model">Branching process model</h3>
<p>In the branching process model, the number of secondary infections is realized as a random number (e.g., Poission or Negative binomial).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb1-2">R0_mean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-3">popsize <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># population size for each iteration</span></span>
<span id="cb1-4">nrun <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of iterations to compute the mean</span></span>
<span id="cb1-5">outbreaks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, nrun) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to store outbreak size for each iteration</span></span>
<span id="cb1-6">init_inf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initially infected people</span></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (r <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(nrun)) {</span>
<span id="cb1-9">  pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>popsize)</span>
<span id="cb1-10">  pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span></span>
<span id="cb1-11">  pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>init_inf] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span></span>
<span id="cb1-12">  nS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)</span>
<span id="cb1-13">  nI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)</span>
<span id="cb1-14">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(pop)</span>
<span id="cb1-15">  cnt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> init_inf <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># infecteds are placed from the first position</span></span>
<span id="cb1-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> (nI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> nS <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb1-17">    row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)</span>
<span id="cb1-18">    nI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(row)</span>
<span id="cb1-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(nI)) {</span>
<span id="cb1-20">      pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status[row[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span></span>
<span id="cb1-21">      offspring <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rpois</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda=</span>R0_mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>nS<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N)</span>
<span id="cb1-22">      nS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> nS <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> offspring</span>
<span id="cb1-23">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(offspring)) {</span>
<span id="cb1-24">        pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status[cnt] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span> </span>
<span id="cb1-25">        cnt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-26">      }</span>
<span id="cb1-27">    }</span>
<span id="cb1-28">  }</span>
<span id="cb1-29">  outbreaks[r] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> popsize <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)</span>
<span id="cb1-30">}</span>
<span id="cb1-31"></span>
<span id="cb1-32"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(outbreaks) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minor and major outbreaks</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/branching_process/index_files/figure-html/sir_branch-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(outbreaks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>nrun <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># freq of major outbreaks</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.792</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(outbreaks[outbreaks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>popsize <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># outbreak size of the only major outbreaks</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7966742</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(outbreaks) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># maximum outbreak size</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 853</code></pre>
</div>
</div>
</section>
<section id="final-epidemic-size" class="level3">
<h3 class="anchored" data-anchor-id="final-epidemic-size">Final epidemic size</h3>
<p>To make sure that my branching process model makes sense, letâ€™s compare the final size of an epidemic. As shown in the previous post, for the <img src="https://latex.codecogs.com/png.latex?SIR"> model in a well-mixed population, the final epidemic size, <img src="https://latex.codecogs.com/png.latex?R(%5Cinfty)"> is given as follows: <img src="https://latex.codecogs.com/png.latex?R(%5Cinfty)%20=%201%20%E2%88%92%20%5Ctext%7Bexp%7D%5Cleft%5B-R_0R(%5Cinfty)%5Cright%5D"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># final size of an epidemic, R</span></span>
<span id="cb8-2">final_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(R, R0){</span>
<span id="cb8-3">  R <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>R0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R)</span>
<span id="cb8-4">}</span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># lower bound set at a positive number to avoid R=0, which is also a solution</span></span>
<span id="cb8-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uniroot</span>(final_size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span>R0_mean)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>root</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7968115</code></pre>
</div>
</div>
</section>
<section id="negative-binomial-distribution" class="level3">
<h3 class="anchored" data-anchor-id="negative-binomial-distribution">Negative binomial distribution</h3>
<p>What would happen if I allow the negative binomial distribution for the offspring</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb10-2">R0_mean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb10-3">R0_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loosely based on the estimate for Ebola (see Kucharski et al. 2016 https://wwwnc.cdc.gov/eid/article/22/1/15-1410_article)</span></span>
<span id="cb10-4">popsize <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># population size for each iteration</span></span>
<span id="cb10-5">nrun <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of iterations to compute the mean</span></span>
<span id="cb10-6">outbreaks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, nrun) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to store outbreak size for each iteration</span></span>
<span id="cb10-7">init_inf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initially infected people</span></span>
<span id="cb10-8"></span>
<span id="cb10-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (r <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(nrun)) {</span>
<span id="cb10-10">  pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>popsize)</span>
<span id="cb10-11">  pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span></span>
<span id="cb10-12">  pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>init_inf] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span></span>
<span id="cb10-13">  nS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)</span>
<span id="cb10-14">  nI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)</span>
<span id="cb10-15">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(pop)</span>
<span id="cb10-16">  cnt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> init_inf <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># infecteds are placed from the first position</span></span>
<span id="cb10-17">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> (nI <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> nS <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) {</span>
<span id="cb10-18">    row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)</span>
<span id="cb10-19">    nI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(row)</span>
<span id="cb10-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(nI)) {</span>
<span id="cb10-21">      pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status[row[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span></span>
<span id="cb10-22">      offspring <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span>R0_mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>nS<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span>R0_size)</span>
<span id="cb10-23">      nS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> nS <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> offspring</span>
<span id="cb10-24">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(offspring)) {</span>
<span id="cb10-25">        pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status[cnt] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span> </span>
<span id="cb10-26">        cnt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cnt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb10-27">      }</span>
<span id="cb10-28">    }</span>
<span id="cb10-29">  }</span>
<span id="cb10-30">  outbreaks[r] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> popsize <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>status <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)</span>
<span id="cb10-31">}</span>
<span id="cb10-32"></span>
<span id="cb10-33"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(outbreaks) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># minor and major outbreaks</span></span>
<span id="cb10-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(outbreaks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>nrun <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># freq of major outbreaks</span></span>
<span id="cb10-35"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(outbreaks[outbreaks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>popsize <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># only major outbreaks</span></span>
<span id="cb10-36"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(outbreaks) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># maximum outbreak size</span></span></code></pre></div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>branching process</category>
  <category>final epidemic size</category>
  <guid>https://kimfinale.github.io/myblog/posts/branching_process/index.html</guid>
  <pubDate>Tue, 07 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/branching_process/thumbnail.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Negative binomial regression with censored data: POLYMOD data</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/nb-censored-regression/index.html</link>
  <description><![CDATA[ 




<p>This post describes my attempt to reproduce Table 1 of the paper, <a href="https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0050074">Social Contacts and Mixing Patterns Relevant to the Spread of Infectious Diseases</a>. Data were downloaded from <a href="http://www.socialcontactdata.org/">Social Contact Data</a>, which was hosted in <a href="https://zenodo.org/record/3746312#.Xo85CcgzZPY">zenodo</a>. I used the version 1.1. In summary, I wasnâ€™t successful at reproducing the table exactly but still wanted to document the processes that I went through.</p>
<section id="data-preparation" class="level3">
<h3 class="anchored" data-anchor-id="data-preparation">Data preparation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb1-2">d1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2008_Mossong_POLYMOD_participant_common.csv"</span>)</span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># d1 &lt;- fread("data/2008_Mossong_POLYMOD_participant_common.csv")</span></span>
<span id="cb1-4">d2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2008_Mossong_POLYMOD_contact_common.csv"</span>)</span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># d2 &lt;- fread("data/2008_Mossong_POLYMOD_contact_common.csv")</span></span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count the number of contacts for each participant using part_id variable</span></span>
<span id="cb1-8">d2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(part_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contacts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> d2_contacts</span>
<span id="cb1-10">d12 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(d1, d2_contacts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"part_id"</span>)</span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add household information</span></span>
<span id="cb1-12">d3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2008_Mossong_POLYMOD_hh_common.csv"</span>)</span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># d3 &lt;- fread("data/2008_Mossong_POLYMOD_hh_common.csv")</span></span>
<span id="cb1-14">d123 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(d12, d3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hh_id"</span>)</span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add day of week information</span></span>
<span id="cb1-16">d4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2008_Mossong_POLYMOD_sday.csv"</span>)</span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># d4 &lt;- fread("data/2008_Mossong_POLYMOD_sday.csv")</span></span>
<span id="cb1-18">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(d123, d4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"part_id"</span>)</span></code></pre></div>
</div>
</section>
<section id="data-manipulation" class="level3">
<h3 class="anchored" data-anchor-id="data-manipulation">Data manipulation</h3>
<p>Categorize the age group into different 10 age groups: 0-4, 5-9, 10-14, 15-19, and 20 to 70 by 10 years and 70 and above</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">age_grp_label <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0-4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5-9"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10-14"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"15-19"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"20-29"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30-39"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40-49"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"50-59"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"60-69"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"70+"</span>)</span>
<span id="cb2-2"></span>
<span id="cb2-3">classify_age <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d){</span>
<span id="cb2-4">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span></span>
<span id="cb2-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(d)) {</span>
<span id="cb2-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i])){</span>
<span id="cb2-7">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>){</span>
<span id="cb2-8">        d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> age_grp_label[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-9">      }</span>
<span id="cb2-10">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>){</span>
<span id="cb2-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb2-12">          <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>j <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)){</span>
<span id="cb2-13">            d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> age_grp_label[j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-14">          }</span>
<span id="cb2-15">        }</span>
<span id="cb2-16">      }</span>
<span id="cb2-17">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>){</span>
<span id="cb2-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>){</span>
<span id="cb2-19">          <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k)){</span>
<span id="cb2-20">            d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> age_grp_label[k<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb2-21">          }</span>
<span id="cb2-22">        }</span>
<span id="cb2-23">      } </span>
<span id="cb2-24">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb2-25">        d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> age_grp_label[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span>
<span id="cb2-26">      }</span>
<span id="cb2-27">    } </span>
<span id="cb2-28">  }</span>
<span id="cb2-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(d)</span>
<span id="cb2-30">}</span>
<span id="cb2-31"></span>
<span id="cb2-32">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classify_age</span>(dat)</span></code></pre></div>
</div>
<p>Compare the number of participants by age group (the third column of Table 1)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">dat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(age_grp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">npart=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> npart_ag</span>
<span id="cb3-2">npart_ag<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">660</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">661</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">713</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">685</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">879</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">815</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">908</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">906</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">728</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">270</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hard-coded using the values in Table 1.</span></span>
<span id="cb3-3">npart_ag</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 Ã— 3
   age_grp npart  true
   &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt;
 1 0-4       660   660
 2 10-14     713   661
 3 15-19     685   713
 4 20-29     879   685
 5 30-39     815   879
 6 40-49     908   815
 7 5-9       661   908
 8 50-59     906   906
 9 60-69     728   728
10 70+       270   270
11 Missing    65    65</code></pre>
</div>
</div>
<p>Categorize the household size</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">classify_household <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d){</span>
<span id="cb5-2">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span></span>
<span id="cb5-3">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6+"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size))</span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(d)</span>
<span id="cb5-5">}</span>
<span id="cb5-6">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classify_household</span>(dat)</span></code></pre></div>
</div>
<p>Classify gender</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">classify_gender <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d) {</span>
<span id="cb6-2">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gender <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span></span>
<span id="cb6-3">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gender <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>, d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gender))</span>
<span id="cb6-4">  </span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(d)</span>
<span id="cb6-6">}</span>
<span id="cb6-7"></span>
<span id="cb6-8">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classify_gender</span>(dat)</span></code></pre></div>
</div>
<p>Classify day of week</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">dayofweek_label <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sunday"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Monday"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tuesday"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Wednesday"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Thursday"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Friday"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Saturday"</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3">classify_dayofweek <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d) {</span>
<span id="cb7-4">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek_f <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span></span>
<span id="cb7-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(d)) {</span>
<span id="cb7-6">    day <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek[i]</span>
<span id="cb7-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(day)) {</span>
<span id="cb7-8">      d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek_f[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dayofweek_label[day<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb7-9">    }</span>
<span id="cb7-10">  }</span>
<span id="cb7-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(d)</span>
<span id="cb7-12">}</span>
<span id="cb7-13">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classify_dayofweek</span>(dat)</span>
<span id="cb7-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># change names for conveninence</span></span>
<span id="cb7-15">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek_integer <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek</span>
<span id="cb7-16">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek_f</span></code></pre></div>
</div>
<p>Make categorical variables factor for regression Set reference groups <code>relevel(x, ref=ref)</code> as in Table 1</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the categorical variables as factor for regression</span></span>
<span id="cb8-2">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(age_grp_label,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span>))</span>
<span id="cb8-3">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relevel</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0-4"</span>)</span>
<span id="cb8-4">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gender <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gender, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span>))</span>
<span id="cb8-5">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gender <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relevel</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gender, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb8-6">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(dayofweek_label,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span>))</span>
<span id="cb8-7">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relevel</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sunday"</span>)</span>
<span id="cb8-8">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size_grp)</span>
<span id="cb8-9">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relevel</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size_grp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>)</span>
<span id="cb8-10">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BE"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DE"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FI"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GB"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IT"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LU"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NL"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PL"</span>))</span>
<span id="cb8-11">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relevel</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ref=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BE"</span>)</span>
<span id="cb8-12"></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fwrite(dat, "POLYMOD_2017.csv")</span></span></code></pre></div>
</div>
<p>Assign weights to individual participants based on the supplementary Table 2. My approach was to identify a row and a column for the relevant weight based on the age and household size. Weight of an age group for the sample was calculated by dividing the proportion of the age group in the population (in the census) with the proportion of the age group in the sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">find_age_row_column <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d) {</span>
<span id="cb9-2">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb9-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(d)) {</span>
<span id="cb9-4">    ag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i]</span>
<span id="cb9-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(ag)){</span>
<span id="cb9-6">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>) {</span>
<span id="cb9-7">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (ag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> (j<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (j<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) {</span>
<span id="cb9-8">          d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_row[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> j</span>
<span id="cb9-9">          <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb9-10">        }</span>
<span id="cb9-11">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (ag <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>) {</span>
<span id="cb9-12">          d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_row[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span></span>
<span id="cb9-13">          <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb9-14">        }</span>
<span id="cb9-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>{}</span>
<span id="cb9-16">      }</span>
<span id="cb9-17">    }</span>
<span id="cb9-18">  }</span>
<span id="cb9-19">  </span>
<span id="cb9-20">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_col <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb9-21">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(d)) {</span>
<span id="cb9-22">    hs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size[i]</span>
<span id="cb9-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(hs)){</span>
<span id="cb9-24">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) {</span>
<span id="cb9-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (hs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> j) {</span>
<span id="cb9-26">          d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_col[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> j</span>
<span id="cb9-27">          <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">break</span></span>
<span id="cb9-28">        }</span>
<span id="cb9-29">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (hs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) {</span>
<span id="cb9-30">          d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_col[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb9-31">        }</span>
<span id="cb9-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>{}</span>
<span id="cb9-33">      }</span>
<span id="cb9-34">    }</span>
<span id="cb9-35">  }</span>
<span id="cb9-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(d)</span>
<span id="cb9-37">}</span>
<span id="cb9-38"></span>
<span id="cb9-39">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">find_age_row_column</span>(dat)</span>
<span id="cb9-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># wlist &lt;- rio::import_list("data/sampling_weight.xlsx")</span></span>
<span id="cb9-41">wlist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">import_list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sampling_weight.xlsx"</span>)</span>
<span id="cb9-42"></span>
<span id="cb9-43">classify_weight <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d){</span>
<span id="cb9-44">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>wt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb9-45">  cnames <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wlist)</span>
<span id="cb9-46">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(cnames)) {</span>
<span id="cb9-47">    wtable <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> wlist[[i]]</span>
<span id="cb9-48">    w1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> wtable[wtable<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Household size</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ratio C/S"</span>,] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sampling weight</span></span>
<span id="cb9-49">    W <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> w1[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(w1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Household size</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>),] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove the first row</span></span>
<span id="cb9-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># View(W)</span></span>
<span id="cb9-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(d)){</span>
<span id="cb9-52">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country[j] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> cnames[i]) {</span>
<span id="cb9-53">        d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>wt[j] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> W[d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_row[j], d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_col[j]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb9-54">      }</span>
<span id="cb9-55">    }</span>
<span id="cb9-56">  }</span>
<span id="cb9-57">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(d)</span>
<span id="cb9-58">}</span>
<span id="cb9-59"></span>
<span id="cb9-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># grep("-", as.character(d$wt), value = T)</span></span>
<span id="cb9-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hist(as.numeric(d$wt))</span></span>
<span id="cb9-62">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classify_weight</span>(dat)</span>
<span id="cb9-63">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>wt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>wt)</span></code></pre></div>
</div>
</section>
<section id="data-for-fitting-only-complete-cases" class="level3">
<h3 class="anchored" data-anchor-id="data-for-fitting-only-complete-cases">Data for fitting only complete cases</h3>
<p>There are missing values for contacts ($n$=36) and weight ($n$=65). It is not clear how those observations were treated in the model. This may be a reason why I canâ€™t reproduce the results in Table 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">dat_ <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dat</span>
<span id="cb10-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## would imputation for the 36 observations make a difference?</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dat$contacts_ori &lt;- dat$contacts</span></span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dat$contacts &lt;- ifelse(is.na(dat$contacts), round(mean(dat$contacts, na.rm=T)), dat$contacts)</span></span>
<span id="cb10-5"></span>
<span id="cb10-6">model_var <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"contacts"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age_grp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gender"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dayofweek"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hh_size_grp"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"country"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wt"</span>)</span>
<span id="cb10-7">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dat[,..model_var]</span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dat &lt;- dat[complete.cases(dat),]</span></span>
<span id="cb10-9">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dat[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(contacts),]</span></code></pre></div>
</div>
</section>
<section id="negbin-regression-no-censoring-and-no-weighting" class="level3">
<h3 class="anchored" data-anchor-id="negbin-regression-no-censoring-and-no-weighting">NegBin regression: no censoring and no weighting</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(MASS)</span>
<span id="cb11-2">m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm.nb</span>(contacts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age_grp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dayofweek <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hh_size_grp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> country, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dat)</span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># summary(m4)</span></span>
<span id="cb11-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       (Intercept)         age_grp5-9       age_grp10-14       age_grp15-19 
         5.6764958          1.4022341          1.6768688          1.6824225 
      age_grp20-29       age_grp30-39       age_grp40-49       age_grp50-59 
         1.4458386          1.4168460          1.3868642          1.2940456 
      age_grp60-69         age_grp70+     age_grpMissing            genderM 
         1.0520198          0.8120547          1.0338752          0.9941243 
     genderMissing    dayofweekMonday   dayofweekTuesday dayofweekWednesday 
         1.3434436          1.3179053          1.3998594          1.3876252 
 dayofweekThursday    dayofweekFriday  dayofweekSaturday   dayofweekMissing 
         1.3858679          1.4403113          1.1542837          1.2179674 
      hh_size_grp2       hh_size_grp3       hh_size_grp4       hh_size_grp5 
         1.0990550          1.1255471          1.2592436          1.3360603 
     hh_size_grp6+          countryDE          countryFI          countryGB 
         1.4601697          0.7036079          0.9483997          0.9797998 
         countryIT          countryLU          countryNL          countryPL 
         1.6351704          1.4081732          1.2493105          1.3223343 </code></pre>
</div>
</div>
<p>Regression that account for censored number of contacts. The paper reads: <em>The data were right censored at 29 contacts for all countries because of a limited number of possible diary entries in some countries</em></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Blog%20%7DL%20=%20%5Csum_%7Bi=1%7D%5En%20w_i%5Cleft(%5Cdelta_i~%5Ctext%7Blog%7D%20%5Cleft(P%5Cleft(Y=y_i%7CX%5Cright)%5Cright)%20+%20%5Cleft(1-%5Cdelta_i%5Cright)~%5Ctext%7Blog%7D%20%5Cleft(1-%5Csum_%7Bi=1%7D%5E%7B28%7DP(Y=y_i%7CX)%5Cright)%0A%5Cright)%0A"> , where</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bequation%7D%0A%20%20%5Cdelta_i=%5Cbegin%7Bcases%7D%0A%20%20%20%201,%20&amp;%20%5Ctext%7Bif$~y_i%3C29$%7D.%5C%5C%0A%20%20%20%200,%20&amp;%20%5Ctext%7Botherwise%7D.%0A%20%20%5Cend%7Bcases%7D%0A%5Cend%7Bequation%7D%0A"></p>
</section>
<section id="take-censoring-into-account" class="level3">
<h3 class="anchored" data-anchor-id="take-censoring-into-account">Take censoring into account</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(m)</span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># X &lt;- model.matrix(~ age_grp + gender + dayofweek + hh_size_grp + country, data=dat)</span></span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ini = c(coef(m1), log_theta = log(summary(m1)$theta))</span></span>
<span id="cb13-5">init <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(m), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(m)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>theta)</span>
<span id="cb13-6"></span>
<span id="cb13-7">negll_censor <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(par, y, X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ul=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>) {</span>
<span id="cb13-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters</span></span>
<span id="cb13-9">  size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> par[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(par)]</span>
<span id="cb13-10">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> par[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(par)]</span>
<span id="cb13-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create indicator depending on chosen limit</span></span>
<span id="cb13-12">  indicator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> ul</span>
<span id="cb13-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># linear predictor</span></span>
<span id="cb13-14">  mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> beta)</span>
<span id="cb13-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># log likelihood</span></span>
<span id="cb13-16">  ll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(indicator <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnbinom</span>(y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span>mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span>size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log=</span>T) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-17">             (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>indicator) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnbinom</span>(ul, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span>mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span>size)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm=</span>T)</span>
<span id="cb13-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>ll)</span>
<span id="cb13-19">}</span>
<span id="cb13-20"></span>
<span id="cb13-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># you can check if two methods (glm.nb vs. optim) match by setting ul high (e.g., 100)</span></span>
<span id="cb13-22">fit1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span>init,</span>
<span id="cb13-23">            negll_censor,</span>
<span id="cb13-24">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contacts,</span>
<span id="cb13-25">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> X,</span>
<span id="cb13-26">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ul =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>,</span>
<span id="cb13-27">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb13-28">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-10</span>))</span>
<span id="cb13-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(fit1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       (Intercept)         age_grp5-9       age_grp10-14       age_grp15-19 
         5.6047431          1.4335817          1.7328973          1.7131792 
      age_grp20-29       age_grp30-39       age_grp40-49       age_grp50-59 
         1.4411616          1.4214491          1.3811132          1.2825334 
      age_grp60-69         age_grp70+     age_grpMissing            genderM 
         1.0518372          0.8182114          1.0369387          0.9825757 
     genderMissing    dayofweekMonday   dayofweekTuesday dayofweekWednesday 
         1.3945323          1.3504467          1.4340414          1.4146111 
 dayofweekThursday    dayofweekFriday  dayofweekSaturday   dayofweekMissing 
         1.4265521          1.4638406          1.1583928          1.2481137 
      hh_size_grp2       hh_size_grp3       hh_size_grp4       hh_size_grp5 
         1.0879976          1.1266973          1.2623833          1.3638927 
     hh_size_grp6+          countryDE          countryFI          countryGB 
         1.4878961          0.6934848          0.9561751          1.0065923 
         countryIT          countryLU          countryNL          countryPL 
         1.6915581          1.3931403          1.2521232          1.3348934 
              size 
        18.9737736 </code></pre>
</div>
</div>
</section>
<section id="take-censoring-weighting-into-account" class="level3">
<h3 class="anchored" data-anchor-id="take-censoring-weighting-into-account">Take censoring &amp; weighting into account</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(m)</span>
<span id="cb15-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># X &lt;- model.matrix(~ age_grp + gender + dayofweek + hh_size_grp + country, data=dat) # full matrix</span></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ini = c(coef(m1), log_theta = log(summary(m1)$theta))</span></span>
<span id="cb15-4">init <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(m), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(m)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>theta)</span>
<span id="cb15-5"></span>
<span id="cb15-6">negll_censor_weight <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(par, y, X, wt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ul=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>) {</span>
<span id="cb15-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters</span></span>
<span id="cb15-8">  size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> par[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(par)]</span>
<span id="cb15-9">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> par[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(par)]</span>
<span id="cb15-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create indicator depending on chosen limit</span></span>
<span id="cb15-11">  indicator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> ul</span>
<span id="cb15-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># linear predictor</span></span>
<span id="cb15-13">  mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> beta)</span>
<span id="cb15-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># log likelihood</span></span>
<span id="cb15-15">  ll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(wt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(indicator <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnbinom</span>(y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span>mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span>size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log=</span>T)</span>
<span id="cb15-16">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>indicator) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnbinom</span>(ul, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span>mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span>size))), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm=</span>T)</span>
<span id="cb15-17"></span>
<span id="cb15-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>ll)</span>
<span id="cb15-19">}</span>
<span id="cb15-20"></span>
<span id="cb15-21">fit2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span>init,</span>
<span id="cb15-22">            negll_censor_weight,</span>
<span id="cb15-23">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contacts,</span>
<span id="cb15-24">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> X,</span>
<span id="cb15-25">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">wt =</span> dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>wt,</span>
<span id="cb15-26">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ul =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>,</span>
<span id="cb15-27">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb15-28">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-10</span>))</span>
<span id="cb15-29"></span>
<span id="cb15-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(fit2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       (Intercept)         age_grp5-9       age_grp10-14       age_grp15-19 
         5.6120605          1.4242420          1.7386774          1.7031201 
      age_grp20-29       age_grp30-39       age_grp40-49       age_grp50-59 
         1.4590198          1.4488638          1.3920936          1.3145593 
      age_grp60-69         age_grp70+     age_grpMissing            genderM 
         1.0690678          0.8092529          0.9944973          0.9919151 
     genderMissing    dayofweekMonday   dayofweekTuesday dayofweekWednesday 
         1.0153858          1.3261171          1.3904167          1.3853431 
 dayofweekThursday    dayofweekFriday  dayofweekSaturday   dayofweekMissing 
         1.4001935          1.4212925          1.1905515          1.2452143 
      hh_size_grp2       hh_size_grp3       hh_size_grp4       hh_size_grp5 
         1.1014090          1.1254771          1.2788309          1.3717150 
     hh_size_grp6+          countryDE          countryFI          countryGB 
         1.4784786          0.6889027          0.9561525          0.9925714 
         countryIT          countryLU          countryNL          countryPL 
         1.6631404          1.4198698          1.3256452          1.3635879 
              size 
        17.7725195 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">da <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb17-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parm=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"0-4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5-9"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10-14"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"15-19"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"20-29"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30-39"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40-49"</span>, </span>
<span id="cb17-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"50-59"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"60-69"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"70+"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span>, </span>
<span id="cb17-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span>,</span>
<span id="cb17-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"6+"</span>,</span>
<span id="cb17-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sunday"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Monday"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tuesday"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Wednesday"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Thursday"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Friday"</span>, </span>
<span id="cb17-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Saturday"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Missing"</span>,</span>
<span id="cb17-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DE"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FI"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GB"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"IT"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LU"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NL"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PL"</span>),</span>
<span id="cb17-9"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">est =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.42</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.73</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.68</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.45</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.45</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.38</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.31</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.06</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.81</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.91</span>, </span>
<span id="cb17-10">        <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.57</span>, </span>
<span id="cb17-11">        <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.17</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.20</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.36</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.46</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.56</span>,</span>
<span id="cb17-12">        <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.33</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.39</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.38</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.41</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.43</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.20</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.24</span>,</span>
<span id="cb17-13">        <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.70</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.94</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.66</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.42</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.34</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.37</span>))</span>
<span id="cb17-14"></span>
<span id="cb17-15">da<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>myest <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(fit2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>], </span>
<span id="cb17-16">             <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(fit2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>],</span>
<span id="cb17-17">             <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(fit2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>],</span>
<span id="cb17-18">             <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(fit2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>],</span>
<span id="cb17-19">             <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.00</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(fit2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb17-20">da</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        parm  est myest
1        0-4 1.00  1.00
2        5-9 1.42  1.42
3      10-14 1.73  1.74
4      15-19 1.68  1.70
5      20-29 1.45  1.46
6      30-39 1.45  1.45
7      40-49 1.38  1.39
8      50-59 1.31  1.31
9      60-69 1.06  1.07
10       70+ 0.81  0.81
11   Missing 0.91  0.99
12         F 1.00  1.00
13         M 0.99  0.99
14   Missing 1.57  1.02
15         1 1.00  1.00
16         2 1.17  1.10
17         3 1.20  1.13
18         4 1.36  1.28
19         5 1.46  1.37
20        6+ 1.56  1.48
21    Sunday 1.00  1.00
22    Monday 1.33  1.33
23   Tuesday 1.39  1.39
24 Wednesday 1.38  1.39
25  Thursday 1.41  1.40
26    Friday 1.43  1.42
27  Saturday 1.20  1.19
28   Missing 1.24  1.25
29        BE 1.00  1.00
30        DE 0.70  0.69
31        FI 0.94  0.96
32        GB 0.99  0.99
33        IT 1.66  1.66
34        LU 1.42  1.42
35        NL 1.34  1.33
36        PL 1.37  1.36</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>regression</category>
  <category>contact</category>
  <category>censor</category>
  <guid>https://kimfinale.github.io/myblog/posts/nb-censored-regression/index.html</guid>
  <pubDate>Wed, 01 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/nb-censored-regression/POLYMOD_Table1.png" medium="image" type="image/png" height="123" width="144"/>
</item>
<item>
  <title>Apartment transactions in Korea via API provided by the Ministry of Land, Infrastructure, and Transport</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/apartment-data-api/index.html</link>
  <description><![CDATA[ 




<section id="data-preparation" class="level3">
<h3 class="anchored" data-anchor-id="data-preparation">Data preparation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(XML)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(RCurl)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># service_key &lt;- readRDS("data/apartment_key_datagokr.rds")</span></span>
<span id="cb1-6">service_key <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"apartment_key_datagokr.rds"</span>)</span>
<span id="cb1-7">datlist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># combine the data in 2022</span></span>
<span id="cb1-10"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (m <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>){</span>
<span id="cb1-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) {</span>
<span id="cb1-12">    dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"20220"</span>, m)</span>
<span id="cb1-13">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb1-14">    dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2022"</span>, m)</span>
<span id="cb1-15">  } </span>
<span id="cb1-16">  uri <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"http://openapi.molit.go.kr/OpenAPI_ToolInstallPackage/service/rest/RTMSOBJSvc/getRTMSDataSvcAptTradeDev?LAWD_CD=11110&amp;DEAL_YMD="</span>, dt, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&amp;serviceKey="</span>, service_key)</span>
<span id="cb1-17"></span>
<span id="cb1-18">  xml_doc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xmlTreeParse</span>(uri, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">useInternalNodes =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">encoding =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UTF-8"</span>)</span>
<span id="cb1-19">  root_node <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xmlRoot</span>(xml_doc)</span>
<span id="cb1-20">  xml_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xmlToDataFrame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nodes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getNodeSet</span>(root_node, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'//item'</span>))</span>
<span id="cb1-21"></span>
<span id="cb1-22">  datlist[[m]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xml_data</span>
<span id="cb1-23">}</span>
<span id="cb1-24"></span>
<span id="cb1-25">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rbind'</span>, datlist)</span></code></pre></div>
</div>
<p>I will plot the price</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># million won</span></span>
<span id="cb2-2">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>price <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gsub</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">,'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ê±°ëž˜ê¸ˆì•¡)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb2-3">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>area_sq_meter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ì „ìš©ë©´ì ) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># q</span></span>
<span id="cb2-4">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>area_category <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span></span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(d)) {</span>
<span id="cb2-7">  ar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>area_sq_meter[i]</span>
<span id="cb2-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(ar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>){</span>
<span id="cb2-9">    d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>area_category[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;50"</span></span>
<span id="cb2-10">  }</span>
<span id="cb2-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(ar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>) {</span>
<span id="cb2-12">    d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>area_category[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"50-80"</span></span>
<span id="cb2-13">  }</span>
<span id="cb2-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(ar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> ar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) {</span>
<span id="cb2-15">    d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>area_category[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"80-100"</span></span>
<span id="cb2-16">  }</span>
<span id="cb2-17">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(ar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) {</span>
<span id="cb2-18">    d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>area_category[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;100"</span></span>
<span id="cb2-19">  }</span>
<span id="cb2-20">}</span>
<span id="cb2-21"></span>
<span id="cb2-22">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>area_category <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>area_category, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;50"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"50-80"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"80-100"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&gt;100"</span>))</span>
<span id="cb2-23">                             </span>
<span id="cb2-24">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>levels <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ì¸µ)</span>
<span id="cb2-25"></span>
<span id="cb2-26"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb2-27"></span>
<span id="cb2-28">d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(area_category, price, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>levels)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Area~(m^2)"</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Price (million won)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Levels"</span>)))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Apartment price in Jongno-gu, Seoul, 2022"</span>) </span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/apartment-data-api/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("apt_price.png", width=3.4*1.5, height=2.7*1.5, units="in")</span></span></code></pre></div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>API</category>
  <category>apartment</category>
  <guid>https://kimfinale.github.io/myblog/posts/apartment-data-api/index.html</guid>
  <pubDate>Tue, 31 Oct 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/apartment-data-api/apt_price.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Confidence interval using profile likelihood</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/profile-likelihood/index.html</link>
  <description><![CDATA[ 




<section id="ê°ì—¼ë³‘-ìˆ˜ë¦¬-ëª¨í˜•-ëª¨ìˆ˜parameterì˜-ì‹ ë¢°êµ¬ê°„-confidence-intervalêµ¬í•˜ê¸°---profile-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="ê°ì—¼ë³‘-ìˆ˜ë¦¬-ëª¨í˜•-ëª¨ìˆ˜parameterì˜-ì‹ ë¢°êµ¬ê°„-confidence-intervalêµ¬í•˜ê¸°---profile-likelihood">ê°ì—¼ë³‘ ìˆ˜ë¦¬ ëª¨í˜• ëª¨ìˆ˜(parameter)ì˜ ì‹ ë¢°êµ¬ê°„ (confidence interval)êµ¬í•˜ê¸° - profile likelihood</h3>
<p>ìˆ˜ë¦¬ ëª¨í˜•ì„ ì´ìš©í•˜ì—¬ ì—°êµ¬ë¥¼ í•˜ê²Œë˜ë©´ ê´€ì°°ê°’ì„ ì´ìš©í•˜ì—¬ ëª¨í˜•ì˜ ëª¨ìˆ˜ë¥¼ ë³´ì •í•˜ëŠ” ê³¼ì •ì„ ê±°ì¹˜ê²Œ ëœë‹¤. ì´ ê³¼ì •ì„ ì†Œìœ„ ê²°ê³¼ (ê´€ì°°ê°’)ë¡œ ë¶€í„° ì›ì¸ (ëª¨í˜•)ì„ ì•Œì•„ë‚´ëŠ” ê³¼ì •ì´ë¼ í•˜ì—¬ inverse problem ì´ë¼ ë¶€ë¥´ê¸°ë„ í•œë‹¤. ì´ ê¸€ì—ì„œëŠ” <img src="https://latex.codecogs.com/png.latex?SEIR"> ëª¨í˜•ê³¼ ì¤‘êµ­ ìš°í•œ ì—ì„œì˜ ì´ˆê¸° ì½”ë¡œë‚˜-19 ë°œì—´ìž ìžë£Œë¥¼ ì´ìš©í•˜ì—¬ ëª¨í˜•ì˜ ëª¨ìˆ˜ (ê¸°ì´ˆìž¬ê°ì—¼ì§€ìˆ˜)ì™€ ì‹ ë¢°êµ¬ê°„ì„ êµ¬í•´ë³¸ë‹¤. ëª¨ìˆ˜ëŠ” í‘¸ì•„ì†¡ (Poisson) ë¶„í¬ë¥¼ ì´ìš©í•œ ìµœëŒ€ ìš°ë„ (maximum likelihood) ë°©ë²•ìœ¼ë¡œ ê·¸ë¦¬ê³  ì‹ ë¢°êµ¬ê°„ì€ profile likelihood ë°©ë²•ì„ ì‚¬ìš©í•œë‹¤.<br>
ì•„ëž˜ì— SEIR ëª¨í˜•ì˜ R ì½”ë“œëŠ” ì´ì „ì— ì‚¬ìš©í–ˆë˜ ëª¨í˜•ì— ë³€ìˆ˜ <img src="https://latex.codecogs.com/png.latex?C">ë¥¼ ì¶”ê°€í•˜ì˜€ëŠ”ë° ì´ëŠ” ëˆ„ì  ë°œì—´ìžìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ê³  ì¼ë³„ ë°œì—´ìž ìˆ˜ë¥¼ ì‰½ê²Œ êµ¬í•˜ê¸° ìœ„í•¨ì´ë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ODE-based SEIR model</span></span>
<span id="cb1-2">seir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(t, y, params) {</span>
<span id="cb1-3">  S <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]; E <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]; I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]; R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]; C <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span>
<span id="cb1-4">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>]</span>
<span id="cb1-5">  sigma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma"</span>]</span>
<span id="cb1-6">  gamma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> params[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>]</span>
<span id="cb1-7">  </span>
<span id="cb1-8">  muSE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> beta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> E <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> R)</span>
<span id="cb1-9">  muEI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sigma</span>
<span id="cb1-10">  muIR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gamma</span>
<span id="cb1-11">  </span>
<span id="cb1-12">  dS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> muSE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>S</span>
<span id="cb1-13">  dE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  muSE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>S <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> muEI<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>E</span>
<span id="cb1-14">  dI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  muEI<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>E <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> muIR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I</span>
<span id="cb1-15">  dR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  muIR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I</span>
<span id="cb1-16">  dC <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  muEI<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>E <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## cumulative symtom onset</span></span>
<span id="cb1-17">  </span>
<span id="cb1-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(dS, dE, dI, dR, dC)))</span>
<span id="cb1-19">}</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># daily symptomatic case</span></span>
<span id="cb2-2">daily_case <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) { </span>
<span id="cb2-3">  y0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">11e6</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">E =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">C =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initial values (Wuhan population size)</span></span>
<span id="cb2-4">  times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">35</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(params)){</span>
<span id="cb2-6">    params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sigma =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamma =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>)</span>
<span id="cb2-7">  }</span>
<span id="cb2-8">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ode</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> times, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func =</span> seir, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms =</span> params)</span>
<span id="cb2-9">  x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(out) </span>
<span id="cb2-10">  n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(x)</span>
<span id="cb2-11">  daily <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(x[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>]))</span>
<span id="cb2-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span> (daily)</span>
<span id="cb2-13">} </span></code></pre></div>
</div>
<p>ìš°í•œì—ì„œ ë°œìƒí•œ ì´ˆê¸° ì¼ë³„ ì½”ë¡œë‚˜19 í™˜ìžìˆ˜ëŠ” Kucharski et al.&nbsp;(2020) Lancet ì— ë³´ê³ ëœ ìžë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ì˜€ë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">wuhan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2019-12-13"</span>), </span>
<span id="cb3-3">                        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.Date</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2020-01-16"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day"</span>),</span>
<span id="cb3-4">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">case =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb3-5">                      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>))</span></code></pre></div>
</div>
<p>ì¼ë³„ ë°œì—´ìžìˆ˜ <img src="https://latex.codecogs.com/png.latex?y_t">ê°€ í‘¸ì•„ì†¡ ë¶„í¬ë¥¼ ë”°ë¥¸ë‹¤ê³  ê°€ì •í•˜ê³  ìš°ë„ í•¨ìˆ˜ë¥¼ ì•„ëž˜ì™€ ê°™ì´ ì •ì˜ í•œë‹¤.<br>
<img src="https://latex.codecogs.com/png.latex?%20y_t%20%5Csim%20%5Cmathrm%7BPoisson%7D(Y_t)"> <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D(%5Ctheta)%20=%20%5Cprod_%7Bt=1%7D%5E%7Bn%7D%20f(y_t%20%5Cvert%20%5Ctheta)%20=%20%5Cprod_%7Bt=1%7D%5E%7Bn%7D%20%5Cfrac%7BY_t%5E%7By_t%7D%20e%5E%7B-Y_t%7D%7D%7By_t!%7D"></p>
<p>ìš°ë„ ê³„ì‚°ì‹ì„ ì•„ëž˜ì™€ ê°™ì´ Rë¡œ êµ¬í˜„í•  ìˆ˜ ìžˆë‹¤. ë¬¼ë¡  ìš°ë„í•¨ìˆ˜ëŠ” ìˆ˜ì¹˜ ì•ˆì •ì„±ì„ ìœ„í•´ì„œ log ë¥¼ ì·¨í•œ ê°’ì„ ì‚¬ìš©í•˜ê³  (ì¦‰ log likelihood) ìµœì í™” ì•Œê³ ë¦¬ë“¬ì€ ìµœì†Œê°’ì„ ì°¾ê¸° ë•Œë¬¸ì— ìŒì˜ê°’ìœ¼ë¡œ ì¹˜í™˜í•œ negative log likelihoodë¥¼ ì‚¬ìš©í•œë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">negloglik <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(par) {</span>
<span id="cb4-2">  params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta =</span> par, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sigma =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamma =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>)</span>
<span id="cb4-3">  model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">daily_case</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">params =</span> params)</span>
<span id="cb4-4">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dpois</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> wuhan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>case, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda =</span> model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sum of negative log likelihood</span></span>
<span id="cb4-5">}</span></code></pre></div>
</div>
<p>SEIR ëª¨í˜•ì—ëŠ” ì„¸ ê°œì˜ ëª¨ìˆ˜ (<img src="https://latex.codecogs.com/png.latex?%5Cbeta,%20%5Csigma,%20%5Cgamma">)ê°€ ìžˆëŠ”ë° <img src="https://latex.codecogs.com/png.latex?%5Csigma,%20%5Cgamma">ëŠ” ê°ê° ìž ë³µê¸°ì™€ íšŒë³µê¹Œì§€ ê±¸ë¦¬ëŠ” ì‹œê°„ì„ ë‚˜íƒ€ë‚´ê³  í™˜ìžë“¤ì„ ê´€ì°°í•˜ì—¬ ê·¸ ê°’ì„ ì¶”ì •í•  ìˆ˜ ìžˆëŠ” ê²½ìš°ê°€ ë§Žë‹¤. ì´ì— ë°˜í•´ <img src="https://latex.codecogs.com/png.latex?%5Cbeta">ëŠ” ìˆ˜ë¦¬ ëª¨í˜•ì˜ ì˜ˆì¸¡ê°’ì„ ê´€ì°°ëœ ìœ í–‰ ê³¡ì„ ê³¼ ë¹„êµí•˜ì—¬ ì¶”ì •í•œë‹¤. ì´ ê³¼ì •ì´ negloglik í•¨ìˆ˜ì— êµ¬í˜„ëœ ê²ƒì´ê³  <code>optim</code> í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ negloglikë¥¼ ìµœì†Œí™”í•˜ëŠ” <img src="https://latex.codecogs.com/png.latex?%5Cbeta">ë¥¼ êµ¬í•œë‹¤.<br>
<img src="https://latex.codecogs.com/png.latex?%20%5Chat%7B%5Ctheta%7D%20=%20%5Cunderset%7B%5Ctheta%7D%7B%5Cmathrm%7Bargmax%7D%7D~%5C%7B%7B%5Cmathrm%7Blog%7D%20%5Cmathcal%7BL%7D(%5Ctheta)%7D%20%5C%7D"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(deSolve) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># negloglik includes ODE model to be integrated using deSolve</span></span>
<span id="cb5-2">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(negloglik, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Brent"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb5-3">(theta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5735032</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">gamma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>; (R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> theta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>gamma)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.580765</code></pre>
</div>
</div>
<p>95% ì‹ ë¢° êµ¬ê°„ì€ Log likelihood ê°€ asymptotically ì•„ëž˜ì˜ ì¡°ê±´ì„ ë§Œì¡±í•œë‹¤ëŠ” ì‚¬ì‹¤ì„ ì´ìš©í•˜ì—¬ ê³„ì‚°í•  ìˆ˜ ìžˆë‹¤ (Wilksâ€™ theorem). <img src="https://latex.codecogs.com/png.latex?%202%20(%5Cmathrm%20%7Blog%7D%20%5Cmathcal%20%7BL%7D%20(%5Chat%7B%5Ctheta%7D)%20-%20%5Cmathrm%7Blog%7D%5Cmathcal%7BL%7D(%5Ctheta_0))%20%5Csim%20%5Cchi%5E2_1"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">prof_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand.grid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>))</span>
<span id="cb9-2">prof_b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>loglik <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(prof_b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b, negloglik)</span>
<span id="cb9-3">maxloglik <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>value</span>
<span id="cb9-4">cutoff <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> maxloglik <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qchisq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb9-5">(limits <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">range</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(prof_b, loglik <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> cutoff)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 95% confidence interval</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5518519 0.5940941</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb11-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb11-3">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>()</span>
<span id="cb11-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb11-5">prof_b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(b,loglik))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span>fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span>limits, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept=</span>maxloglik, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept=</span>cutoff, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(maxloglik<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-6</span>, maxloglik<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(beta), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Log likelihood"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/profile-likelihood/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("profile_lik.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>
<p><code>bbmle</code> íŒ¨í‚¤ì§€ëŠ” <code>confint</code> í•¨ìˆ˜ë¡œ profile likelihoodë¥¼ ì´ìš©í•˜ì—¬ ì‹ ë¢°êµ¬ê°„ì„ êµ¬í•˜ëŠ” ë°©ë²•ì„ ì œê³µí•´ì¤€ë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(bbmle)</span>
<span id="cb13-2">bbfit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mle2</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">minuslogl=</span>negloglik, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L-BFGS-B"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>))</span>
<span id="cb13-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">confint</span>(bbfit)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2.5 %    97.5 % 
0.5517962 0.5942085 </code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>SEIR</category>
  <category>profile likelihood</category>
  <category>likelihood ratio</category>
  <guid>https://kimfinale.github.io/myblog/posts/profile-likelihood/index.html</guid>
  <pubDate>Wed, 18 Oct 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/profile-likelihood/profile_lik.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>SIR model using SymPy</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/SIR-sympy/index.html</link>
  <description><![CDATA[ 




<p>I attempted to replicate some of the simple analytical resutls presented in the book, Mathematical Epidemiology by Brauer <em>et al</em>.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Cmathrm%7Bd%7DS/%5Cmathrm%7Bd%7Dt%20&amp;=%20-%5Cbeta%20I%20S%20%5C%5C%0A%5Cmathrm%7Bd%7DI/%5Cmathrm%7Bd%7Dt%20&amp;=%20%5Cbeta%20I%20S%20-%20%5Cgamma%20I%5C%5C%0A%5Cend%7Balign%7D%0A"> The first part is simply to compute <img src="https://latex.codecogs.com/png.latex?dI/dS">.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sympy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-2"></span>
<span id="cb1-3">R_0, b, g, dIdt, dSdt, S, I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'R_0 b g dIdt dSdt S I'</span>)</span>
<span id="cb1-4"></span>
<span id="cb1-5">dSdt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I</span>
<span id="cb1-6">dIdt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I</span>
<span id="cb1-7">dSdI <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dIdt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> dSdt <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#-(I*S*b - I*g)/(I*S*b)</span></span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># b &lt;- R0*g</span></span>
<span id="cb1-10">simplify(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(I<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R_0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> I<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>g)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(I<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>R_0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>g)) </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-1 + 1/(R_0*S)</code></pre>
</div>
</div>
<p>The second part is integrate the equation, <img src="https://latex.codecogs.com/png.latex?dI/dS"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">S, I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S I"</span>, cls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Function)</span>
<span id="cb3-2">b, g, t, R_0, S0, I0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b g t R_0 S0 I0"</span>)</span>
<span id="cb3-3"></span>
<span id="cb3-4">eq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Eq(I(t).diff(t), <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> S(t).diff(t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R_0)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>S(t))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>S(t).diff(t))</span>
<span id="cb3-5"></span>
<span id="cb3-6">integrate(eq, t)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Eq(I(t), -S(t) + log(S(t))/R_0)</code></pre>
</div>
</div>



 ]]></description>
  <category>SIR</category>
  <category>SymPy</category>
  <guid>https://kimfinale.github.io/myblog/posts/SIR-sympy/index.html</guid>
  <pubDate>Sun, 15 Oct 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/SIR-sympy/SimPy_logo.svg.png" medium="image" type="image/png" height="55" width="144"/>
</item>
<item>
  <title>Regression with censored data: AER::tobit and optim</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/censored-regression-optim/index.html</link>
  <description><![CDATA[ 




<p>The following example was adapted from the Tobit model in <a href="https://m-clark.github.io/models-by-example/tobit.html">Model Estimation by Example</a>. The dataset contains 200 observations. The academic aptitude variable is <code>apt</code>, the reading and math test scores are <code>read</code> and <code>math</code>, respectively. The variable <code>prog</code> is the type of program the student is in, it is a categorical (nominal) variable that takes on three values, academic (prog = 1), general (prog = 2), and vocational (prog = 3). The variable <code>id</code> is an identification variable. More details of the dataset available at https://stats.oarc.ucla.edu/r/dae/tobit-models/.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb1-2">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://stats.idre.ucla.edu/stat/data/tobit.csv"</span>)</span>
<span id="cb1-3">dat[, prog <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(prog)]</span>
<span id="cb1-4">dat</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      id read math       prog apt
  1:   1   34   40 vocational 352
  2:   2   39   33 vocational 449
  3:   3   63   48    general 648
  4:   4   44   41    general 501
  5:   5   47   43    general 762
 ---                             
196: 196   44   49    general 539
197: 197   50   50    general 594
198: 198   47   51    general 616
199: 199   52   50    general 558
200: 200   68   75    general 800</code></pre>
</div>
</div>
<p>Following codes were borrowed from the <a href="https://stats.oarc.ucla.edu/r/dae/tobit-models/">UCLA Advanced Research Computing</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function that gives the density of normal distribution</span></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for given mean and sd, scaled to be on a count metric</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for the histogram: count = density * sample size * bin width</span></span>
<span id="cb3-4">f <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, var, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bw =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>) {</span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(var), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(var)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(var) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bw</span>
<span id="cb3-6">}</span>
<span id="cb3-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># setup base plot</span></span>
<span id="cb3-9">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(dat, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> apt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>prog))</span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># histogram, coloured by proportion in different programs</span></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># with a normal distribution overlayed</span></span>
<span id="cb3-12">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_bin</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stat_function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fun =</span> f, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb3-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">args =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var =</span> dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>apt))</span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"apt_censored.png"</span>, p)</span></code></pre></div>
</div>
<p>Looking at the above histogram, we can see the censoring in the values of <code>apt</code>, that is, there are far more cases with scores of 750 to 800 than one would expect looking at the rest of the distribution. Below is an alternative histogram that further highlights the excess of cases where <code>apt=800</code>.</p>
<p><strong>Note on the difference between truncation and censoring</strong>: With censored variables, all of the observations are in the dataset, but we donâ€™t know the â€œtrueâ€ values of some of them. With truncation some of the observations are not included in the analysis because of the value of the variable.</p>
<p>The Tobit model can be used for such a case. It is a class of regression models in which the observed range of the dependent variable is censored in some way, according to the [Wikipedia article] (https://en.wikipedia.org/wiki/Tobit_model). The possible maximum score 800, which</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">tobit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> AER<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tobit</span>(</span>
<span id="cb4-2">  apt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> read <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> math <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> prog,</span>
<span id="cb4-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dat,</span>
<span id="cb4-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">left =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>,</span>
<span id="cb4-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">right =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span></span>
<span id="cb4-6">)</span></code></pre></div>
</div>
<p>To account for censoring, likelihood function is modified to so that it reflects the unequal sampling probability for each observation depending on whether the latent dependent variable fell above or below the determined threshold. It appears that this approach was first proposed by <a href="https://en.wikipedia.org/wiki/James_Tobin">James Tobin</a>. For a sample that, as in Tobinâ€™s original case, was censored from below at zero, the sampling probability for each non-limit observation is simply the height of the appropriate density function. For any limit observation, it is the cumulative distribution, i.e.&nbsp;the integral below zero of the appropriate density function. The likelihood function is thus a mixture of densities and cumulative distribution functions, according to the <a href="https://en.wikipedia.org/wiki/Tobit_model">Wikipedia article</a>.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Blog%20%7DL%20=%20%5Csum_%7Bi=1%7D%5En%20w_i%5Cleft(%5Cdelta_i~%5Ctext%7Blog%7D%20%5Cleft(P%5Cleft(Y=y_i%7CX%5Cright)%5Cright)%20+%20%5Cleft(1-%5Cdelta_i%5Cright)~%5Ctext%7Blog%7D%20%5Cleft(1-%5Csum_%7Bi=1%7D%5E%7Bl_U%7DP(Y=y_i%7CX)%5Cright)%0A%5Cright)%0A"> , where <img src="https://latex.codecogs.com/png.latex?l_U"> represents the upper limit and</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bequation%7D%0A%20%20%5Cdelta_i=%5Cbegin%7Bcases%7D%0A%20%20%20%201,%20&amp;%20%5Ctext%7Bif%20%7Dy_i%20%3C%20l_U.%5C%5C%0A%20%20%20%200,%20&amp;%20%5Ctext%7Botherwise%7D.%0A%20%20%5Cend%7Bcases%7D%0A%5Cend%7Bequation%7D%0A"></p>
<section id="log-likelihood-accounting-for-censoring" class="level3">
<h3 class="anchored" data-anchor-id="log-likelihood-accounting-for-censoring">Log likelihood accounting for censoring</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">negloglik <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(par, y, X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ul=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>) {</span>
<span id="cb5-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters</span></span>
<span id="cb5-3">  sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> par[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(par)]</span>
<span id="cb5-4">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> par[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(par)]</span>
<span id="cb5-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create indicator depending on chosen limit</span></span>
<span id="cb5-6">  indicator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> ul</span>
<span id="cb5-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># linear predictor</span></span>
<span id="cb5-8">  mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> beta</span>
<span id="cb5-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># log likelihood</span></span>
<span id="cb5-10">  loglik <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> indicator <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span>mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log=</span>T) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-11">             (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>indicator) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(ul, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span>mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sd))</span>
<span id="cb5-12"></span>
<span id="cb5-13">  sumloglik <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(loglik, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm=</span>T)</span>
<span id="cb5-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>sumloglik)</span>
<span id="cb5-15">}</span></code></pre></div>
</div>
</section>
<section id="optim" class="level3">
<h3 class="anchored" data-anchor-id="optim">optim</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Setup data and initial values.</span></span>
<span id="cb6-2">mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(apt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> read <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> math <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> prog, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dat)</span>
<span id="cb6-3">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(mod)</span>
<span id="cb6-4">init <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(mod), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sigma=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(mod)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma)</span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># negloglik(par=init, y=acad_apt$apt, X=X, ul=800)</span></span>
<span id="cb6-7"></span>
<span id="cb6-8">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par =</span> init,</span>
<span id="cb6-9">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn =</span> negloglik,</span>
<span id="cb6-10">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>apt,</span>
<span id="cb6-11">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> X,</span>
<span id="cb6-12">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ul =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>)</span>
<span id="cb6-13"></span>
<span id="cb6-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(tobit)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   (Intercept)           read           math    proggeneral progvocational 
    209.565971       2.697939       5.914485     -12.714763     -46.143904 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">(fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   (Intercept)           read           math    proggeneral progvocational 
    211.054867       2.813491       5.763177     -12.354492     -45.847701 
         sigma 
     65.652919 </code></pre>
</div>
</div>
</section>
<section id="optim-control-parameters" class="level3">
<h3 class="anchored" data-anchor-id="optim-control-parameters"><code>optim</code> control parameters</h3>
<p>By adjusting control parameters of the <code>optim</code> function, results can match more closely. Below is such an example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par =</span> init,</span>
<span id="cb10-2">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn =</span> negloglik,</span>
<span id="cb10-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>apt,</span>
<span id="cb10-4">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X =</span> X,</span>
<span id="cb10-5">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ul =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>,</span>
<span id="cb10-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb10-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span>
<span id="cb10-8"></span>
<span id="cb10-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(tobit)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   (Intercept)           read           math    proggeneral progvocational 
    209.565971       2.697939       5.914485     -12.714763     -46.143904 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">(fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   (Intercept)           read           math    proggeneral progvocational 
    209.565967       2.697937       5.914486     -12.714777     -46.143838 
         sigma 
     65.676724 </code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>regression</category>
  <category>censor</category>
  <category>tobit</category>
  <guid>https://kimfinale.github.io/myblog/posts/censored-regression-optim/index.html</guid>
  <pubDate>Sat, 14 Oct 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/censored-regression-optim/apt_censored.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Mulitple regression: POLYMOD data</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/POLYMOD-multiple-regression/index.html</link>
  <description><![CDATA[ 




<p>This post describes my attempt to reproduce Table 1 of the paper, <a href="https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0050074">Social Contacts and Mixing Patterns Relevant to the Spread of Infectious Diseases</a>. Data were downloaded from <a href="http://www.socialcontactdata.org/">Social Contact Data</a>, which was hosted in <a href="https://zenodo.org/record/3746312#.Xo85CcgzZPY">zenodo</a>. I used the version 1.1. In summary, I wasnâ€™t successful at reproducing the table exatly but still wanted to document the processes that I went through.</p>
<section id="data-preparation" class="level3">
<h3 class="anchored" data-anchor-id="data-preparation">Data preparation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb1-2"></span>
<span id="cb1-3">d1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2008_Mossong_POLYMOD_participant_common.csv"</span>)</span>
<span id="cb1-4">d2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2008_Mossong_POLYMOD_contact_common.csv"</span>)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count the number of contacts for each participant using part_id variable</span></span>
<span id="cb1-7">d2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(part_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">contacts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>()) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> d2_contacts</span>
<span id="cb1-9">d12 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(d1, d2_contacts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"part_id"</span>)</span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add household information</span></span>
<span id="cb1-11">d3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2008_Mossong_POLYMOD_hh_common.csv"</span>)</span>
<span id="cb1-12">d123 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(d12, d3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hh_id"</span>)</span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add day of week information</span></span>
<span id="cb1-14">d4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fread</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2008_Mossong_POLYMOD_sday.csv"</span>)</span>
<span id="cb1-15">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(d123, d4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"part_id"</span>)</span></code></pre></div>
</div>
</section>
<section id="data-manipulation" class="level3">
<h3 class="anchored" data-anchor-id="data-manipulation">Data manipulation</h3>
<p>Categorize the age group into different 10 age groups: 0-4, 5-9, 10-14, 15-19, and 20 to 70 by 10 years and 70 and above</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">classify_age <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d){</span>
<span id="cb2-2">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span></span>
<span id="cb2-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(d)) {</span>
<span id="cb2-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i])){</span>
<span id="cb2-5">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>){</span>
<span id="cb2-6">        d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb2-7">      }</span>
<span id="cb2-8">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>){</span>
<span id="cb2-9">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(j <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb2-10">          <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>j <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>j<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)){</span>
<span id="cb2-11">            d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> j</span>
<span id="cb2-12">          }</span>
<span id="cb2-13">        }</span>
<span id="cb2-14">      }</span>
<span id="cb2-15">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>){</span>
<span id="cb2-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (k <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>){</span>
<span id="cb2-17">          <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_age[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>k)){</span>
<span id="cb2-18">            d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> k<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb2-19">          }</span>
<span id="cb2-20">        }</span>
<span id="cb2-21">      } </span>
<span id="cb2-22">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb2-23">        d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb2-24">      }</span>
<span id="cb2-25">    } </span>
<span id="cb2-26">  }</span>
<span id="cb2-27">  d</span>
<span id="cb2-28">}</span>
<span id="cb2-29"></span>
<span id="cb2-30">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classify_age</span>(dat)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb3-2">dat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>contacts)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/POLYMOD-multiple-regression/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Compare the number of participants by age group (the third column)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">dat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(age_grp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">npart=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">n</span>(),</span>
<span id="cb4-4">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">avg_contacts =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(contacts, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm=</span>T) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> npart, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> dat_ag</span>
<span id="cb4-5"></span>
<span id="cb4-6">dat_ag<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>npart_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">660</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">661</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">713</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">685</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">879</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">815</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">908</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">906</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">728</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">270</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>)</span>
<span id="cb4-7">dat_ag<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>avg_contacts_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.21</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">14.81</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">18.22</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">17.58</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">13.57</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">14.14</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">13.83</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">12.30</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.21</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.89</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.63</span>)</span>
<span id="cb4-8">dat_ag</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 Ã— 5
   age_grp npart avg_contacts npart_true avg_contacts_true
     &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt;      &lt;dbl&gt;             &lt;dbl&gt;
 1       0   660        10.2         660             10.2 
 2       1   661        14.8         661             14.8 
 3       2   713        18.2         713             18.2 
 4       3   685        17.6         685             17.6 
 5       4   879        13.6         879             13.6 
 6       5   815        14.1         815             14.1 
 7       6   908        13.8         908             13.8 
 8       7   906        12.3         906             12.3 
 9       8   728         9.21        728              9.21
10       9   270         6.89        270              6.89
11      99    65         9.63         65              9.63</code></pre>
</div>
</div>
<p>Categorize the household size</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">classify_hh <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d){</span>
<span id="cb6-2">  d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size), d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>))</span>
<span id="cb6-3">  d</span>
<span id="cb6-4">}</span>
<span id="cb6-5">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">classify_hh</span>(dat)</span></code></pre></div>
</div>
<p>Make categorical variables factor for regression</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the categorical variables as factor for regression</span></span>
<span id="cb7-2">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age_grp)</span>
<span id="cb7-3">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size_grp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hh_size_grp)</span>
<span id="cb7-4">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>gender <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>part_gender)</span>
<span id="cb7-5">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dayofweek)</span>
<span id="cb7-6">data.table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fwrite</span>(dat, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"POLYMOD_2017.csv"</span>)</span></code></pre></div>
</div>
</section>
<section id="data-for-fitting-only-complete-cases" class="level3">
<h3 class="anchored" data-anchor-id="data-for-fitting-only-complete-cases">data for fitting only complete cases</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">dat_ <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dat</span>
<span id="cb8-2">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dat[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">complete.cases</span>(dat),]</span>
<span id="cb8-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the maximum number of contacts 29</span></span>
<span id="cb8-4">dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contacts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contacts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>, dat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contacts)</span></code></pre></div>
</div>
</section>
<section id="negbin-regression" class="level3">
<h3 class="anchored" data-anchor-id="negbin-regression">NegBin regression</h3>
<p>Negative binomial regression was modeled using <code>MASS::glm.nb</code> function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(MASS)</span>
<span id="cb9-2">m1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm.nb</span>(contacts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age_grp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dat)</span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(m1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = contacts ~ age_grp, data = dat, init.theta = 2.895747992, 
    link = log)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)  2.30861    0.02626  87.919  &lt; 2e-16 ***
age_grp1     0.32714    0.03648   8.967  &lt; 2e-16 ***
age_grp2     0.49578    0.03556  13.943  &lt; 2e-16 ***
age_grp3     0.46119    0.03600  12.812  &lt; 2e-16 ***
age_grp4     0.24010    0.03442   6.975 3.05e-12 ***
age_grp5     0.28582    0.03483   8.206 2.29e-16 ***
age_grp6     0.24679    0.03418   7.220 5.21e-13 ***
age_grp7     0.14499    0.03429   4.228 2.35e-05 ***
age_grp8    -0.09882    0.03656  -2.703  0.00687 ** 
age_grp9    -0.36270    0.05032  -7.208 5.66e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(2.8957) family taken to be 1)

    Null deviance: 8055.6  on 7068  degrees of freedom
Residual deviance: 7390.5  on 7059  degrees of freedom
AIC: 47802

Number of Fisher Scoring iterations: 1

              Theta:  2.8957 
          Std. Err.:  0.0597 

 2 x log-likelihood:  -47780.1930 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(m1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    age_grp1    age_grp2    age_grp3    age_grp4    age_grp5 
 10.0604651   1.3869981   1.6417727   1.5859529   1.2713769   1.3308557 
   age_grp6    age_grp7    age_grp8    age_grp9 
  1.2799167   1.1560315   0.9059023   0.6957929 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">m5 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm.nb</span>(contacts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age_grp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> gender <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hh_size_grp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dayofweek, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> dat)</span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(m5)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm.nb(formula = contacts ~ age_grp + gender + hh_size_grp + 
    country + dayofweek, data = dat, init.theta = 3.763576898, 
    link = log)

Coefficients:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   1.75583    0.19669   8.927  &lt; 2e-16 ***
age_grp1      0.30090    0.03321   9.060  &lt; 2e-16 ***
age_grp2      0.45196    0.03238  13.956  &lt; 2e-16 ***
age_grp3      0.44934    0.03271  13.738  &lt; 2e-16 ***
age_grp4      0.31340    0.03190   9.824  &lt; 2e-16 ***
age_grp5      0.31068    0.03213   9.668  &lt; 2e-16 ***
age_grp6      0.27568    0.03146   8.763  &lt; 2e-16 ***
age_grp7      0.21717    0.03260   6.661 2.72e-11 ***
age_grp8      0.03470    0.03617   0.959 0.337387    
age_grp9     -0.19923    0.04890  -4.074 4.62e-05 ***
genderF      -0.01755    0.19240  -0.091 0.927340    
genderM      -0.02768    0.19241  -0.144 0.885592    
hh_size_grp2  0.09645    0.02827   3.412 0.000646 ***
hh_size_grp3  0.11854    0.02964   3.999 6.36e-05 ***
hh_size_grp4  0.22913    0.02979   7.692 1.45e-14 ***
hh_size_grp5  0.30497    0.03213   9.492  &lt; 2e-16 ***
countryDE    -0.31802    0.02839 -11.202  &lt; 2e-16 ***
countryFI    -0.01234    0.02921  -0.423 0.672627    
countryGB     0.02936    0.02918   1.006 0.314328    
countryIT     0.43331    0.02960  14.637  &lt; 2e-16 ***
countryLU     0.28600    0.02862   9.994  &lt; 2e-16 ***
countryNL     0.20892    0.04306   4.851 1.23e-06 ***
countryPL     0.25610    0.02860   8.956  &lt; 2e-16 ***
dayofweek1    0.27813    0.02810   9.898  &lt; 2e-16 ***
dayofweek2    0.32401    0.02758  11.747  &lt; 2e-16 ***
dayofweek3    0.31329    0.02812  11.140  &lt; 2e-16 ***
dayofweek4    0.31717    0.02774  11.434  &lt; 2e-16 ***
dayofweek5    0.34216    0.02745  12.465  &lt; 2e-16 ***
dayofweek6    0.14626    0.02887   5.066 4.07e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for Negative Binomial(3.7636) family taken to be 1)

    Null deviance: 9794.6  on 7068  degrees of freedom
Residual deviance: 7372.6  on 7040  degrees of freedom
AIC: 46396

Number of Fisher Scoring iterations: 1

              Theta:  3.7636 
          Std. Err.:  0.0843 

 2 x log-likelihood:  -46336.2000 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(m5<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)     age_grp1     age_grp2     age_grp3     age_grp4     age_grp5 
   5.7882277    1.3510687    1.5713835    1.5672725    1.3680647    1.3643573 
    age_grp6     age_grp7     age_grp8     age_grp9      genderF      genderM 
   1.3174272    1.2425566    1.0353045    0.8193574    0.9826079    0.9726948 
hh_size_grp2 hh_size_grp3 hh_size_grp4 hh_size_grp5    countryDE    countryFI 
   1.1012549    1.1258570    1.2575100    1.3565872    0.7275872    0.9877342 
   countryGB    countryIT    countryLU    countryNL    countryPL   dayofweek1 
   1.0297905    1.5423491    1.3310865    1.2323420    1.2918884    1.3206527 
  dayofweek2   dayofweek3   dayofweek4   dayofweek5   dayofweek6 
   1.3826643    1.3679193    1.3732405    1.4079890    1.1575004 </code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>regression</category>
  <category>contact</category>
  <guid>https://kimfinale.github.io/myblog/posts/POLYMOD-multiple-regression/index.html</guid>
  <pubDate>Wed, 11 Oct 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/POLYMOD-multiple-regression/polymod-age-contact.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Regression using optim</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/nb-regression-optim/index.html</link>
  <description><![CDATA[ 




<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>I will use the <code>cars</code> data with give the speed of cars and the distances taken to stop.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> datasets<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>cars</span>
<span id="cb1-2">m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(dist <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> speed, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>d)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(m)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = dist ~ speed, data = d)

Residuals:
    Min      1Q  Median      3Q     Max 
-29.069  -9.525  -2.272   9.215  43.201 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -17.5791     6.7584  -2.601   0.0123 *  
speed         3.9324     0.4155   9.464 1.49e-12 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 15.38 on 48 degrees of freedom
Multiple R-squared:  0.6511,    Adjusted R-squared:  0.6438 
F-statistic: 89.57 on 1 and 48 DF,  p-value: 1.49e-12</code></pre>
</div>
</div>
</section>
<section id="plot" class="level3">
<h3 class="anchored" data-anchor-id="plot">Plot</h3>
<p>Plot estimates with confidence and prediction intervals</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prediction"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">level=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prediction interval</span></span>
<span id="cb3-2">conf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"confidence"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">level=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># confidence interval</span></span>
<span id="cb3-3"></span>
<span id="cb3-4">mdat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>model</span>
<span id="cb3-5">mdat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pred_estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pred[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-6">mdat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pred_lb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pred[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb3-7">mdat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pred_ub <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pred[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb3-8">mdat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf_estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conf[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-9">mdat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf_lb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conf[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb3-10">mdat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>conf_ub <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> conf[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span>
<span id="cb3-11"></span>
<span id="cb3-12">mdat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>residuals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">residuals</span>(m)</span>
<span id="cb3-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb3-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb3-17"></span>
<span id="cb3-18">pltcar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mdat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb3-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(speed, dist))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># geom_point(aes(size = abs(m$residuals)))+</span></span>
<span id="cb3-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>pred_estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>pred_ub, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span>pred_lb, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># geom_line(aes(y=conf_estimate), color="steelblue")+</span></span>
<span id="cb3-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>conf_ub, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span>conf_lb, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Speed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distance"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Speed and Stopping Distances of Cars"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>)</span>
<span id="cb3-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"plot_car.png"</span>, pltcar)</span>
<span id="cb3-31">pltcar</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/nb-regression-optim/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="optim-function" class="level3">
<h3 class="anchored" data-anchor-id="optim-function">optim function</h3>
<p>Now letâ€™s take an alternative approach to write down the likelihood function and maximize it using the <code>optim</code> function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define our likelihood function we like to optimize</span></span>
<span id="cb4-2">negloglik <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(par, y, X){</span>
<span id="cb4-3">  sigma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> par[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-4">  beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> par[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(par)]</span>
<span id="cb4-5">  mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> beta </span>
<span id="cb4-6">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean=</span>mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd=</span>sigma, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm=</span>T)</span>
<span id="cb4-7">}</span>
<span id="cb4-8"></span>
<span id="cb4-9">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(m)</span>
<span id="cb4-10">init <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(m), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sigma=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(m)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma)</span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># negloglik(par=init, y=d$y, X=X)</span></span>
<span id="cb4-13">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span>init, </span>
<span id="cb4-14">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>negloglik, </span>
<span id="cb4-15">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>dist, </span>
<span id="cb4-16">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>X, </span>
<span id="cb4-17">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>))</span></code></pre></div>
</div>
<p>Letâ€™s compare the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)       speed       sigma 
 -17.579095    3.932409   15.379587 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(m)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)       speed 
 -17.579095    3.932409 </code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>R</category>
  <category>optim</category>
  <category>regression</category>
  <guid>https://kimfinale.github.io/myblog/posts/nb-regression-optim/index.html</guid>
  <pubDate>Tue, 10 Oct 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/nb-regression-optim/plot_car.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>Extract raster based on a polygon</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/crop-raster-polygon/index.html</link>
  <description><![CDATA[ 




<p>raster ì´ë¯¸ì§€ì˜ ì¼ë¶€ë¥¼ ì¶”ì¶œí•´ë³´ìž. íŠ¹ížˆ, <code>shapefile</code>ì— ë‹´ê²¨ì ¸ ìžˆëŠ” polygonì— í•´ë‹¹í•˜ëŠ” raster ë¥¼ ì¶”ì¶œí•´ë³´ìž. <code>raster</code> íŒ¨í‚¤ì§€ì˜ <code>crop</code> ê³¼ <code>mask</code> í•¨ìˆ˜ë¥¼ ì´ìš©í•  ìˆ˜ ìžˆë‹¤.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create some data using meuse </span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(raster)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(meuse)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coordinates</span>(meuse) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">~</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>y</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">proj4string</span>(meuse) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CRS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+init=epsg:28992"</span>)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(meuse.grid)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coordinates</span>(meuse.grid) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">~</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>y</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">proj4string</span>(meuse.grid) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CRS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"+init=epsg:28992"</span>)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gridded</span>(meuse.grid) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>    </span>
<span id="cb1-10">r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">raster</span>(meuse.grid) </span>
<span id="cb1-11">r[] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncell</span>(r))</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a polygon</span></span>
<span id="cb1-14">f <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rgeos<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gBuffer</span>(meuse[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byid=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>, </span>
<span id="cb1-15">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">joinStyle=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ROUND"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quadsegs=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)   </span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot full raster and polygon                       </span></span>
<span id="cb1-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(r)</span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(f,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">add=</span>T)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/crop-raster-polygon/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Crop using extent, rasterize polygon and finally, create poly-raster</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#          **** This is the code that you are after ****  </span></span>
<span id="cb2-3">cr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">crop</span>(r, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extent</span>(f), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">snap=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"out"</span>)                    </span>
<span id="cb2-4">fr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rasterize</span>(f, cr)   </span>
<span id="cb2-5">lr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mask</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>cr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mask=</span>fr)</span>
<span id="cb2-6"></span>
<span id="cb2-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot results</span></span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(lr)</span>
<span id="cb2-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(f,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">add=</span>T)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/crop-raster-polygon/index_files/figure-html/unnamed-chunk-1-2.png" class="img-fluid" width="672"></p>
</div>
</div>



 ]]></description>
  <category>R</category>
  <category>raster</category>
  <category>shapefile</category>
  <category>crop</category>
  <category>mask</category>
  <category>sf</category>
  <guid>https://kimfinale.github.io/myblog/posts/crop-raster-polygon/index.html</guid>
  <pubDate>Fri, 22 Sep 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/crop-raster-polygon/thumbnail.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>odin package</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/odin/index.html</link>
  <description><![CDATA[ 




<p>ì´ë²ˆ <a href="https://www.vaccineimpact.org/">Vaccine Impact Modeling Consoritum (VIMC)</a> ì—°ë¡€íšŒì˜ì—ì„œ <code>odin</code>ì´ë¼ëŠ” íŒ¨í‚¤ì§€ì— ëŒ€í•´ ì•Œê²Œ ë˜ì—ˆë‹¤. <code>deSolve</code>ì˜ ì—…ê·¸ë ˆì´ë“œ ë²„ì „ì´ë¼ê³  ë³´ë©´ ë ê¹Œ? R ì½”ë“œë¥¼ Cì–¸ì–´ë¡œ ì»´íŒŒì¼í•˜ê¸° ë•Œë¬¸ì— ìµœì¢… ëª¨í˜•ì˜ êµ¬ë™ì†ë„ê°€ ë¹ ë¥´ë‹¤. ë”°ë¼ì„œ ëª¨í˜•ì„ ì—¬ëŸ¬ë²ˆ ëŒë ¤ì•¼ í•˜ëŠ” ê²½ìš° (ì˜ˆë¥¼ ë“¤ì–´ MCMC) ì— ìœ ë¦¬í•˜ë‹¤. <code>pomp</code> ë³´ë‹¤ë„ í›¨ì”¬ ë” ë¹ ë¥´ë‹¤ê³  í–ˆëŠ”ë° ì •í™•í•œ ë¹„êµ ìˆ˜ì¹˜ëŠ” ìž˜ ê¸°ì–µì´ ì•ˆë‚¨. ì¢…ì¢… C++ë¡œ ëª¨í˜•ì„ ë§Œë“¤ì—ˆëŠ”ë° <code>odin</code> íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ë©´ í›¨ì”¬ ì‰¬ì›Œì§ˆ ê²ƒ ê°™ë‹¤. ì¢€ ë” ì‚´íŽ´ë³´ì•„ì•¼ í•  í…ë° ì¼ë‹¨ ìžŠì§€ ì•Šê¸° ìœ„í•´ ê°„ë‹¨ížˆ SIR ëª¨í˜•ë§Œ ë§Œë“¤ì–´ ë³´ì•˜ë‹¤.</p>
<section id="deterministic-sir-model" class="level3">
<h3 class="anchored" data-anchor-id="deterministic-sir-model">Deterministic SIR model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">path_sir_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C:/Users/jonghoon.kim/Documents/myblog/posts/odin/sir.R"</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">writeLines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readLines</span>(path_sir_model))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>## Core equations for transitions between compartments:
update(S) &lt;- S - beta * S * I / N
update(I) &lt;- I + beta * S * I / N - gamma * I
update(R) &lt;- R + gamma * I

## Total population size (odin will recompute this at each timestep:
## automatically)
N &lt;- S + I + R

## Initial states:
initial(S) &lt;- S_ini # will be user-defined
initial(I) &lt;- I_ini # will be user-defined
initial(R) &lt;- 0

## User defined parameters - default in parentheses:
S_ini &lt;- user(1000)
I_ini &lt;- user(1)
beta &lt;- user(0.2)
gamma &lt;- user(0.1)</code></pre>
</div>
</div>
<p>Run the model and plot the results</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(odin)</span>
<span id="cb3-2">sir_generator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> odin<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">odin</span>(path_sir_model)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sir_generator<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># see what the object is like</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x</span></span>
<span id="cb4-4">sir_col <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#8c8cd9"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#cc0044"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#999966"</span>)</span>
<span id="cb4-5">x_res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">las =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matplot</span>(x_res[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], x_res[, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>,</span>
<span id="cb4-9">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> sir_col, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> sir_col, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/odin/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="stochastic-sir-model" class="level3">
<h3 class="anchored" data-anchor-id="stochastic-sir-model">Stochastic SIR model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">path_sir_stoch_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C:/Users/jonghoon.kim/Documents/myblog/posts/odin/sir_stoch.R"</span></span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">writeLines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readLines</span>(path_sir_stoch_model))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>## Core equations for transitions between compartments:
update(S) &lt;- S - n_SI
update(I) &lt;- I + n_SI - n_IR
update(R) &lt;- R + n_IR

## Individual probabilities of transition:
p_SI &lt;- 1 - exp(-beta * I / N) # S to I
p_IR &lt;- 1 - exp(-gamma) # I to R

## Draws from binomial distributions for numbers changing between
## compartments:
n_SI &lt;- rbinom(S, p_SI)
n_IR &lt;- rbinom(I, p_IR)

## Total population size
N &lt;- S + I + R

## Initial states:
initial(S) &lt;- S_ini
initial(I) &lt;- I_ini
initial(R) &lt;- 0

## User defined parameters - default in parentheses:
S_ini &lt;- user(1000)
I_ini &lt;- user(1)
beta &lt;- user(0.2)
gamma &lt;- user(0.1)</code></pre>
</div>
</div>
<p>Run the model and plot the results</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">sir_generator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> odin<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">odin</span>(path_sir_stoch_model)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb8-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sir_generator<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>()</span>
<span id="cb8-3">x_res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb8-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">las =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matplot</span>(x_res[, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], x_res[, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>,</span>
<span id="cb8-6">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> sir_col, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> sir_col, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/odin/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>

 ]]></description>
  <category>ODE</category>
  <category>R</category>
  <category>odin</category>
  <guid>https://kimfinale.github.io/myblog/posts/odin/index.html</guid>
  <pubDate>Thu, 14 Sep 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/odin/thumbnail.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>

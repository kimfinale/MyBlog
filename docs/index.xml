<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Jong-Hoon Kim&#39;s Blog</title>
<link>https://kimfinale.github.io/myblog/index.html</link>
<atom:link href="https://kimfinale.github.io/myblog/index.xml" rel="self" type="application/rss+xml"/>
<description>Jong-Hoon Kim&#39;s Blog</description>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Sun, 03 Mar 2024 15:00:00 GMT</lastBuildDate>
<item>
  <title>감염병의 대유행 가능성 계산하기</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/Probabily_outbreak/index.html</link>
  <description><![CDATA[ 




<p><a href="https://www.yes24.com/Product/Goods/99051113?ReviewYn=Y">감염병 인류</a> 라는 책을 재미있게 읽는 중이다. 136페이지에는 기초감염재생산지수와 대유행의 가능성에 대한 간단한 수식이 나온다. <img src="https://latex.codecogs.com/png.latex?%5Ctext%7B%EB%8C%80%EC%9C%A0%ED%96%89%EC%9D%98%20%EA%B0%80%EB%8A%A5%EC%84%B1%7D%20=%201%20-%20%5Cfrac%7B1%7D%7BR_0%7D"></p>
<p><img src="https://latex.codecogs.com/png.latex?R_0">는 기초감염재생산지수, 즉 한 사람의 감염자가 다른 모든 사람이 감수성자 (susceptible) 일때 감염시키는 평균 감염자수를 나타낸다. 위 수식은 제한적인 경우에만 적용된다. 감염병 유입 시 대유행의 가능성에 대해 좀 더 일반적으로 적용될 수 있는 방법에 대해 적어보려고 한다. 물론 아래 내용도 상당히 이상적인 상황에 대한 기술일 뿐이고 현실은 그 보다 훨씬 더 복잡할 것이다. 감염병 유입 시 대유행의 가능성에 대한 내용은 Niels G. Becker가 저술한 <a href="https://www.amazon.com/Modeling-Infectious-Disease-Control-Biostatistics/dp/1498731066/ref=sr_1_3?crid=Q6E8KCGFJHES&amp;dib=eyJ2IjoiMSJ9.UCQn7lL_fhp-8cr31i1yvNkFiM8031ZLJrQd3oLch4MLiIGfVd7xSHYK8DxJcl2irN6hOSKXvwIBltRHfSRsMnCEZE09qU6Hj_BrGkMf45Q7EvhtR8q1EEZnjJP4ZrU8ow-Z6gIW1vhne7qQp5LiGeJsnbWorvZjpvfWu0Q-YbgfYopAUnSl95IUf0nlTDbvxm-rYGyOawJEC5BHEBXi3wsYCfLfM-F7eZW2vwT_9n8.DIMrBAhp9UdkHqkC9_69y7tViatvCC44j3phlaCTrA4&amp;dib_tag=se&amp;keywords=niels+becker&amp;qid=1709912228&amp;sprefix=niels+becker%2Caps%2C239&amp;sr=8-3">Modeling to Inform Infectious Disease Control</a>의 제 2장에 자세하게 기술되어 있다.</p>
<p>동일한 사람들로 이루어진 인구 집단에서 감염병이 퍼져나가는 현상을 생각해 보자. 한 사람이 평균적으로 <img src="https://latex.codecogs.com/png.latex?R_0"> 명을 감염시킨다고 할 때 <img src="https://latex.codecogs.com/png.latex?R_0">은 평균일뿐 후속 감염자수는 어떤 확률 분포를 가진다고 생각해볼 수 있다. 한 명의 감염자가 총 <img src="https://latex.codecogs.com/png.latex?j"> 명의 후속 감염자를 만들어 내는 확률을 <img src="https://latex.codecogs.com/png.latex?P(X=j)%20=%20p_j">라고 할 때 <img src="https://latex.codecogs.com/png.latex?R_0">는 아래와 같이 표현할 수 있다.</p>
<p><img src="https://latex.codecogs.com/png.latex?R_0%20=%20%5Csum_%7Bk=0%7D%5E%5Cinfty%20j%20p_j."></p>
<p>대유행의 가능성은 역으로 생각하는 것이 유리하다. 즉 대유행이 아닌 소규모의 감염으로 막을 내리는 확률, <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, 을 구한 후 대유행의 확률은 <img src="https://latex.codecogs.com/png.latex?1-%5Ctheta">로 구하는 것이다. 소규모의 감염이 일어나기 위해서는 유입된 초기 환자 (index patient)가 아무도 감염시키지 않거나 혹은 몇 명을 감염시켰다고 할지라도 후속 감염자들이 추가적으로 일으키는 감염이 소규모일때만 가능할 것이다. 즉 소규모 감염의 확률, <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, 는 아래의 식을 만족한다.</p>
<p><span id="eq-theta"><img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta%20=%20%20p_0%20+%20p_1%20%5Ctheta%20+%20p_2%20%5Ctheta%5E2%20+%20...%0A%5Ctag%7B1%7D"></span></p>
<p>위 식을 보면 <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> 는 후속 감염자수가 어떠한 분포를 따르느냐에 따라 달라질 것이라 예상할 수 있다. 가장 흔히 쓰이는 분포 중의 하나인 푸아송 분포 (Poisson distribution)를 생각해보자. 화률 분포 함수는 아래와 같다.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BProb%7D(X=j)%20=%20%5Cfrac%7BR%5Ej%20e%5ER%7D%7Bj!%7D%5Ctext%7B%20for%20%7D%20j=0,1,2,..."></p>
<p>이 경우 Equation&nbsp;1 의 우변은 아래와 같이 나타내어질 수 있다.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bj=0%7D%5E%5Cinfty%20p_j%20%5Ctheta%5E%7Bj%7D%20=%20e%5E%7B-R_0%20+%20R_0%20%5Ctheta%7D."></p>
<p>따라서 <img src="https://latex.codecogs.com/png.latex?%5Ctheta">는 아래의 식을 계산하면 된다. 다만 해를 직접 구할 수는 없고 수치해석방법을 이용 해서 답을 구해야 한다.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctheta%20=%20e%5E%7B-R_0%20+%20R_0%20%5Ctheta%7D."></p>
<p>위에서 언급한 <img src="https://latex.codecogs.com/png.latex?%5Ctext%7B%EB%8C%80%EC%9C%A0%ED%96%89%EC%9D%98%20%EA%B0%80%EB%8A%A5%EC%84%B1%7D%20=%201%20-%20%5Cfrac%7B1%7D%7BR_0%7D">는 후속 감염자수의 분포가 기하분포 (geometric distribution)를 따를때 성립한다. 기하분포는 아래와 같이 표현되 <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BProb%7D(X=j)%20=%20(1-p)%5Ej%20p"></p>
<p>평균과 성공확률의 관게, <img src="https://latex.codecogs.com/png.latex?R%20=%20%5Cfrac%7B1-p%7D%7Bp%7D">, 이용하여 다시 표현하면 아래와 같다.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BProb%7D(X=j)%20=%20(%5Cfrac%7BR_0%7D%7B1+R_0%7D)%5Ej%20%5Cfrac%7B1%7D%7B1+R_0%7D"> 위에서와 동일하게 계산하면 아래와 같다. <img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bj=0%7D%5E%5Cinfty%20p_j%20%5Ctheta%5E%7Bj%7D%20=%20%5Cfrac%7B1%7D%7B1%20+%20R_0%20-%20R_0%20%5Ctheta%7D"> 따라서 아래의 식을 풀면 <img src="https://latex.codecogs.com/png.latex?%5Ctheta">를 구할 수 있다.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctheta%20=%20%5Cfrac%7B1%7D%7B1%20+%20R_0%20-%20R_0%20%5Ctheta%7D."></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctheta%20=%20%5Cfrac%7B1%7D%7BR_0%7D."></p>
<p>따라서 <a href="https://www.yes24.com/Product/Goods/99051113?ReviewYn=Y">감염병 인류</a> 책에서 언급된 것처럼 <img src="https://latex.codecogs.com/png.latex?%5Ctext%7B%EB%8C%80%EC%9C%A0%ED%96%89%EC%9D%98%20%EA%B0%80%EB%8A%A5%EC%84%B1%7D%20=%201%20-%20%5Cfrac%7B1%7D%7BR_0%7D."> 마지막으로 후속 감염자수가 이항분포 (negative binomial distribution)을 따른다고 가정해보자. 최근 연구들에서 빈번하게 언급되고 가장 현실에 가까운 가정인 듯 하다.</p>
<p>다양한 모수를 사용하여 표현할 수 있고 평균 <img src="https://latex.codecogs.com/png.latex?R_0">과 확산(dispersion; <img src="https://latex.codecogs.com/png.latex?k">)를 이용하여 나타내면 아래와 같다. 이항 분포는 <img src="https://latex.codecogs.com/png.latex?k=1">일 때는 기하분포와 동일하고 <img src="https://latex.codecogs.com/png.latex?k=%5Cinfty"> 일때는 푸아송분포와 동일하다. 코로나 19의 경우 <img src="https://latex.codecogs.com/png.latex?k"> 값이 약 <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9349569/">0.55</a>이다.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BProb%7D(X=j)%20=%20%5Cfrac%7B%5CGamma(k+j)%7D%7Bj!%5CGamma(k)%7D%5Cleft(%5Cfrac%7Bk%7D%7Bk+R_0%7D%5Cright)%5Ek%5Cleft(%5Cfrac%7BR_0%7D%7Bk+R_0%7D%5Cright)%5Ej%20%5Ctext%7B%20for%20%7D%20k=0,1,2,..."> The probability of a minor outbreak, 위와 동일한 방법으로 계산하면 우변은 아래와 같다.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bj=0%7D%5E%5Cinfty%20p_j%20%5Ctheta%5E%7Bj%7D%20=%20%5Cleft(%5Cfrac%7Bk%7D%7Bk%20+%20R_0%20-%20R_0%20%5Ctheta%7D%5Cright)%5Ek"> 따라서 <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20=%20%5Cleft(%5Cfrac%7Bk%7D%7Bk%20+%20R_0%20-%20R_0%20%5Ctheta%7D%5Cright)%5Ek">를 계산하여 소규모감염의 확률을 계산하고 <img src="https://latex.codecogs.com/png.latex?1-%5Ctheta">를 계산하여 대규모유행 확률을 계산하면 된다.</p>
<p>R 시물레이션을 통해서 세방법이 어떻게 다른 결과를 나타내는지 살펴보자</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">prob_outbreak_pois <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(theta, R0){</span>
<span id="cb1-2">  theta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>R0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> R0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>theta) </span>
<span id="cb1-3">}</span>
<span id="cb1-4">prob_outbreak_geo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(R0){</span>
<span id="cb1-5">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R0 </span>
<span id="cb1-6">}</span>
<span id="cb1-7">prob_outbreak_nb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(theta, R0, k){</span>
<span id="cb1-8">  theta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (k <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (k <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> R0 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> R0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>theta))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>k </span>
<span id="cb1-9">}</span>
<span id="cb1-10"></span>
<span id="cb1-11">sol1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(rootSolve<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multiroot</span>(prob_outbreak_pois, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>root)</span>
<span id="cb1-12">sol2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb1-13">sol3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(rootSolve<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multiroot</span>(prob_outbreak_nb, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>root)</span>
<span id="cb1-14"></span>
<span id="cb1-15">Rs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-16">theta1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(Rs, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) </span>
<span id="cb1-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(rootSolve<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multiroot</span>(prob_outbreak_pois, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span>x)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>root))</span>
<span id="cb1-18">theta2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(Rs, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prob_outbreak_geo</span>(x))</span>
<span id="cb1-19">theta3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(Rs, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) </span>
<span id="cb1-20">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(rootSolve<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">multiroot</span>(prob_outbreak_nb, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">k=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.55</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>root))</span>
<span id="cb1-21">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(Rs,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), </span>
<span id="cb1-22">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dist=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pois"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Geom"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"NB(k=0.55)"</span>),<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>),</span>
<span id="cb1-23">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob_outbreak=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>theta1,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>theta2,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>theta3))</span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-26">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, </span>
<span id="cb1-28">                                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb1-29"></span>
<span id="cb1-30"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(R0, prob_outbreak, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>dist))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Probability of a large outbreak vs."</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">italic</span>(R)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Probability of a large outbreak"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">italic</span>(R)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/Probabily_outbreak/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("outbreak_prob.png", units="in", width=3.4*2, height=2.7*2)  </span></span></code></pre></div>
</div>



 ]]></description>
  <category>probability of a large outbreak</category>
  <category>reproduction number</category>
  <guid>https://kimfinale.github.io/myblog/posts/Probabily_outbreak/index.html</guid>
  <pubDate>Sun, 03 Mar 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/Probabily_outbreak/outbreak_prob.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Modeling the waning of the vaccine-derived immunity in the ODE model</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/vacc_waning_nls_erlang/index.html</link>
  <description><![CDATA[ 




<section id="modeling-the-waning-of-the-vaccine-derived-immunity-in-the-ode-model" class="level2">
<h2 class="anchored" data-anchor-id="modeling-the-waning-of-the-vaccine-derived-immunity-in-the-ode-model">Modeling the waning of the vaccine-derived immunity in the ODE model</h2>
<p>The use of ordinary differential equation (ODE) models to simulate disease spread and evaluate vaccine impact is growing. Waning of vaccine-derived immunity often follows an exponential distribution in these models. However, as with the case with incubation period <a href="https://pubmed.ncbi.nlm.nih.gov/19393959/">incubation period</a> that we examined in the <a href="https://www.jonghoonk.com/posts/exp_erlang_lognormal/">previous post</a>, exponential distribution may not accurately depict the waning of vaccine-derived immunity.</p>
<p>In this post, I explore how to model the waning of vaccine efficacy over time using an ODE framework, utilizing the data from a <a href="https://www.thelancet.com/journals/langlo/article/PIIS2214-109X(20)30310-7/fulltext">study by Lee <em>et al</em>.</a> Specifically, I examine how various cumulative distributions can be applied to acurately represent the diminishing percentage of of the vaccine protection over time, through the use of R code examples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data from Table S4, Lee et al. (2020) Lancet Glob Health</span></span>
<span id="cb1-2">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb1-3">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adult"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kid"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)),</span>
<span id="cb1-4">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb1-5">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regimen =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two doses"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"one dose"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb1-6">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">76</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">68</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">58</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">46</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">39</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb1-7">                 <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">76</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">72</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">68</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb1-8">                 <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb1-9">                 <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">36</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>))</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb1-12"></span>
<span id="cb1-13">ds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb1-14">ds[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dat, age<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adult"</span>, type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, regimen<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two doses"</span>)</span>
<span id="cb1-15">ds[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dat, age<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kid"</span>, type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, regimen<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two doses"</span>)</span>
<span id="cb1-16">ds[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dat, age<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adult"</span>, type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, regimen<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"one dose"</span>)</span>
<span id="cb1-17">ds[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dat, age<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kid"</span>, type<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>, regimen<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"one dose"</span>)</span>
<span id="cb1-18"></span>
<span id="cb1-19">fits_gamma_shape_2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) {</span>
<span id="cb1-22"> fits_gamma_shape_2[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nls</span>(val <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb1-23">        val[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(lograte),</span>
<span id="cb1-24">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.tail=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lograte=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>ds[[i]])</span>
<span id="cb1-25">}</span>
<span id="cb1-26"></span>
<span id="cb1-27">fits_gamma_shape_3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) {</span>
<span id="cb1-30"> fits_gamma_shape_3[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nls</span>(val <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb1-31">        val[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(lograte),</span>
<span id="cb1-32">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.tail=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lograte=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>ds[[i]])</span>
<span id="cb1-33">}</span>
<span id="cb1-34"></span>
<span id="cb1-35">fits_gamma_shape_4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb1-36"></span>
<span id="cb1-37"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) {</span>
<span id="cb1-38"> fits_gamma_shape_4[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nls</span>(val <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb1-39">        val[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(lograte),</span>
<span id="cb1-40">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.tail=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lograte=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>ds[[i]])</span>
<span id="cb1-41">}</span>
<span id="cb1-42"></span>
<span id="cb1-43">fits_gamma_shape_5 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb1-44"></span>
<span id="cb1-45"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) {</span>
<span id="cb1-46"> fits_gamma_shape_5[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nls</span>(val <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb1-47">        val[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(lograte),</span>
<span id="cb1-48">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.tail=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lograte=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>ds[[i]])</span>
<span id="cb1-49">}</span>
<span id="cb1-50"></span>
<span id="cb1-51">fits_gamma_shape_8 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb1-52"></span>
<span id="cb1-53"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) {</span>
<span id="cb1-54"> fits_gamma_shape_8[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nls</span>(val <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb1-55">        val[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(lograte),</span>
<span id="cb1-56">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.tail=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lograte=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>ds[[i]])</span>
<span id="cb1-57">}</span>
<span id="cb1-58"></span>
<span id="cb1-59">fits_exp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb1-60"></span>
<span id="cb1-61"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) {</span>
<span id="cb1-62"> fits_exp[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nls</span>(val <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> </span>
<span id="cb1-63">        val[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pexp</span>(month, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(lograte),</span>
<span id="cb1-64">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.tail=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lograte=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>ds[[i]])</span>
<span id="cb1-65">}</span></code></pre></div>
</div>
<section id="gammaa-with-shape2" class="level3">
<h3 class="anchored" data-anchor-id="gammaa-with-shape2">Gammaa with shape=2</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prediction</span></span>
<span id="cb2-2">months <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb2-3">newd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> months)</span>
<span id="cb2-4">pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(months, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb2-5">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adult"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kid"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb2-6">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb2-7">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regimen =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two doses"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"one dose"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)),</span>
<span id="cb2-8">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb2-9">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb2-10">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb2-11">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd)))</span>
<span id="cb2-12">                 </span>
<span id="cb2-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb2-14">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(dat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(month, val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>regimen))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>pred, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(month, val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>regimen)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma decay with shape=2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vaccine efficacy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Months"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/vacc_waning_nls_erlang/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="gammaa-with-shape3" class="level3">
<h3 class="anchored" data-anchor-id="gammaa-with-shape3">Gammaa with shape=3</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prediction</span></span>
<span id="cb3-2">months <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb3-3">newd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> months)</span>
<span id="cb3-4">pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(months, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb3-5">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adult"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kid"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb3-6">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb3-7">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regimen =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two doses"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"one dose"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)),</span>
<span id="cb3-8">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_3[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb3-9">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_3[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb3-10">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_3[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb3-11">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_3[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd)))</span>
<span id="cb3-12">                 </span>
<span id="cb3-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(dat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(month, val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>regimen))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>pred, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(month, val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>regimen)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma decay with shape=3"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vaccine efficacy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Months"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/vacc_waning_nls_erlang/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="exponential-decay" class="level3">
<h3 class="anchored" data-anchor-id="exponential-decay">Exponential decay</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prediction</span></span>
<span id="cb4-2">months <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb4-3">newd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> months)</span>
<span id="cb4-4">pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(months, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb4-5">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adult"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kid"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb4-6">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"model"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb4-7">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regimen =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two doses"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"one dose"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)),</span>
<span id="cb4-8">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_exp[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb4-9">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_exp[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb4-10">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_exp[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb4-11">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_exp[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd)))</span>
<span id="cb4-12">                 </span>
<span id="cb4-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(dat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(month, val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>regimen))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>pred, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(month, val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>regimen)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>age)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exponential decay"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vaccine efficacy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Months"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/vacc_waning_nls_erlang/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Given that the data for adults following a two-dose regimen seem to be the most reliable, we evaluated the model’s residual errors in comparison to this data. The analysis of residual errors indicates that a gamma distribution with a shape parameter of 3 presents the optimal fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fits_exp[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: val ~ val[1] * pexp(month, rate = exp(lograte), lower.tail = FALSE)

Parameters:
        Estimate Std. Error t value Pr(&gt;|t|)    
lograte -4.09710    0.09047  -45.29 6.63e-13 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.0643 on 10 degrees of freedom

Number of iterations to convergence: 6 
Achieved convergence tolerance: 6.629e-06</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fits_gamma_shape_2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: val ~ val[1] * pgamma(month, shape = 2, rate = exp(lograte), 
    lower.tail = FALSE)

Parameters:
        Estimate Std. Error t value Pr(&gt;|t|)    
lograte -3.18619    0.02946  -108.2   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.03005 on 10 degrees of freedom

Number of iterations to convergence: 5 
Achieved convergence tolerance: 6.246e-06</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fits_gamma_shape_3[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: val ~ val[1] * pgamma(month, shape = 3, rate = exp(lograte), 
    lower.tail = FALSE)

Parameters:
        Estimate Std. Error t value Pr(&gt;|t|)    
lograte -2.72304    0.02375  -114.7   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.02893 on 10 degrees of freedom

Number of iterations to convergence: 4 
Achieved convergence tolerance: 1.595e-06</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fits_gamma_shape_4[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: val ~ val[1] * pgamma(month, shape = 4, rate = exp(lograte), 
    lower.tail = FALSE)

Parameters:
        Estimate Std. Error t value Pr(&gt;|t|)    
lograte -2.41214    0.02884  -83.64 1.46e-15 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.0394 on 10 degrees of freedom

Number of iterations to convergence: 6 
Achieved convergence tolerance: 7.874e-07</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fits_gamma_shape_5[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Formula: val ~ val[1] * pgamma(month, shape = 5, rate = exp(lograte), 
    lower.tail = FALSE)

Parameters:
        Estimate Std. Error t value Pr(&gt;|t|)    
lograte -2.17801    0.03374  -64.56 1.94e-14 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.05009 on 10 degrees of freedom

Number of iterations to convergence: 6 
Achieved convergence tolerance: 9.615e-06</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prediction</span></span>
<span id="cb15-2">months <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb15-3">newd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> months)</span>
<span id="cb15-4">pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">month =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(months, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb15-5">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adult"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb15-6">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exponential"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>),</span>
<span id="cb15-7">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=2"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>),</span>
<span id="cb15-8">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=3"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>),</span>
<span id="cb15-9">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=4"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>)),</span>
<span id="cb15-10">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">regimen =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two doses"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb15-11">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_exp[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb15-12">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_2[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb15-13">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_3[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd),</span>
<span id="cb15-14">                          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fits_gamma_shape_4[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> newd)))</span>
<span id="cb15-15"></span>
<span id="cb15-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dat, age<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adult"</span>, regimen<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"two doses"</span>), </span>
<span id="cb15-18">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(month, val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>pred, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(month, val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>type)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Two-dose vaccine efficacy for adults"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vaccine efficacy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Months"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_colour_manual</span>(</span>
<span id="cb15-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exponential"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb15-24">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"green4"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=3"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#6A3D9A"</span>,</span>
<span id="cb15-25">              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=4"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FF7F00"</span>),</span>
<span id="cb15-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">override.aes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb15-27">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blank"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exponential"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>,</span>
<span id="cb15-28">                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>,</span>
<span id="cb15-29">                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=3"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>,</span>
<span id="cb15-30">                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=4"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>),</span>
<span id="cb15-31">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data'</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exponential"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb15-32">                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=2"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb15-33">                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=3"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>,</span>
<span id="cb15-34">                          <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma w/ shape=4"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb15-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/vacc_waning_nls_erlang/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>vaccine-derived immunity</category>
  <category>waning</category>
  <category>cholera</category>
  <category>ODE</category>
  <category>exponential</category>
  <category>Gamma</category>
  <guid>https://kimfinale.github.io/myblog/posts/vacc_waning_nls_erlang/index.html</guid>
  <pubDate>Mon, 26 Feb 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/vacc_waning_nls_erlang/vacc_wane_exp_erlang.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Incremental Cost-Effectiveness Ratio (ICER)</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/ICER/index.html</link>
  <description><![CDATA[ 




<section id="understanding-the-incremental-cost-effectiveness-ratio-icer-through-cholera-vaccination" class="level3">
<h3 class="anchored" data-anchor-id="understanding-the-incremental-cost-effectiveness-ratio-icer-through-cholera-vaccination">Understanding the Incremental Cost-Effectiveness Ratio (ICER) Through Cholera Vaccination</h3>
<p>The Incremental Cost-Effectiveness Ratio (ICER) is a crucial metric in health economics, offering insights into the value of medical interventions by comparing their costs and effectiveness. Essentially, ICER is used to evaluate the cost-effectiveness of a new healthcare intervention compared to an existing standard of care. It is calculated as the difference in costs between two options divided by the difference in their effectiveness, typically measured in quality-adjusted life years (QALYs). This ratio helps policymakers and healthcare providers make informed decisions on allocating limited resources to maximize health benefits.</p>
<p>Consider the example of cholera, a severe diarrhoeal disease caused by the _/<em>Vibrio cholerae</em> bacterium, and the use of the oral cholera vaccine (OCV). In regions where cholera is endemic, introducing or expanding the use of OCV can significantly reduce the incidence of the disease. To assess the cost-effectiveness of OCV, we can compare the ICER of vaccinating a population against cholera to the standard of care, which might include treatments like rehydration solutions or antibiotics for those already infected.</p>
<p>Let’s explore how to calculate the ICER for introducing OCV in a hypothetical scenario using R. Assume we have data on the cost of vaccinating individuals and the effectiveness of the vaccine in preventing cholera, as well as the cost and effectiveness of the current standard cholera treatment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the costs and effectiveness of the oral cholera vaccine (OCV) and standard treatment</span></span>
<span id="cb1-2">cost_OCV <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Total cost of vaccinating a population</span></span>
<span id="cb1-3">effectiveness_OCV <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reduction in cholera incidence due to vaccination</span></span>
<span id="cb1-4">cost_standard <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Total cost of treating cholera without vaccination</span></span>
<span id="cb1-5">effectiveness_standard <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reduction in cholera incidence with standard treatment</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the incremental cost and effectiveness</span></span>
<span id="cb1-8">incremental_cost <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cost_OCV <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> cost_standard</span>
<span id="cb1-9">incremental_effectiveness <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> effectiveness_OCV <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> effectiveness_standard</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the ICER</span></span>
<span id="cb1-12">ICER <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> incremental_cost <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> incremental_effectiveness</span></code></pre></div>
</div>
<p>This R code snippet outlines the basic calculation for ICER, where cost_OCV and effectiveness_OCV represent the cost and effectiveness of the OCV intervention, respectively, and cost_standard and effectiveness_standard represent these metrics for the standard treatment. By comparing these values, the ICER provides a dollar amount per percentage point increase in effectiveness, offering a straightforward metric for evaluating the cost-effectiveness of implementing the oral cholera vaccine in a specific population.</p>
<p>In summary, the ICER is a valuable tool in health economics, helping to guide decisions on the allocation of resources for interventions like the oral cholera vaccine. By quantifying the trade-offs between cost and effectiveness, ICER facilitates more informed, evidence-based choices in healthcare policy and practice.</p>


</section>

 ]]></description>
  <category>cholera</category>
  <category>sub-Saharan Africa</category>
  <guid>https://kimfinale.github.io/myblog/posts/ICER/index.html</guid>
  <pubDate>Sat, 24 Feb 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/ICER/sample_figure.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Implementing incubation period of cholera in the ODE model</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/exp_erlang_lognormal/index.html</link>
  <description><![CDATA[ 




<section id="modeling-incubation-period-in-the-ode-model" class="level3">
<h3 class="anchored" data-anchor-id="modeling-incubation-period-in-the-ode-model">Modeling incubation period in the ODE model</h3>
<p>In the realm of infectious disease modeling, accurately simulating the incubation period–the time between exposure to a pathogen and the onset of symptoms–is crucial for understanding and predicting the spread of diseases. Classic ordinary differential equation (ODE) models often employ the exponential distribution to represent this incubation period mostly for the sake of convenience. However, the exponential distribution is not an optimal distribution to model the waiting time for the incubation period, which is often modeled as a log-normal distribution as shown in the <a href="https://pubmed.ncbi.nlm.nih.gov/19393959/">study by Lessler <em>et al</em>.</a>. In this post, I show that waiting time may be modeled more realistically by adding an extra compartment (e.g., <img src="https://latex.codecogs.com/png.latex?SE_1E_2IR"> rather than <img src="https://latex.codecogs.com/png.latex?SEIR">) and thus making the waiting time Erlang-distributed.</p>
<p>In particular, in the following R codes, I explored the incubation period of cholera from the <a href="https://www.sciencedirect.com/science/article/abs/pii/S0163445312003477#:~:text=We%20estimate%20the%20median%20incubation,CI%2C%201.3%E2%80%931.6">study by Azman <em>et al</em>.</a>. Azman writes: We estimate the median incubation period of toxigenic cholera to be 1.4 days (95% Credible Interval (CI), 1.3-1.6) with a dispersion of 1.98 (95% CI 1.87-2.11). Five percent of cholera cases will develop symptoms by 0.5 days (95% CI 0.4-0.5), and 95% by 4.4 days (95% CI 3.9-5.0) after infection.</p>
<p>Based on the description, I set the parameters for the log-normal distribution as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.40</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># median</span></span>
<span id="cb1-2">b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.98</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># disperson</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qlnorm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meanlog =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(a), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdlog =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(b)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5 4.3</code></pre>
</div>
</div>
<p>There is a slight mismatch for the 95th percentile (4.3 vs 4.4 [reported]). This is, however, possible considering that the estimates are from Bayesian posterior samples and I can’t account for the correlation between the parameter estimates.</p>
<p>Using this log-normal distribution, I generate samples (<img src="https://latex.codecogs.com/png.latex?n=1000">), to which exponential and Erlang distributions are fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meanlog =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(a), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdlog =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(b))</span>
<span id="cb3-2"></span>
<span id="cb3-3">fit_exp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> fitdistrplus<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fitdist</span>(dat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distr=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp"</span>)</span>
<span id="cb3-4">fit_gam <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> fitdistrplus<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fitdist</span>(dat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distr=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>)</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qexp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span>fit_exp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1 5.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qgamma</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>fit_gam<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span>fit_gam<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.4 3.9</code></pre>
</div>
</div>
<p>By examining <img src="https://latex.codecogs.com/png.latex?5%5E%7Bth%7D"> and <img src="https://latex.codecogs.com/png.latex?95%5E%7Bth%7D"> percentiles, we realize that the best-fit exponential distribution is too wide compared with the log-normal distribution whereas the Gamma distribution looks better.</p>
<p>However, in the context of ODE models, Gamma distribution is not easy to implement except for a subset in which the shape parameter is an integer (i.e., Erlang distribution). Therefore, I fit the rate parameter of the Gamma distribution while the shape parameter is set to an integer. Based on the previous fitting results (shape parameter = 2.348677), I only test the cases where the shape parameter is 2 or 3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">erlang_nll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shp=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>){</span>
<span id="cb7-2">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(dat, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>shp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span>p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb7-3">}</span>
<span id="cb7-4">er_shp2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optimize</span>(erlang_nll, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shp=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-5">er_shp3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optimize</span>(erlang_nll, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shp=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
</div>
<p>Considering the negative log likelihood values, we realize that the Gamma distribution with shape of 2 provides a better fit than the one with shape of 3.</p>
<p>We plot the results as a visual summary.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the number of</span></span>
<span id="cb8-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out=</span>n)</span>
<span id="cb8-3">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">val =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>),</span>
<span id="cb8-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dist =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Log-normal"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exponential"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gamma"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Erlang (shape=2)"</span>), </span>
<span id="cb8-6">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each=</span>n), </span>
<span id="cb8-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">density =</span> </span>
<span id="cb8-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dlnorm</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meanlog=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdlog=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.98</span>)), </span>
<span id="cb8-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dexp</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span>fit_exp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]), </span>
<span id="cb8-10">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>fit_gam<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], </span>
<span id="cb8-11">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span>fit_gam<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>estimate[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]), </span>
<span id="cb8-12">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span>er_shp2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>minimum)))</span>
<span id="cb8-13"></span>
<span id="cb8-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb8-15">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb8-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb8-17"></span>
<span id="cb8-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>val, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>density, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>dist))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/exp_erlang_lognormal/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The above figure clearly shows that the Erlang distribution has a better representation of reality (in this case, the log-normal distributed incubation period) than the commonly used exponential distribution.</p>


</section>

 ]]></description>
  <category>incubation period</category>
  <category>ODE</category>
  <category>cholera</category>
  <category>exponential</category>
  <category>Erlang</category>
  <guid>https://kimfinale.github.io/myblog/posts/exp_erlang_lognormal/index.html</guid>
  <pubDate>Wed, 21 Feb 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/exp_erlang_lognormal/lnorm_exp_erlang.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Mass-action assumption: density- vs. frequency-dependent transmission</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/density_frequency/index.html</link>
  <description><![CDATA[ 




<section id="density-dependent-vs.-frequency-dependent-transmission" class="level3">
<h3 class="anchored" data-anchor-id="density-dependent-vs.-frequency-dependent-transmission">Density-dependent vs.&nbsp;frequency-dependent transmission</h3>
<p>In models of transmission of directly transmitted pathogens, e.g., COVID-19, the transmission is assumed to occur via so-called <em>mass action</em> principle. It means the rate of newly infected people per unit area, per unit of time is proportional to the product between the numbers (or densities) of susceptible and infectious individuals. The term appears to be first coined by Hamer in 1906 in his <a href="https://www.sciencedirect.com/science/article/abs/pii/S0140673601801872">paper</a>. However, as indicated by <a href="https://www.sciencedirect.com/science/article/abs/pii/S0169534701021449">McCallum</a>, there have been some confusion over using the term, <em>mass action</em>. The confusion is around that mass action principle may be implemented in the manner of <em>frequency-dependent</em> or <em>density-dependent</em> transmission.</p>
<p>In the <em>density-dependent</em> transmission scenario, the rate of change in the number or density of infected individual can be implemented as follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7Bd%7DI%20=%20%5Cbeta%5E*%20SI%20-%20%5Cgamma%20I">.</p>
<p>In the <em>frequency-dependent</em> scenario, arguably more widely adopted one, the rate of change in the number or density of infected individual can be implemented as follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathrm%7Bd%7DI%20=%20%5Cbeta%20SI/N%20-%20%5Cgamma%20I"> Two formulations have different implications. The most notable difference is that there is a threshold density, <img src="https://latex.codecogs.com/png.latex?N_T"> in the <em>density-dependent</em> formulation whereas the second model leads to the basic reproduction ratio, <img src="https://latex.codecogs.com/png.latex?R_0">, is derived from <em>frequency-dependent</em>. Of course, it is straightforward to interchange between the two types of models.</p>
<p>Both <img src="https://latex.codecogs.com/png.latex?%5Cbeta%5E*"> and <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> are transmission coefficients but their unit are different. In the frequency-dependent formulation, <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> can mean the number of transmissions per unit of time for an infected individual when it contacts with susceptible individuals. Therefore, the whole term, <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20I%20S/N">, could mean that the number of newly infected individuals per unit of time. For density-dependent formulation, <img src="https://latex.codecogs.com/png.latex?%5Cbeta%5E*"> can mean the number of transmissions per unit of density per unit of time for an infected individual. The whole term <img src="https://latex.codecogs.com/png.latex?%5Cbeta%5E*%20I%20S"> can then mean the density of newly infected individuals per unit of time.</p>
<p>Now let’s implement a simple SIR model in two different formulations.</p>
<section id="density-dependent-transmission" class="level4">
<h4 class="anchored" data-anchor-id="density-dependent-transmission">Density-dependent transmission</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">sir_den <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(t, u, p){</span>
<span id="cb1-2">  new_Istar <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> p[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta_star"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-3">  du1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> new_Istar</span>
<span id="cb1-4">  du2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> new_Istar <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-5">  du3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-6">    </span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(du1,du2,du3))) </span>
<span id="cb1-8">}</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(deSolve)</span>
<span id="cb1-11">pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-12">I0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb1-13">u0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> I0, I0, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-14">tspan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb1-15">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta_star=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0006</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamma=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb1-16"></span>
<span id="cb1-17">outdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ode</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>u0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span>tspan, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func=</span>sir_den, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>p))</span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-20">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb1-22"></span>
<span id="cb1-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(outdf,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>time))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">2</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">3</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb1-28">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/density_frequency/index_files/figure-html/sir_den-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># threshold host population size</span></span>
<span id="cb2-2">Nt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> p[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta_star"</span>]</span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># R0 can be computed through N/Nt</span></span>
<span id="cb2-4">R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Nt</span>
<span id="cb2-5"></span>
<span id="cb2-6">final_epidemic_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0 =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) {</span>
<span id="cb2-7">  y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>R0<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x)</span>
<span id="cb2-8">  final_size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uniroot</span>(y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">interval=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1e-6</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>root</span>
<span id="cb2-9"></span>
<span id="cb2-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(final_size)</span>
<span id="cb2-11"></span>
<span id="cb2-12">}</span>
<span id="cb2-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">final_epidemic_size</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span>R0), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 940.48</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tail</span>(outdf, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">3</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 939.32</code></pre>
</div>
</div>
</section>
<section id="frequency-dependent-formulation" class="level4">
<h4 class="anchored" data-anchor-id="frequency-dependent-formulation">Frequency-dependent formulation</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">sir_freq <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(t, u, p){</span>
<span id="cb6-2">  new_I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> p[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(u)</span>
<span id="cb6-3">  du1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> new_I</span>
<span id="cb6-4">  du2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> new_I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb6-5">  du3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb6-6">    </span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(du1,du2,du3))) </span>
<span id="cb6-8">}</span>
<span id="cb6-9"></span>
<span id="cb6-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(deSolve)</span>
<span id="cb6-11">pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb6-12">I0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb6-13">u0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> I0, I0, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb6-14">tspan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb6-15">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamma=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb6-16"></span>
<span id="cb6-17">outdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ode</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>u0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span>tspan, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func=</span>sir_freq, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>p))</span>
<span id="cb6-18"></span>
<span id="cb6-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(outdf,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>time))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">2</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">3</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb6-24">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/density_frequency/index_files/figure-html/sir_freq-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># R0 threshold</span></span>
<span id="cb7-2">(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0 =</span> p[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> p[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>]])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(pop<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">final_epidemic_size</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span>R0), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 940.48</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tail</span>(outdf, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">3</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">digits=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 939.32</code></pre>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>mass action</category>
  <category>frequency-dependent</category>
  <category>density-dependent</category>
  <guid>https://kimfinale.github.io/myblog/posts/density_frequency/index.html</guid>
  <pubDate>Sun, 18 Feb 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/density_frequency/interval_censor.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>LabelledArrays and NamedTupleTools make it easy to use the ODE model in Julia</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/julia_labelledarrays_namedtupletools/index.html</link>
  <description><![CDATA[ 




<section id="seir-model-using-labelledarrays" class="level3">
<h3 class="anchored" data-anchor-id="seir-model-using-labelledarrays">SEIR model using LabelledArrays</h3>
<p>The <a href="https://github.com/SciML/LabelledArrays.jl">LabelledArrays</a> package makes it easy to use the ODE model in Julia. It offers a method to manage variables via keys instead of indices. Variables can be constructed using the <code>@LArray</code> macro or <code>LVector</code>.</p>
<p>However, using arrays to store a mix of information types is not optimal for performance. I frequently need to store different variable types within a single parameter, which prompts a warning, highlighting that combining variable types in an array could reduce performance and suggesting tuples as a more efficient alternative.</p>
<blockquote class="blockquote">
<p>┌ Warning: Utilizing arrays or dictionaries to store parameters of diverse types can compromise performance. │ Using tuples is advised for better efficiency. └ @ SciMLBase C:.kim.julia_warnings.jl:32</p>
</blockquote>
<p>Tuples, being essentially immutable, presents a challenge since some of model parameters that must be adjustible or estimated. The <a href="https://github.com/JeffreySarnoff/NamedTupleTools.jl">NamedTupleTools</a> package offers a convenient solution with its <code>merge</code> function, enabling easy updates to the values within a Tuple.</p>
<p>In conclusion, the best approach seems to be leveraging LabelledArrays for state variables and NamedTupleTools for parameters. Let’s delve into this approach using the SEIR model as a case study.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LabelledArrays</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">OrdinaryDiffEq</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Plots</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">NamedTupleTools</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">BenchmarkTools</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seir</span>(du, u, p, t)</span>
<span id="cb1-4">    N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(u)</span>
<span id="cb1-5">    du.S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p.β <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u.S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u.I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> N</span>
<span id="cb1-6">    du.E <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p.β <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u.S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u.I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p.ϵ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u.E</span>
<span id="cb1-7">    du.I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p.ϵ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u.E <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p.γ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u.I</span>
<span id="cb1-8">    du.R <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p.γ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> u.I </span>
<span id="cb1-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>seir (generic function with 1 method)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"></span>
<span id="cb3-2">u0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@LArray</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>S, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>E, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>I, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>R);</span>
<span id="cb3-3">p_la <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@LArray</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>] (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>β, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>ϵ, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>γ);</span>
<span id="cb3-4">p_la <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LVector</span>(p_la, β<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span>, int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, la<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LVector</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), tp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>));</span>
<span id="cb3-5">tspan <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>);</span>
<span id="cb3-6">prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ODEProblem</span>(seir, u0, tspan, p_la);</span>
<span id="cb3-7">sol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), saveat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb3-8"></span>
<span id="cb3-9">s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [sol[i].S for i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>];</span>
<span id="cb3-10"><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">e</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [sol[i].E for i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>];</span>
<span id="cb3-11">i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [sol[i].I for i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>];</span>
<span id="cb3-12">r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [sol[i].R for i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">101</span>];</span>
<span id="cb3-13"></span>
<span id="cb3-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(sol.t, [s <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">e</span> i r])</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/julia_labelledarrays_namedtupletools/index_files/figure-html/unnamed-chunk-1-J1.png" class="img-fluid" width="300"></p>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NamedTupleTools approach</span></span>
<span id="cb4-3">p_nt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (β<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, ϵ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, γ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>);</span>
<span id="cb4-4">p_nt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">merge</span>(p_nt, (β<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, str<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"string"</span>, int<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, la<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LVector</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), tp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)));</span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">BenchmarkTools</span></span>
<span id="cb4-7">time_la <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@benchmark</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ODEProblem</span>(seir, u0, tspan, p_la), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), saveat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb4-8">time_nt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">@benchmark</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ODEProblem</span>(seir, u0, tspan, p_nt), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), saveat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb4-9">time_la</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min … max):  118.300 μs …  1.065 ms  ┊ GC (min … max): 0.00% … 85.42%
 Time  (median):     123.800 μs              ┊ GC (median):    0.00%
 Time  (mean ± σ):   127.737 μs ± 39.266 μs  ┊ GC (mean ± σ):  1.42% ±  4.10%

  ▁▃▂▄██▇▄▃▂▂▁            ▁▂▁                                  ▂
  █████████████▇█▇▆▆▇▇▆▅▆█████▇▇▆▄▅▅▅▄▄▅▅▆▅▄▅▆▅▅▄▄▅▄▁▅▄▆▅▄▅▆▅▆ █
  118 μs        Histogram: log(frequency) by time       180 μs &lt;

 Memory estimate: 106.75 KiB, allocs estimate: 5727.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1">time_nt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>BenchmarkTools.Trial: 10000 samples with 1 evaluation.
 Range (min … max):  37.400 μs …  1.306 ms  ┊ GC (min … max): 0.00% … 94.58%
 Time  (median):     39.700 μs              ┊ GC (median):    0.00%
 Time  (mean ± σ):   41.141 μs ± 28.101 μs  ┊ GC (mean ± σ):  1.49% ±  2.13%

   ▁▄▆██▇▆▄▃▂▁▁▁▁▁▁▁▁▁                                        ▂
  ▅██████████████████████▇▇▆▆▆▆▆▆▅▆▇▆▆▆▆▅▅▅▁▄▃▃▅▄▁▅▃▄▃▁▁▄▄▄▃▅ █
  37.4 μs      Histogram: log(frequency) by time      62.3 μs &lt;

 Memory estimate: 28.64 KiB, allocs estimate: 685.</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>julia</category>
  <category>ODE</category>
  <category>LabelledArrays</category>
  <category>NamedTupleTools</category>
  <category>SEIR</category>
  <guid>https://kimfinale.github.io/myblog/posts/julia_labelledarrays_namedtupletools/index.html</guid>
  <pubDate>Thu, 25 Jan 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/julia_labelledarrays_namedtupletools/sciml.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>SIR model benchmarks: deSolve, odin, and diffeqr</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/sir_deSolve_odin_diffeqr/index.html</link>
  <description><![CDATA[ 




<section id="desolve-package" class="level3">
<h3 class="anchored" data-anchor-id="desolve-package">deSolve package</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">sir_deSolve <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(t, u, p){</span>
<span id="cb1-2">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(u)</span>
<span id="cb1-3">  du1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N</span>
<span id="cb1-4">  du2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-5">  du3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-6">    </span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(du1,du2,du3))) </span>
<span id="cb1-8">}</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(deSolve)</span>
<span id="cb1-11">u0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-12">tspan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb1-13">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb1-14"></span>
<span id="cb1-15">outdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ode</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>u0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span>tspan, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func=</span>sir_deSolve, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>p))</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-18">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(outdf,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>time))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">2</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">3</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb1-26">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/sir_deSolve_odin_diffeqr/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="manual-c" class="level3">
<h3 class="anchored" data-anchor-id="manual-c">Manual C++</h3>
<p>Euler method was implemented</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">sir_cpp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span></span>
<span id="cb2-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">#include &lt;Rcpp.h&gt;</span></span>
<span id="cb2-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">using namespace Rcpp;</span></span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">// [[Rcpp::export]]</span></span>
<span id="cb2-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">List sir_cpp(List params) {</span></span>
<span id="cb2-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  double tau = params["tau"]; // time step size</span></span>
<span id="cb2-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  double ndays = params["ndays"]; // number of days for output</span></span>
<span id="cb2-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int nsubsteps = ceil(1/tau);</span></span>
<span id="cb2-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb2-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  NumericVector S(ndays+1);</span></span>
<span id="cb2-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  NumericVector I(ndays+1);</span></span>
<span id="cb2-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  NumericVector R(ndays+1); </span></span>
<span id="cb2-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  NumericVector time(ndays+1);</span></span>
<span id="cb2-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb2-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  S(0) = params["susceptible"];</span></span>
<span id="cb2-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  I(0) = params["infectious"];</span></span>
<span id="cb2-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  R(0) = params["recovered"];</span></span>
<span id="cb2-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb2-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  double b = params["b"]; // transmission rate per unit of time</span></span>
<span id="cb2-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  double g = params["g"]; // recovery rate</span></span>
<span id="cb2-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb2-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (int day = 0; day &lt; ndays; day++) {</span></span>
<span id="cb2-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    double St = S[day];</span></span>
<span id="cb2-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    double It = I[day];</span></span>
<span id="cb2-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    double Rt = R[day];</span></span>
<span id="cb2-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb2-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (int substep = 0; substep &lt; nsubsteps; substep++){</span></span>
<span id="cb2-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      double N = St + It + Rt;</span></span>
<span id="cb2-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      double foi = b * It / N;</span></span>
<span id="cb2-31"></span>
<span id="cb2-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      double StoI = St * foi * tau;</span></span>
<span id="cb2-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      double ItoR = It * g * tau;</span></span>
<span id="cb2-34"></span>
<span id="cb2-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      double dS = - StoI;</span></span>
<span id="cb2-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      double dI = + StoI - ItoR;</span></span>
<span id="cb2-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      double dR = + ItoR;</span></span>
<span id="cb2-38"></span>
<span id="cb2-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      St = St + dS;</span></span>
<span id="cb2-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      It = It + dI;</span></span>
<span id="cb2-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      Rt = Rt + dR;</span></span>
<span id="cb2-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb2-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Update next timestep</span></span>
<span id="cb2-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    S[day + 1] = St;</span></span>
<span id="cb2-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    I[day + 1] = It;</span></span>
<span id="cb2-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    R[day + 1] = Rt;</span></span>
<span id="cb2-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    time[day + 1] = day+1;</span></span>
<span id="cb2-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb2-49"></span>
<span id="cb2-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  DataFrame result = DataFrame::create(</span></span>
<span id="cb2-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Named("time") = time,</span></span>
<span id="cb2-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Named("S") = S,</span></span>
<span id="cb2-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Named("I") = I,</span></span>
<span id="cb2-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    Named("R") = R);</span></span>
<span id="cb2-55"></span>
<span id="cb2-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  return result;</span></span>
<span id="cb2-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}'</span></span>
<span id="cb2-58"></span>
<span id="cb2-59"></span>
<span id="cb2-60">Rcpp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cppFunction</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">code=</span>sir_cpp)</span>
<span id="cb2-61"></span>
<span id="cb2-62">params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>()</span>
<span id="cb2-63">params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">within</span>(params, {</span>
<span id="cb2-64">  tau <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in days</span></span>
<span id="cb2-65">  ndays <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span></span>
<span id="cb2-66"></span>
<span id="cb2-67">  b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span></span>
<span id="cb2-68">  g <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb2-69">  </span>
<span id="cb2-70">  susceptible <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span></span>
<span id="cb2-71">  infectious <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb2-72">  recovered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb2-73">})</span>
<span id="cb2-74"></span>
<span id="cb2-75">out_cpp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sir_cpp</span>(params)</span>
<span id="cb2-76"></span>
<span id="cb2-77"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(out_cpp, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>time))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-78">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-79">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-80">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-81">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb2-82">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-83">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/sir_deSolve_odin_diffeqr/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="odin-package" class="level3">
<h3 class="anchored" data-anchor-id="odin-package">odin package</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(odin)</span>
<span id="cb3-2">sir_odin <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> odin<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">odin</span>({</span>
<span id="cb3-3">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Derivatives</span></span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deriv</span>(S) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>S<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(S<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>I<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>R)</span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deriv</span>(I) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>S<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(S<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>I<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>R)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>g<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I</span>
<span id="cb3-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deriv</span>(R) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> g<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I</span>
<span id="cb3-7"></span>
<span id="cb3-8">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Initial conditions</span></span>
<span id="cb3-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initial</span>(S) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span></span>
<span id="cb3-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initial</span>(I) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb3-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">initial</span>(R) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.00</span></span>
<span id="cb3-12"></span>
<span id="cb3-13">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## parameters</span></span>
<span id="cb3-14">  b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">user</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>)</span>
<span id="cb3-15">  g <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">user</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb3-16">})</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>── R CMD INSTALL ───────────────────────────────────────────────────────────────
* installing *source* package 'odin3fe5a09e' ...
** using staged installation
** libs
using C compiler: 'gcc.exe (GCC) 12.2.0'
gcc  -I"C:/PROGRA~1/R/R-43~1.1/include" -DNDEBUG     -I"C:/rtools43/x86_64-w64-mingw32.static.posix/include"     -O2 -Wall -gdwarf-2 -mfpmath=sse -msse2 -mstackrealign  -UNDEBUG -Wall -pedantic -g -O0 -c odin.c -o odin.o
odin.c: In function 'odin_metadata':
odin.c:106:18: warning: unused variable 'internal' [-Wunused-variable]
  106 |   odin_internal *internal = odin_get_internal(internal_p, 1);
      |                  ^~~~~~~~
gcc  -I"C:/PROGRA~1/R/R-43~1.1/include" -DNDEBUG     -I"C:/rtools43/x86_64-w64-mingw32.static.posix/include"     -O2 -Wall -gdwarf-2 -mfpmath=sse -msse2 -mstackrealign  -UNDEBUG -Wall -pedantic -g -O0 -c registration.c -o registration.o
gcc -shared -static-libgcc -o odin3fe5a09e.dll tmp.def odin.o registration.o -LC:/rtools43/x86_64-w64-mingw32.static.posix/lib/x64 -LC:/rtools43/x86_64-w64-mingw32.static.posix/lib -LC:/PROGRA~1/R/R-43~1.1/bin/x64 -lR
installing to C:/Users/jonghoon.kim/AppData/Local/Temp/RtmpoVtDRD/devtools_install_60e45cff70a/00LOCK-file60e443e27d60/00new/odin3fe5a09e/libs/x64
* DONE (odin3fe5a09e)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">sir_mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sir_odin<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb5-2">tspan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb5-3">out_odin <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(sir_mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run</span>(tspan))</span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(out_odin, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>t))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb5-10">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/sir_deSolve_odin_diffeqr/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="diffeqr-package" class="level3">
<h3 class="anchored" data-anchor-id="diffeqr-package">diffeqr package</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(diffeqr)</span>
<span id="cb6-2">de <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> diffeqr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diffeq_setup</span>()</span>
<span id="cb6-3"></span>
<span id="cb6-4">sir_julia <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(u, p, t){</span>
<span id="cb6-5">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(u)</span>
<span id="cb6-6">  du1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N</span>
<span id="cb6-7">  du2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb6-8">  du3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb6-9">    </span>
<span id="cb6-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(du1,du2,du3))</span>
<span id="cb6-11">}</span>
<span id="cb6-12"></span>
<span id="cb6-13">u0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb6-14">tspan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.0</span>)</span>
<span id="cb6-15">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb6-16">prob <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ODEProblem</span>(sir_julia, u0, tspan, p)</span>
<span id="cb6-17">prob_jit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> diffeqr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jitoptimize_ode</span>(de, prob)</span>
<span id="cb6-18"></span>
<span id="cb6-19">sol <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob_jit, de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">saveat=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-20"></span>
<span id="cb6-21">mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(sol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>u, identity)</span>
<span id="cb6-22">udf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(mat))</span>
<span id="cb6-23">tudf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t=</span>sol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t), udf)</span>
<span id="cb6-24"></span>
<span id="cb6-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(tudf, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>t))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>V1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>V2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>V3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb6-30">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/sir_deSolve_odin_diffeqr/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("diffeqr_sir.png", gg, units="in", width=3.4*2, height=2.7*2)  </span></span></code></pre></div>
</div>
</section>
<section id="benchmarks" class="level3">
<h3 class="anchored" data-anchor-id="benchmarks">Benchmarks</h3>
<p>The <code>diffeqr</code> is the most efficient tool for running the SIR model in its ODE form.</p>
<p>As a side note, the test gave an unfair advantage to the <code>sir_cpp</code> due to the use of the Euler method with 0.1 day step size. In fact, <code>deSolve::ode</code> outperformed <code>sir_cpp</code> when it was used with <code>"method="euler"</code>. Therefore there is no need to write manually CPP models if an ODE solver is what you need. The situation might differ when implementing a stochastic model, which will be discussed in a later post.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(microbenchmark)</span>
<span id="cb8-2"></span>
<span id="cb8-3">benchmark <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">microbenchmark</span>(</span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">deSolve =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ode</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>u0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span>tspan, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func=</span>sir_deSolve, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>p),</span>
<span id="cb8-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cpp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sir_cpp</span>(params),</span>
<span id="cb8-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">odin =</span> sir_mod<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">run</span>(tspan),</span>
<span id="cb8-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">julia =</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob_jit, de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">saveat=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb8-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb8-9">)</span>
<span id="cb8-10"></span>
<span id="cb8-11">benchmark</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
    expr   min     lq     mean median     uq     max neval cld
 deSolve 401.2 428.35 465.7012 442.35 458.05  2894.6  1000 a  
     cpp 169.8 206.90 239.4003 234.40 251.50  2599.0  1000  b 
    odin 127.6 184.90 227.0216 208.90 253.00  4004.9  1000  b 
   julia  71.9 109.60 148.7960 130.65 144.00 15164.4  1000   c</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>ODE</category>
  <category>R</category>
  <category>deSolve</category>
  <category>odin</category>
  <category>diffeqr</category>
  <category>C++</category>
  <category>Julia</category>
  <guid>https://kimfinale.github.io/myblog/posts/sir_deSolve_odin_diffeqr/index.html</guid>
  <pubDate>Thu, 18 Jan 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/sir_deSolve_odin_diffeqr/diffeqr_sir.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>diffeqr: R interface to the Julia’s DifferentialEquations.jl</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/diffeqr/index.html</link>
  <description><![CDATA[ 




<p>Julia <a href="https://docs.sciml.ai/DiffEqDocs/stable/">DifferentialEquations.jl</a> provides an impressive collection of differential equation solvers. The DE solvers available in the package are reliable and a lot faster than what’s avaiable in R. It’s now possible to access the solvers in R thanks to the <code>diffeqr</code> package. The following codes were adapted from the <code>diffeqr</code> GitHub <a href="https://github.com/SciML/diffeqr">page</a>.</p>
<section id="desolve-package" class="level3">
<h3 class="anchored" data-anchor-id="desolve-package">deSolve package</h3>
<p>I am using the SIR model as an example and for speed comparison, first solving equations using the <a href="https://desolve.r-forge.r-project.org/">deSolve</a> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">sir_deSolve <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(t, u, p){</span>
<span id="cb1-2">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(u)</span>
<span id="cb1-3">  du1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N</span>
<span id="cb1-4">  du2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-5">  du3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-6">    </span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(du1, du2, du3))) </span>
<span id="cb1-8">}</span></code></pre></div>
</div>
<p>Let’s sovel the model using the <code>deSolve::ode</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(deSolve)</span>
<span id="cb2-2">u0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">99</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-3">tspan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-4">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb2-5"></span>
<span id="cb2-6">outdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ode</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>u0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span>tspan, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func=</span>sir_deSolve, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>p))</span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb2-9">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(outdf,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>time))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">1</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">2</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">3</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb2-17">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/diffeqr/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="diffeqr-package" class="level3">
<h3 class="anchored" data-anchor-id="diffeqr-package">diffeqr package</h3>
<p>Now let’s use the <code>diffeqr</code> package. Once the <code>de &lt;- diffeqr::diffeq_setup</code> is executed, the functions for DifferentialEquations.jl are available through <code>de$</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(diffeqr)</span>
<span id="cb3-2">de <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> diffeqr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diffeq_setup</span>()</span></code></pre></div>
</div>
<p>diffeqr has slightly different convention.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">sir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(u, p, t){</span>
<span id="cb4-2">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(u)</span>
<span id="cb4-3">  du1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N</span>
<span id="cb4-4">  du2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb4-5">  du3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb4-6">    </span>
<span id="cb4-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(du1,du2,du3))</span>
<span id="cb4-8">}</span>
<span id="cb4-9"></span>
<span id="cb4-10">u0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb4-11">tspan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.0</span>)</span>
<span id="cb4-12">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb4-13">prob <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ODEProblem</span>(sir, u0, tspan, p)</span>
<span id="cb4-14">sol <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob, de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">saveat=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-15"></span>
<span id="cb4-16">mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(sol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>u,identity)</span>
<span id="cb4-17">udf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(mat))</span>
<span id="cb4-18">tudf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t=</span>sol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t), udf)</span>
<span id="cb4-19"></span>
<span id="cb4-20">tudflong <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(tudf, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, </span>
<span id="cb4-21">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, </span>
<span id="cb4-22">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>)</span>
<span id="cb4-23"></span>
<span id="cb4-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(tudf,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>t))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>V1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>V2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>V3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb4-29">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/diffeqr/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The ODE model can be sped up after compiling usng the just-in-time (JIT) compiler.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">prob_jit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> diffeqr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">jitoptimize_ode</span>(de, prob)</span>
<span id="cb5-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sol &lt;- de$solve(prob_jit, de$Tsit5(), saveat=1);</span></span></code></pre></div>
</div>
<p>The ODE model can be sped up even further by running it on the GPU. The <a href="https://github.com/SciML/diffeqr">GitHub page</a> is more geared toward the case in which runing the model multiple times over different initial conditions, which is called ensemble solve. This is why the term ensemble is used below. However, we use the same initial conditions as our sole purpose is to run the model multiple times and compare the elapsed time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">prob_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> (prob, i, rep){</span>
<span id="cb6-2">  de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remake</span>(prob, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">u0=</span>u0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p=</span>p)</span>
<span id="cb6-3">}</span>
<span id="cb6-4">prob_ens <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EnsembleProblem</span>(prob_jit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob_func=</span>prob_func, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">safetycopy=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb6-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sol &lt;- de$solve(prob_ens, de$Tsit5(), de$EnsembleSerial(), trajectories=1, saveat=1);</span></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to take the full advantage we need the following.</span></span>
<span id="cb6-7">degpu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> diffeqr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diffeqgpu_setup</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CUDA"</span>)</span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># de$solve(prob_ens, degpu$GPUTsit5(), degpu$EnsembleGPUKernel(degpu$CUDABackend()), trajectories=niter, saveat=1);</span></span></code></pre></div>
</div>
<p>I stop here but further performance enhancements are possible if your problem can make use of parallel computing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(microbenchmark)</span>
<span id="cb7-2">niter <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span></span>
<span id="cb7-3"></span>
<span id="cb7-4">benchmark <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">microbenchmark</span>(</span>
<span id="cb7-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">deSolve =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ode</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>u0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func=</span>sir_deSolve, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)), </span>
<span id="cb7-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">diffeqr =</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob, de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">saveat=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb7-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">diffeqr_jit =</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob_jit, de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">saveat=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb7-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">diffeqr_ens =</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob_ens, de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EnsembleSerial</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trajectories=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">saveat=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb7-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times=</span>niter</span>
<span id="cb7-10">)</span>
<span id="cb7-11"></span>
<span id="cb7-12">benchmark</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
        expr     min       lq      mean   median       uq       max neval cld
     deSolve 604.601 660.6515  735.1354 682.3505 707.7515    3790.8  1000   a
     diffeqr 769.601 799.1505  903.3603 831.7010 871.6505    5971.4  1000   a
 diffeqr_jit  84.501  99.2010  177.8533 112.8010 136.6005   46489.0  1000   a
 diffeqr_ens 185.601 216.7010 2667.6595 242.2505 277.0510 2389143.8  1000   a</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># GPU version requires a different framework to test the speed</span></span>
<span id="cb9-2">telapsed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">system.time</span>(de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob_ens, degpu<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">GPUTsit5</span>(), degpu<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">EnsembleGPUKernel</span>(degpu<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">CUDABackend</span>()), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">trajectories=</span>niter, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">saveat=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb9-3"></span>
<span id="cb9-4">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">routine=</span>benchmark<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>expr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time=</span>benchmark<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time)</span>
<span id="cb9-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_violin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>routine,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>time))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_log10</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e8</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept=</span>telapsed[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>telapsed[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, </span>
<span id="cb9-11">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"diffeqr"</span>,</span>
<span id="cb9-12">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GPU diffeqr"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/diffeqr/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("diffeqr_benchmark.png", gg, units="in", width=3.4*2, height=2.7*2)  </span></span></code></pre></div>
</div>


</section>

 ]]></description>
  <category>differential equation</category>
  <category>julia</category>
  <category>DifferentialEquations.jl</category>
  <category>diffeqr</category>
  <guid>https://kimfinale.github.io/myblog/posts/diffeqr/index.html</guid>
  <pubDate>Sun, 14 Jan 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/diffeqr/diffeqr_benchmark.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Universal differential equation using Julia</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/index.html</link>
  <description><![CDATA[ 




<section id="universal-differential-equation-ude" class="level3">
<h3 class="anchored" data-anchor-id="universal-differential-equation-ude">Universal differential equation (UDE)</h3>
<p>The <a href="https://docs.sciml.ai/Overview/stable/showcase/missing_physics/">UDE</a> refers to an approach to embed the machine learning into differential equations. The resulting UDE has some parts of the equation replaced by <strong>universal approximators</strong> i.e., neural network (NN). The UDE model approach allows us to approximate a wide, if not infinite, variety of functional relationships. As an example, I will test how well the UDE model approach will approximate a <a href="https://www.jonghoonk.com/posts/sub-exponential-growth/index.html">sub-exponential growth model</a>, which is challenging to fit if we use an exponential growth model.</p>
<p>I am using Julia for the UDE approach as it appeared that the Julia is the most advanced in this regard.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># SciML (Scientific Machine Learning) Tools</span></span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">OrdinaryDiffEq</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">SciMLSensitivity</span></span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Optimization</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">OptimizationOptimisers</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">OptimizationOptimJL</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Standard Libraries</span></span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">LinearAlgebra</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Statistics</span></span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># External Libraries</span></span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">ComponentArrays</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Lux</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Zygote</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Plots</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">StableRNGs</span></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gr</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Plots.GRBackend()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"></span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set a random seed for reproducible behaviour</span></span>
<span id="cb3-3">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">StableRNG</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1111</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>StableRNGs.LehmerRNG(state=0x000000000000000000000000000008af)</code></pre>
</div>
</div>
</section>
<section id="data-generation" class="level3">
<h3 class="anchored" data-anchor-id="data-generation">Data generation</h3>
<p>The SIR model with a sub-exponential growth is used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sir_subexp!</span>(du, u, p, t)</span>
<span id="cb5-2">    α, β, γ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p </span>
<span id="cb5-3">    du[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> β<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>α</span>
<span id="cb5-4">    du[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> β<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>α <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> γ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb5-5">    du[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> γ<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb5-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>sir_subexp! (generic function with 1 method)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"></span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the experimental parameter</span></span>
<span id="cb7-3">tspan <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">20.0</span>);</span>
<span id="cb7-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># u0 = 5.0f0 * rand(rng, 2)</span></span>
<span id="cb7-5">u0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>];</span>
<span id="cb7-6">p_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>];</span>
<span id="cb7-7">prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ODEProblem</span>(sir_subexp!, u0, tspan, p_);</span>
<span id="cb7-8">solution <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), abstol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-12</span>, reltol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-12</span>, saveat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>);</span>
<span id="cb7-9"></span>
<span id="cb7-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add noise in terms of the mean</span></span>
<span id="cb7-11">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Array</span>(solution);</span>
<span id="cb7-12">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> solution.t;</span>
<span id="cb7-13"></span>
<span id="cb7-14">xbar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(X, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>);   </span>
<span id="cb7-15">noise_magnitude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-2</span>;</span>
<span id="cb7-16">Xn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.+</span> (noise_magnitude <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> xbar) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">randn</span>(rng, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eltype</span>(X), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">size</span>(X));</span>
<span id="cb7-17"></span>
<span id="cb7-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(solution, alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>black, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Data"</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>]);</span>
<span id="cb7-19"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scatter!</span>(t, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transpose</span>(Xn), color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>red, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Noisy Data"</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>])</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/index_files/figure-html/unnamed-chunk-2-J1.png" class="img-fluid" width="300"></p>
</div>
</div>
</section>
<section id="ude-model" class="level3">
<h3 class="anchored" data-anchor-id="ude-model">UDE model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Let's define our Universal Differential eqution</span></span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbf</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">-</span>(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.^</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>));</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multilayer FeedForward</span></span>
<span id="cb8-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Lux.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Chain</span>(Lux.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Dense</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, rbf), Lux.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Dense</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, rbf), </span>
<span id="cb8-6">Lux.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Dense</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, rbf), Lux.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Dense</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain(
    layer_1 = Dense(3 =&gt; 5, rbf),       # 20 parameters
    layer_2 = Dense(5 =&gt; 5, rbf),       # 30 parameters
    layer_3 = Dense(5 =&gt; 5, rbf),       # 30 parameters
    layer_4 = Dense(5 =&gt; 1),            # 6 parameters
)         # Total: 86 parameters,
          #        plus 0 states.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the initial parameters and state variables of the model</span></span>
<span id="cb10-2">p, st <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Lux.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">setup</span>(rng, U)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>((layer_1 = (weight = Float32[-0.11597705 -0.5499123 0.10071843; -0.20088743 0.5602648 0.2718303; … ; -0.22440201 -0.57859105 0.7904316; -0.4619576 -0.62989676 0.18545352], bias = Float32[0.0; 0.0; … ; 0.0; 0.0;;]), layer_2 = (weight = Float32[-0.043933477 -0.21508422 … 0.55779475 0.5849693; 0.0011237671 0.006483868 … 0.27549765 -0.2874395; … ; 0.5079049 -0.36002874 … 0.41297784 -0.5777891; -0.5179172 -0.60432595 … -0.18625909 0.06577149], bias = Float32[0.0; 0.0; … ; 0.0; 0.0;;]), layer_3 = (weight = Float32[0.21934992 0.20916325 … -0.357856 -0.27426103; 0.59777355 -0.04514681 … 0.22668682 0.73459923; … ; 0.36797842 0.13955377 … 0.28912562 0.20840885; -0.33154675 0.035615936 … 0.011346816 -0.13401343], bias = Float32[0.0; 0.0; … ; 0.0; 0.0;;]), layer_4 = (weight = Float32[-0.49593353 -0.68478346 … -0.4632702 -0.1476636], bias = Float32[0.0;;])), (layer_1 = NamedTuple(), layer_2 = NamedTuple(), layer_3 = NamedTuple(), layer_4 = NamedTuple()))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">const</span> _st <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> st</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(layer_1 = NamedTuple(), layer_2 = NamedTuple(), layer_3 = NamedTuple(), layer_4 = NamedTuple())</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"></span>
<span id="cb14-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the hybrid model</span></span>
<span id="cb14-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ude_dynamics!</span>(du, u, p, t, p_true)</span>
<span id="cb14-4">    û <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">U</span>(u, p, _st)[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Network prediction</span></span>
<span id="cb14-5">    du[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> û[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb14-6">    du[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dI <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> û[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p_true[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] </span>
<span id="cb14-7">    du[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p_true[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] </span>
<span id="cb14-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ude_dynamics! (generic function with 1 method)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"></span>
<span id="cb16-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Closure with the known parameter</span></span>
<span id="cb16-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_dynamics!</span>(du, u, p, t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ude_dynamics!</span>(du, u, p, t, p_)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>nn_dynamics! (generic function with 1 method)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the problem</span></span>
<span id="cb18-2">prob_nn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ODEProblem</span>(nn_dynamics!, Xn[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], tspan, p)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ODEProblem with uType Vector{Float64} and tType Float64. In-place: true
timespan: (0.0, 20.0)
u0: 3-element Vector{Float64}:
 1.0239505612968622
 0.0034985090690380412
 0.00031492340046744696</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"></span>
<span id="cb20-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I don't understand the details of the algorithm</span></span>
<span id="cb20-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sensealg=QuadratureAdjoint(autojacvec=ReverseDiffVJP(true))</span></span>
<span id="cb20-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I just adopted what's provided in the web page: </span></span>
<span id="cb20-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://docs.sciml.ai/Overview/stable/showcase/missing_physics/</span></span>
<span id="cb20-6">    </span>
<span id="cb20-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(θ, X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Xn[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t)</span>
<span id="cb20-8">    _prob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remake</span>(prob_nn, u0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X, tspan <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (T[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], T[<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span>]), p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> θ)</span>
<span id="cb20-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Array</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(_prob, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), saveat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T,</span>
<span id="cb20-10">                abstol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>, reltol <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>,</span>
<span id="cb20-11">                sensealg<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">QuadratureAdjoint</span>(autojacvec<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ReverseDiffVJP</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">true</span>))))</span>
<span id="cb20-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>predict (generic function with 3 methods)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb22-1"></span>
<span id="cb22-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss</span>(θ)</span>
<span id="cb22-3">    Xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(θ)</span>
<span id="cb22-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(abs2, Xn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> Xhat)</span>
<span id="cb22-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>loss (generic function with 1 method)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"></span>
<span id="cb24-2">losses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">Float64</span>[];</span>
<span id="cb24-3"></span>
<span id="cb24-4">callback <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> (p, l)</span>
<span id="cb24-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">push!</span>(losses, l)</span>
<span id="cb24-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(losses) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb24-7">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">println</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Current loss after </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(losses))<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> iterations: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>(losses[<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span>])<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb24-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span>
<span id="cb24-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">false</span></span>
<span id="cb24-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#125 (generic function with 1 method)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"></span>
<span id="cb26-2">adtype <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Optimization.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">AutoZygote</span>();</span>
<span id="cb26-3">optf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Optimization.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">OptimizationFunction</span>((x, p) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss</span>(x), adtype);</span>
<span id="cb26-4">optprob <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Optimization.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">OptimizationProblem</span>(optf, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ComponentVector</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">{Float64}</span>(p));</span>
<span id="cb26-5"></span>
<span id="cb26-6">mxiter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>2000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1">res1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Optimization.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(optprob, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ADAM</span>(), callback <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> callback, maxiters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mxiter);</span>
<span id="cb28-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">println</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Training loss after </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(losses))<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> iterations: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>(losses[<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span>])<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training loss after 2001 iterations: 0.0015564208688977953</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"></span>
<span id="cb30-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># You can optimize further by using LBFGS</span></span>
<span id="cb30-3">optprob2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Optimization.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">OptimizationProblem</span>(optf, res1.u)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>OptimizationProblem. In-place: true
u0: ComponentVector{Float64}(layer_1 = (weight = [-0.05170182389781148 -0.6044817578829536 0.030221881765418415; -0.3212356181883164 0.6510350091355674 0.44802414727952533; … ; -0.2971002151491799 -0.5198718000300768 0.8494439396527995; -0.5240838499404261 -0.5805885464635301 0.2207764494806622], bias = [0.07034258756546354; -0.1248750018555649; … ; -0.10460911230309018; -0.09231330051973555;;]), layer_2 = (weight = [-0.16444552836939919 -0.3914934840987012 … 0.4595876886814785 0.48596336484236335; 0.061104866379551544 0.09809356182285524 … 0.3325709332030265 -0.23929486434292638; … ; 0.44222617028560024 -0.07489082174986872 … 0.38613240122330794 -0.609809451956525; -0.42554673750885325 -0.3912678259711914 … -0.0705070098211834 0.1835005315863163], bias = [-0.1024237112798211; 0.05522672749980388; … ; -0.06460784045513147; 0.08515934187060795;;]), layer_3 = (weight = [0.30753421402720227 0.29471143354807966 … -0.26966507778103693 -0.19068344291262843; 0.6803575575882911 0.035025314411197044 … 0.3095389929940732 0.8122600471132518; … ; 0.4338542747330682 0.20165221719458867 … 0.3525999208278827 0.27010233878411616; -0.20708092822357524 0.1890743367618981 … 0.16598038476857452 -0.0012012794517766243], bias = [0.0853924513699166; 0.08006728472122455; … ; 0.061942487865868964; 0.1530663635694471;;]), layer_4 = (weight = [-0.4208452558700493 -0.6144846254336126 … -0.40340199958423073 -0.06553529479079494], bias = [0.09174711461758511;;]))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1">res2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Optimization.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(optprob2, Optim.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">LBFGS</span>(), callback <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> callback, maxiters <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>);</span>
<span id="cb32-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">println</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final training loss after </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(losses))<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> iterations: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>(losses[<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span>])<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Final training loss after 3002 iterations: 0.0003723725121765437</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb34-1"></span>
<span id="cb34-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rename the best candidate</span></span>
<span id="cb34-3">p_trained <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res2.u</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ComponentVector{Float64}(layer_1 = (weight = [0.1316220200349473 -0.6520282050791907 0.008318466489230203; -0.4557052571206415 0.852778797405868 0.6422456105470944; … ; -0.3017967416294747 -0.3539416097805037 0.9435890641280813; -0.6208672577811719 -0.8250782773685028 0.463368746591991], bias = [0.1811403798125198; 0.1295565740621664; … ; 0.14387087901155535; -0.1883283800836187;;]), layer_2 = (weight = [-0.5224273510619183 -0.7851736034397837 … 0.13246567539583712 0.28492163069656595; 0.2121727337798046 0.2580716617374057 … 0.46828242306889367 -0.18639886649813667; … ; 0.31182369287889583 -0.13443324204943075 … 0.18614501798809488 -0.9123175434094871; -0.5023288426177288 -0.4943627237480249 … -0.05984671314326837 0.14167837142544432], bias = [-0.4580492880391406; 0.2156300092628208; … ; -0.18292941364366094; 0.014071394516324979;;]), layer_3 = (weight = [0.17533364576159247 0.2053893580840498 … -0.3080681971901958 -0.3356279391033146; 0.7087531824294593 0.0960694141143031 … 0.3481334453513509 0.8277491605925765; … ; 0.4365583552750147 0.20075642462931304 … 0.37058208065336945 0.2762370994412038; -0.18955475880245964 0.23766428666711154 … 0.23703263569676214 0.011769794045616492], bias = [-0.11836077082556237; 0.07082483083187767; … ; 0.058396858004157386; 0.15828264366434497;;]), layer_4 = (weight = [-0.39882746395912166 -0.6321529793894407 … -0.38424206982191056 -0.18894617437931902], bias = [0.4328709022831265;;]))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb36-1"></span>
<span id="cb36-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the losses</span></span>
<span id="cb36-3">pl_losses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>mxiter, losses[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>mxiter], yaxis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>log10, xaxis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>log10,</span>
<span id="cb36-4">                 xlabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Iterations"</span>, ylabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss"</span>, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ADAM"</span>, color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>blue)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/index_files/figure-html/unnamed-chunk-3-J1.png" class="img-fluid" width="300"></p>
</div>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>((mxiter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(losses), losses[(mxiter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span>], yaxis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>log10, xaxis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>log10,</span>
<span id="cb37-2">      xlabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Iterations"</span>, ylabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loss"</span>, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"BFGS"</span>, color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>red)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/index_files/figure-html/unnamed-chunk-3-J2.png" class="img-fluid" width="300"></p>
</div>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb38-1"></span>
<span id="cb38-2"></span>
<span id="cb38-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Analysis of the trained network</span></span>
<span id="cb38-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the data and the approximation</span></span>
<span id="cb38-5">ts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">first</span>(solution.t)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(solution.t)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">last</span>(solution.t)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.0:0.5:20.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb40-1">Xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(p_trained, Xn[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], ts)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3×41 Matrix{Float64}:
 1.02395      1.0072      0.991471    …  0.150335  0.140635  0.13015
 0.00349851   0.0190933   0.0322405      0.163083  0.156799  0.151863
 0.000314923  0.00146965  0.00405242     0.714346  0.73033   0.745751</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb42-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Trained on noisy data vs real solution</span></span>
<span id="cb42-2">pl_trajectory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(ts, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transpose</span>(Xhat), xlabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t"</span>, </span>
<span id="cb42-3">                     ylabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S(t), I(t), R(t)"</span>, color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>red,</span>
<span id="cb42-4">                     label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UDE Approximation"</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>])</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/index_files/figure-html/unnamed-chunk-3-J3.png" class="img-fluid" width="300"></p>
</div>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scatter!</span>(solution.t, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transpose</span>(Xn), color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>black, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Measurements"</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>])</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/index_files/figure-html/unnamed-chunk-3-J4.png" class="img-fluid" width="300"></p>
</div>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb44-1"></span>
<span id="cb44-2"></span>
<span id="cb44-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ideal unknown interactions of the predictor</span></span>
<span id="cb44-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ybar = [-p_[2] * (Xhat[1, :] .* Xhat[2, :])'; p_[3] * (Xhat[1, :] .* Xhat[2, :])']</span></span>
<span id="cb44-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ybar = [p_[2] .* Xhat[1,:] .* (Xhat[2,:].^p_[1])]</span></span>
<span id="cb44-6">Ybar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transpose</span>([p_[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Xhat[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (Xhat[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,i]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.^</span>p_[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) for i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">∈</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">41</span>, j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">∈</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1×41 transpose(::Matrix{Float64}) with eltype Float64:
 0.00444064  0.0169778  0.0254133  …  0.0140944  0.012777  0.0115257</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Neural network guess</span></span>
<span id="cb46-2">Yhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">U</span>(Xhat, p_trained, st)[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1×41 Matrix{Float64}:
 0.0351306  0.0321994  0.0309596  …  0.018876  0.0200484  0.0220433</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb48-1"></span>
<span id="cb48-2">pl_reconstruction <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(ts, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transpose</span>(Yhat), xlabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t"</span>, </span>
<span id="cb48-3">                         ylabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"U(S,I,R)"</span>, color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>red,</span>
<span id="cb48-4">                         label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"UDE Approximation"</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>]);</span>
<span id="cb48-5"></span>
<span id="cb48-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot!</span>(ts, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transpose</span>(Ybar), color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>black, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Interaction"</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>])</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/index_files/figure-html/unnamed-chunk-3-J5.png" class="img-fluid" width="300"></p>
</div>
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb49-1"></span>
<span id="cb49-2"></span>
<span id="cb49-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the error</span></span>
<span id="cb49-4">pl_reconstruction_error <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(ts, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">norm</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eachcol</span>(Ybar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Yhat)), yaxis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>log, xlabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t"</span>,</span>
<span id="cb49-5">                               ylabel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L2-Error"</span>, label <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">nothing</span>, color <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>red);</span>
<span id="cb49-6">pl_missing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(pl_reconstruction, pl_reconstruction_error, layout <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>));</span>
<span id="cb49-7"></span>
<span id="cb49-8">pl_overall <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(pl_trajectory, pl_missing)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/index_files/figure-html/unnamed-chunk-3-J6.png" class="img-fluid" width="300"></p>
</div>
</div>


</section>

 ]]></description>
  <category>universal differential equation</category>
  <category>julia</category>
  <category>sub-exponential growth</category>
  <guid>https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/index.html</guid>
  <pubDate>Thu, 11 Jan 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/universal_differential_eqn_julia/ude_obs.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>Template</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/oral_cholera_vacc_cov/index.html</link>
  <description><![CDATA[ 




<section id="oral-cholera-vaccine" class="level3">
<h3 class="anchored" data-anchor-id="oral-cholera-vaccine">Oral cholera vaccine</h3>
<p>Assumption - Vaccination is implemented in a all-or-nothing fashion - Two-dose efficacy is <img src="https://latex.codecogs.com/png.latex?VE"> - The first-dose efficacy is <img src="https://latex.codecogs.com/png.latex?ve_1"></p>
<p>What the efficacy of the second vaccine dose, <img src="https://latex.codecogs.com/png.latex?ve_2">, has to be if the want the same number of people is averted,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to make it reproducible</span></span>
<span id="cb1-2">N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-3">VE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vaccine efficacy under two dose regimen</span></span>
<span id="cb1-4">vacc_cov <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vaccine coverage</span></span>
<span id="cb1-5">ve1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># efficacy of the first dose</span></span>
<span id="cb1-6"></span>
<span id="cb1-7">vacc_protected_VE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> VE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>vacc_cov<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N</span>
<span id="cb1-8">vacc_protected_ve1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ve1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>vacc_cov<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N</span>
<span id="cb1-9">vacc_protected_ve_ve2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> vacc_protected_ve1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (VE<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>ve1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>vacc_cov<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N</span></code></pre></div>
</div>
</section>
<section id="implementing-the-first-and-the-seocond-dose-separately" class="level3">
<h3 class="anchored" data-anchor-id="implementing-the-first-and-the-seocond-dose-separately">Implementing the first and the seocond dose separately</h3>
<p>Suppose that a population size is <img src="https://latex.codecogs.com/png.latex?N"> and the vaccine coverage, <img src="https://latex.codecogs.com/png.latex?0%3C=v%3C=1">. We introduce a parameter, <img src="https://latex.codecogs.com/png.latex?%5Cpi">, to represent the proportion of the first-dose recipients who receive the second dose. If <img src="https://latex.codecogs.com/png.latex?%5Cpi=1">, the number of vaccine recipients is <img src="https://latex.codecogs.com/png.latex?Nv"> and the number of two-dose recipients is also <img src="https://latex.codecogs.com/png.latex?Nv"> and the number of vaccinees who only received a single dose is zero. More generally, however, if <img src="https://latex.codecogs.com/png.latex?%5Cpi%20%3C%201">, the number of complete two-dose recipients is <img src="https://latex.codecogs.com/png.latex?Nv%5Cpi"> and those who have only received one dose is <img src="https://latex.codecogs.com/png.latex?2Nv(1-%5Cpi)">.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to make it reproducible</span></span>
<span id="cb2-2">N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb2-3">ve2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vaccine efficacy under two dose regimen</span></span>
<span id="cb2-4">ve1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># efficacy of the first dose</span></span>
<span id="cb2-5">vacc_cov <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vaccine coverage</span></span>
<span id="cb2-6">pi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># proportion of the first-dose recipients who again received the second dose</span></span>
<span id="cb2-7">vacc_protected_ve2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ve2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>vacc_cov<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N</span>
<span id="cb2-8">vacc_protected_ve1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> ve1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>vacc_cov<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N</span>
<span id="cb2-9">vacc_protected_ve1_ve2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> </span>
<span id="cb2-10">  pi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(vacc_protected_ve1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (ve2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>ve1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>vacc_cov<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pi)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ve1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>vacc_cov<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N</span>
<span id="cb2-11"></span>
<span id="cb2-12">vacc_protected_ve1</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 240</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">vacc_protected_ve1_ve2</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 480</code></pre>
</div>
</div>
<p>These are estimates and algebraic relationship wouldn’t hold. $$ <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0Ac_2%20&amp;=%20v_1%20%5Cpi%20%5C%5C%0Ac_%7B1+%7D%20&amp;=%20v_1%20%5Cpi%20+%20v_1(1-%5Cpi)%20+%20v_2(1-%5Cpi%20v_1/v_2)%0A%0A%5Cend%7Balign%7D"> $$ <img src="https://latex.codecogs.com/png.latex?c_2"> and <img src="https://latex.codecogs.com/png.latex?c_%7B1+%7D"> represent coverage for complete two-dose regiment and at least one dose, respectively. <img src="https://latex.codecogs.com/png.latex?%5Cpi"> represents the proportion of the vaccinees who received the first dose and went on to receive the second dose.</p>
<p>Estimates from Pezzolli et al.&nbsp;(2020)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">cov_first <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">90.3</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># v_1</span></span>
<span id="cb6-2">cov_second <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">88.2</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># v_2</span></span>
<span id="cb6-3">cov_two <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">69.9</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#c_2</span></span>
<span id="cb6-4">cov_one_plus <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">84.6</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#c_1+</span></span></code></pre></div>
</div>
<p>Boundary conditions for the pi for the vr1plus must not be bigger than 1</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create a function that calculates </span></span>
<span id="cb7-2">ocv_round_cov_calc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vc1=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vc2=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vr1plus=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vr2=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pi=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>){</span>
<span id="cb7-3">  </span>
<span id="cb7-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (pi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (vc1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>vc2<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>vc1) {</span>
<span id="cb7-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pi must be larger than (vc1+vc2-1)/vc1, "</span>, (vc1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>vc2<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>vc1))</span>
<span id="cb7-6">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (pi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> (vc2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>vc1)) {</span>
<span id="cb7-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pi must be smaller than vc2/vc1, "</span>, vc2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>vc1))</span>
<span id="cb7-8">  }</span>
<span id="cb7-9">  vr2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> vc1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pi  </span>
<span id="cb7-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vr1plus = vc1*pi + vc1*(1-pi) + vc2*(1-pi*vc1/vc2)</span></span>
<span id="cb7-11">  vr1plus <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> vr2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> vc1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pi) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> vc2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>vc1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>vc2) </span>
<span id="cb7-12">  vr1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> vr1plus <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> vr2</span>
<span id="cb7-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># </span><span class="al" style="color: #AD0000;
background-color: null;
font-style: inherit;">TODO</span><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"> there are several limiting conditions</span></span>
<span id="cb7-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vaccine coverage is </span></span>
<span id="cb7-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vr1plus=</span>vr1plus, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vr2=</span>vr2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vr1=</span>vr1))</span>
<span id="cb7-16">}</span>
<span id="cb7-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ocv_round_cov_calc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vc1=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.56</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vc2=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.46</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vr1plus=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vr2=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pi=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.80</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$vr1plus
[1] 0.572

$vr2
[1] 0.448

$vr1
[1] 0.124</code></pre>
</div>
</div>
<p>When the first dose is distributed, apply the When the second dose is distributed, identify the number of two-dose and one-dose recipients and compare that number with the previous round</p>
</section>
<section id="summarize-results" class="level3">
<h3 class="anchored" data-anchor-id="summarize-results">Summarize results</h3>


</section>

 ]]></description>
  <category>oral cholera vaccine</category>
  <category>all-or-nothing</category>
  <category>vaccine efficacy</category>
  <guid>https://kimfinale.github.io/myblog/posts/oral_cholera_vacc_cov/index.html</guid>
  <pubDate>Mon, 08 Jan 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/oral_cholera_vacc_cov/sample_figure.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Fitting a straight line in Julia: Flux machine learning</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/fit_a_straight_line_julia/index.html</link>
  <description><![CDATA[ 




<section id="fitting-a-straight-line-in-julia" class="level3">
<h3 class="anchored" data-anchor-id="fitting-a-straight-line-in-julia">Fitting a straight line in Julia</h3>
<p>This post is my attempt to learn machine learning in Julia. The contents of this page came from the <a href="https://fluxml.ai/Flux.jl/stable/models/overview/">Flux</a>. <code>Flux</code> is a machine learning package written in Julia.</p>
</section>
<section id="create-training-and-test-data" class="level3">
<h3 class="anchored" data-anchor-id="create-training-and-test-data">Create training and test data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Flux</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Distributions</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Random</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Statistics</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create the data</span></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># true parameter values are 4 and 2</span></span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">linear_model</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rand</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Normal</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))[<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>linear_model (generic function with 1 method)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"></span>
<span id="cb3-2">x_train, x_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hcat</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hcat</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">...</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>([0 1 … 4 5], [6 7 … 9 10])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb5-1">y_train, y_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">linear_model</span>.(x_train), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">linear_model</span>.(x_test)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>([1.552234290757838 5.997621972031162 … 17.799006293669162 21.987462504032138], [26.82759499486528 28.113859596390927 … 38.71844108675521 43.89937704938766])</code></pre>
</div>
</div>
</section>
<section id="create-a-neural-network-model-with-a-single-layer" class="level3">
<h3 class="anchored" data-anchor-id="create-a-neural-network-model-with-a-single-layer">Create a neural network model with a single layer</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># y = σ.(W * x .+ bias) </span></span>
<span id="cb7-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Flux.<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Dense</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2 parameters</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dense(1 =&gt; 1)       # 2 parameters</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prediction based on the untrained baseline model </span></span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model</span>(x_train)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1×6 Matrix{Float32}:
 0.0  -0.230685  -0.461369  -0.692054  -0.922739  -1.15342</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"></span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define the loss function to use it for training</span></span>
<span id="cb11-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss</span>(m, x, y) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs2</span>.(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">m</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.-</span> y))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>loss (generic function with 1 method)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss</span>(model, x_train, y_train)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>214.52561035758617</code></pre>
</div>
</div>
</section>
<section id="train-the-model" class="level3">
<h3 class="anchored" data-anchor-id="train-the-model">Train the model</h3>
<p><code>Flux</code> package has the <code>Flux.train!</code> function for model training. The function requires an optimizer, which can be, for example, created using <code>Descent</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">using</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">Flux</span>: train!</span>
<span id="cb15-2"></span>
<span id="cb15-3">opt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Descent</span>() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gradient descent algorithm </span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Descent(0.1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Descent</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Descent(0.1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"></span>
<span id="cb19-2">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(x_train, y_train)]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1-element Vector{Tuple{Matrix{Int64}, Matrix{Float64}}}:
 ([0 1 … 4 5], [1.552234290757838 5.997621972031162 … 17.799006293669162 21.987462504032138])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"></span>
<span id="cb21-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train!</span>(loss, model, data, opt)</span>
<span id="cb21-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss</span>(model, x_train, y_train)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>203.61293290763626</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"></span>
<span id="cb23-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check model parameters after going through the data once</span></span>
<span id="cb23-3">model.weight, model.bias</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Float32[8.607251;;], Float32[2.5395057])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"></span>
<span id="cb25-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># iteratively train the model</span></span>
<span id="cb25-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> epoch <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span></span>
<span id="cb25-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">train!</span>(loss, model, data, opt)</span>
<span id="cb25-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">end</span></span></code></pre></div>
</div>
</section>
<section id="examine-the-trained-model" class="level3">
<h3 class="anchored" data-anchor-id="examine-the-trained-model">Examine the trained model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check the loss</span></span>
<span id="cb26-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loss</span>(model, x_train, y_train)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.19602860021782811</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check the model parameters</span></span>
<span id="cb28-2">model.weight, model.bias</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Float32[4.0600896;;], Float32[2.0363088])</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check the model against the test data set</span></span>
<span id="cb30-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model</span>(x_test)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1×5 Matrix{Float32}:
 26.3968  30.4569  34.517  38.5771  42.6372</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1">y_test</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1×5 Matrix{Float64}:
 26.8276  28.1139  33.7393  38.7184  43.8994</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>julia</category>
  <category>Flux</category>
  <category>linear model</category>
  <guid>https://kimfinale.github.io/myblog/posts/fit_a_straight_line_julia/index.html</guid>
  <pubDate>Wed, 03 Jan 2024 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/fit_a_straight_line_julia/flux_logo.png" medium="image" type="image/png" height="49" width="144"/>
</item>
<item>
  <title>Cholera SEIR equation</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/cholera_seir_eqn/index.html</link>
  <description><![CDATA[ 




<section id="cholera-seir-equation" class="level3">
<h3 class="anchored" data-anchor-id="cholera-seir-equation">Cholera SEIR equation</h3>
<p>[ <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0A%5Clambda_p%20&amp;=%20%5Cfrac%7B%5Cbeta(I_1+I_2+%20(1-%5Cpsi_1)%20%20(I_1%5EO+I_2%5EO)+%20(1-%5Cpsi_2)%20(I_1%5ET+I_2%5ET))%7D%7BN%7D%5C%5C%0A%5Cmathrm%7Bd%7DS/%5Cmathrm%7Bd%7Dt%20&amp;=%20-%20(%5Clambda_p+%5Clambda_w)S%20+%202%20%5Comega%20R_2%20%5C%5C%0A%5Cmathrm%7Bd%7DE_1/%5Cmathrm%7Bd%7Dt%20&amp;=%20(%5Clambda_p+%5Clambda_w)S%20-%202%5Cepsilon%20E_1%5C%5C%0A%5Cmathrm%7Bd%7DE_2/%5Cmathrm%7Bd%7Dt%20&amp;=%202%5Cepsilon%20E_1%20-%202%5Cepsilon%20E_2%20%5C%5C%0A%5Cmathrm%7Bd%7DI_1/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20(1-%5Ctheta)%20%5Cepsilon%20E_2%20-%202%20%5Cgamma%20I_1%20%5C%5C%0A%5Cmathrm%7Bd%7DI_2/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Cgamma%20I_1%20-%202%20%5Cgamma%20I_2%20%5C%5C%0A%5Cmathrm%7Bd%7DA_1/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Ctheta%20%5Cepsilon%20E_2%20-%202%20%5Cgamma%20A_1%20%5C%5C%0A%5Cmathrm%7Bd%7DA_2/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Cgamma%20A_1%20-%202%20%5Cgamma%20A_2%20%5C%5C%0A%5Cmathrm%7Bd%7DR_1/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Cgamma%20(I_2%20+%20A_2)%20-%202%20%5Comega%20R_1%20%5C%5C%0A%5Cmathrm%7Bd%7DR_2/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Comega%20(R_1%20-%20R_2)%20%5C%5C%0A%0A%5Cmathrm%7Bd%7DS%5EO/%5Cmathrm%7Bd%7Dt%20&amp;=%20-%20(%5Clambda_p+%5Clambda_w)S%5EO%20+%202%20%5Comega%20R_2%5EO%20+%202%20%5Comega_V%20O_2%20%5C%5C%0A%5Cmathrm%7Bd%7DO_1/%5Cmathrm%7Bd%7Dt%20&amp;=%20+%20v%5EO%20S%20-%202%20%5Comega_V%20O_1%20-%20(%5Clambda_p+%5Clambda_w)(1-%5Cchi%5EO)%20O_1%20%5C%5C%0A%5Cmathrm%7Bd%7DO_2/%5Cmathrm%7Bd%7Dt%20&amp;=%20+%202%20%5Comega_V%20O_1%20-%202%20%5Comega_V%20O_2%20-%20(%5Clambda_p+%5Clambda_w)(1-%5Cchi%5EO)%20O_2%20%5C%5C%0A%5Cmathrm%7Bd%7DE_1%5EO/%5Cmathrm%7Bd%7Dt%20&amp;=%20(%5Clambda_p+%5Clambda_w)%20((1-%5Cchi%5EO)(O_1+O_2)%20+%20S%5EO)%20+%20v%5EO%20E_1%20-%20v%5ET%20E_1%5EO%20-%202%5Cepsilon%20E_1%5EO%5C%5C%0A%5Cmathrm%7Bd%7DE_2%5EO/%5Cmathrm%7Bd%7Dt%20&amp;=%202%5Cepsilon%20E_1%5EO%20-%202%5Cepsilon%20E_2%5EO%20+%20v%5EO%20E_2%20-%20v%5ET%20E_2%5EO%5C%5C%0A%5Cmathrm%7Bd%7DI_1%5EO/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20(1-%5Ctheta)%20%5Cepsilon%20E_2%5EO%20-%202%20%5Cgamma%20I_1%5EO%20%5C%5C%0A%5Cmathrm%7Bd%7DI_2%5EO/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Cgamma%20I_1%5EO%20-%202%20%5Cgamma%20I_2%5EO%20%5C%5C%0A%5Cmathrm%7Bd%7DA_1%5EO/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Ctheta%20%5Cepsilon%20E_2%5EO%20-%202%20%5Cgamma%20A_1%5EO%20+%20v%5EO%20A_1%20-%20v%5ET%20A_1%5EO%5C%5C%0A%5Cmathrm%7Bd%7DA_2%5EO/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Cgamma%20A_1%5EO%20-%202%20%5Cgamma%20A_2%5EO%20+%20v%5EO%20A_2%20-%20v%5ET%20A_2%5EO%5C%5C%0A%5Cmathrm%7Bd%7DR_1%5EO/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Cgamma%20(I_2%5EO%20+%20A_2%5EO)%20-%202%20%5Comega%20R_1%5EO%20+%20v%5EO%20R_1%20-%20v%5ET%20R_1%5EO%5C%5C%0A%5Cmathrm%7Bd%7DR_2%5EO/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Comega%20(R_1%5EO%20-%20R_2%5EO)%20+%20v%5EO%20R_2%20-%20v%5ET%20R_2%5EO%5C%5C%0A%0A%5Cmathrm%7Bd%7DS%5ET/%5Cmathrm%7Bd%7Dt%20&amp;=%20-%20(%5Clambda_p+%5Clambda_w)S%5ET%20+%202%20%5Comega%20R_2%5ET%20+%202%20%5Comega_V%20T_2%20%5C%5C%0A%5Cmathrm%7Bd%7DT_1/%5Cmathrm%7Bd%7Dt%20&amp;=%20+%20v%20S%5EO%20-%202%20%5Comega_V%20T_1%20-%20(%5Clambda_p+%5Clambda_w)(1-%5Cchi%5ET)%20T_1%5C%5C%0A%5Cmathrm%7Bd%7DT_2/%5Cmathrm%7Bd%7Dt%20&amp;=%20+%202%20%5Comega_V%20T_1%20-%202%20%5Comega_V%20T_2%20-%20(%5Clambda_p+%5Clambda_w)(1-%5Cchi%5ET)%20T_2%5C%5C%0A%5Cmathrm%7Bd%7DE_1%5ET/%5Cmathrm%7Bd%7Dt%20&amp;=%20(%5Clambda_p+%5Clambda_w)(S%5ET%20+%20(1-%5Cchi%5ET)(T_1+T_2))%20-%0A%20%202%5Cepsilon%20E_1%5ET%20+%20v%5ET%20E_1%5EO%5C%5C%0A%5Cmathrm%7Bd%7DE_2%5ET/%5Cmathrm%7Bd%7Dt%20&amp;=%202%5Cepsilon%20E_1%5ET%20-%202%5Cepsilon%20E_2%5ET%20+%20v%5ET%20E_2%5EO%5C%5C%0A%5Cmathrm%7Bd%7DI_1%5ET/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20(1-%5Ctheta)%20%5Cepsilon%20E_2%5ET%20-%202%20%5Cgamma%20I_1%5ET%5C%5C%0A%5Cmathrm%7Bd%7DI_2%5ET/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Cgamma%20I_1%5ET%20-%202%20%5Cgamma%20I_2%5ET%20%5C%5C%0A%5Cmathrm%7Bd%7DA_1%5ET/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Ctheta%20%5Cepsilon%20E_2%5ET%20-%202%20%5Cgamma%20A_1%5ET%20+%20v%5ET%20A_1%5EO%20%5C%5C%0A%5Cmathrm%7Bd%7DA_2%5ET/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Cgamma%20A_1%5ET%20-%202%20%5Cgamma%20A_2%5ET%20+%20v%5ET%20A_2%5EO%20%5C%5C%0A%5Cmathrm%7Bd%7DR_1%5ET/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Cgamma%20(I_2%5ET%20+%20A_2%5ET)%20-%202%20%5Comega%20R_1%5ET%20+%20v%5ET%20R_1%5EO%20%5C%5C%0A%5Cmathrm%7Bd%7DR_2%5ET/%5Cmathrm%7Bd%7Dt%20&amp;=%202%20%5Comega%20(R_1%5ET%20-%20R_2%5ET)%20+%20v%5ET%20R_2%5EO%20%5C%5C%0A%0A%5Cend%7Balign%7D"> ]</p>


</section>

 ]]></description>
  <category>cholera</category>
  <category>sub-Saharan Africa</category>
  <guid>https://kimfinale.github.io/myblog/posts/cholera_seir_eqn/index.html</guid>
  <pubDate>Thu, 28 Dec 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/cholera_seir_eqn/sample_figure.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Critical vaccination threshold</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/critical_vacc_threshold/index.html</link>
  <description><![CDATA[ 




<p>The following <a href="https://academic.oup.com/cid/article/52/7/911/299077">article by Fine</a> provides a great introduction to the critical vaccination threshold.</p>
<section id="critical-vaccination-threshold" class="level4">
<h4 class="anchored" data-anchor-id="critical-vaccination-threshold">Critical vaccination threshold</h4>
<p>The simplest scenario would be to assume that individuals are well-mixed and vaccine recipients are completely protected from infection. For this scenario, the critical threshold for random vaccination, <img src="https://latex.codecogs.com/png.latex?V_c">, is as follows: <img src="https://latex.codecogs.com/png.latex?%0AV_c%20=%201-1/R_0%0A"> If vaccines are only partially protective and <img src="https://latex.codecogs.com/png.latex?E"> fraction of the vaccine recipients are completely protected, <img src="https://latex.codecogs.com/png.latex?V_c"> becomes as follows: <img src="https://latex.codecogs.com/png.latex?%0AV_c%20=%20%5Cfrac%7B1-1/R_0%7D%7BE%7D%0A"></p>
<p>I used the population <a href="https://population.un.org/wpp/Download/Standard/MostUsed/">World Population Prospects 2022</a>.</p>
</section>
<section id="plot-the-results" class="level4">
<h4 class="anchored" data-anchor-id="plot-the-results">Plot the results</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-2">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb1-4">R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-5">VE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb1-6">Vc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(VE, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1-1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R0)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1-1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R0)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>x, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))</span>
<span id="cb1-7"></span>
<span id="cb1-8">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span>R0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Vc1=</span>Vc[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Vc2=</span>Vc[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Vc3=</span>Vc[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]])</span>
<span id="cb1-9"></span>
<span id="cb1-10">gg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> R0)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_rect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.78</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Vc3)),</span>
<span id="cb1-12">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pink"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>Vc3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"80%"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>Vc2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"60%"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>Vc1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40%"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_linetype_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vaccine efficacy"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"80%"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>,</span>
<span id="cb1-17">                                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"60%"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, </span>
<span id="cb1-18">                                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40%"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># labs(y="Critical vaccination threshold", x=expression(R[0])) +</span></span>
<span id="cb1-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Critical vaccination threshold (%), "</span>, V[C])), </span>
<span id="cb1-21">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Basic reproduction number, "</span>, R[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>),</span>
<span id="cb1-23">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>),</span>
<span id="cb1-24">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb1-25">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>)</span>
<span id="cb1-26"></span>
<span id="cb1-27">gg</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/critical_vacc_threshold/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("Vc_R0.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.15</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.78</span>)</span>
<span id="cb3-2">(Vc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1-1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R0)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1304348 0.6402878</code></pre>
</div>
</div>
</section>
<section id="india-simulation" class="level3">
<h3 class="anchored" data-anchor-id="india-simulation">India simulation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(data.table)</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readxl)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># d &lt;- read_xlsx("C:/Users/jonghoon.kim/Documents/myblog/posts/critical_vacc_threshold/WPP2022_POP_F01_1_POPULATION_SINGLE_AGE_BOTH_SEXES.xlsx", sheet= "Medium variant")</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># d2 &lt;- d[-(1:11),]</span></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># india &lt;- d2[(d2$...3 == "India" &amp; d2$...11 &gt; 2023),]</span></span>
<span id="cb5-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># names(india) &lt;- c(1:2, "country", 4:10 ,"year", paste0("age_", 0:100))</span></span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># saveRDS(india, "C:/Users/jonghoon.kim/Documents/myblog/posts/critical_vacc_threshold/WPP2022_India.rds")</span></span>
<span id="cb5-10"></span>
<span id="cb5-11">india <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C:/Users/jonghoon.kim/Documents/myblog/posts/critical_vacc_threshold/WPP2022_India.rds"</span>)</span>
<span id="cb5-12">india<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(india<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year)</span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># india[,paste0("age_", 0:100)] &lt;- as.numeric(india[,paste0("age_", 0:100)])</span></span>
<span id="cb5-14">india <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> india <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate_at</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age_"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>), as.numeric)</span>
<span id="cb5-15"></span>
<span id="cb5-16">yrs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2024</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2100</span></span>
<span id="cb5-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># simulate</span></span>
<span id="cb5-18">VE <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb5-19">prop_immune <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(yrs))</span>
<span id="cb5-20"></span>
<span id="cb5-21"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(yrs)) {</span>
<span id="cb5-22">  numerator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(india[india<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> yrs[i], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age_"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(i<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>))])</span>
<span id="cb5-23">  denominator <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(india[india<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> yrs[i], <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age_"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)])</span>
<span id="cb5-24">  prop_immune[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> numerator <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> denominator</span>
<span id="cb5-25">} </span>
<span id="cb5-26"></span>
<span id="cb5-27">existing_immune <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb5-28">pop_immune_ve <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(VE, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(z) <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>z<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>prop_immune)</span>
<span id="cb5-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add the existing immunity, assumed to be 15%</span></span>
<span id="cb5-30">pop_immune_ve_added <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(VE, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(z) <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>z<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>prop_immune <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> existing_immune)</span>
<span id="cb5-31"></span>
<span id="cb5-32">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">years=</span>yrs<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-2024</span>, </span>
<span id="cb5-33">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pi1=</span>pop_immune_ve[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], </span>
<span id="cb5-34">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pi2=</span>pop_immune_ve[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], </span>
<span id="cb5-35">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pi3=</span>pop_immune_ve[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]], </span>
<span id="cb5-36">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pi4=</span>pop_immune_ve_added[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], </span>
<span id="cb5-37">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pi5=</span>pop_immune_ve_added[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]], </span>
<span id="cb5-38">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pi6=</span>pop_immune_ve_added[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]])</span>
<span id="cb5-39"></span>
<span id="cb5-40">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb5-41"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb5-42"></span>
<span id="cb5-43"></span>
<span id="cb5-44">gg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> years)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_rect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">63</span>),</span>
<span id="cb5-46">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pink"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-47">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>pi3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"80%"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>pi2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"60%"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>pi1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40%"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>pi6, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"80%"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dark green"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>pi5, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"60%"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dark green"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>pi4, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40%"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dark green"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-53">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_linetype_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Vaccine efficacy"</span>, </span>
<span id="cb5-55">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"80%"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>,</span>
<span id="cb5-56">                                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"60%"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, </span>
<span id="cb5-57">                                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40%"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-58">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># labs(y="Critical vaccination threshold", x=expression(R[0])) +</span></span>
<span id="cb5-59">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Population immune (%)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Years since vaccination"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-60">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>),</span>
<span id="cb5-61">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>),</span>
<span id="cb5-62">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.text=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>), </span>
<span id="cb5-63">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>)</span>
<span id="cb5-64">gg</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/critical_vacc_threshold/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("immune_time.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>


</section>

 ]]></description>
  <category>vaccine</category>
  <category>population immunity</category>
  <category>critical vaccination threshold</category>
  <guid>https://kimfinale.github.io/myblog/posts/critical_vacc_threshold/index.html</guid>
  <pubDate>Wed, 13 Dec 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/critical_vacc_threshold/Vc_R0.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Generation interval</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/generation_interval1/index.html</link>
  <description><![CDATA[ 




<section id="generation-interval-incubation-period-infectious-period" class="level3">
<h3 class="anchored" data-anchor-id="generation-interval-incubation-period-infectious-period">Generation interval = incubation period + infectious period?</h3>
<p>Although not published, I wrote a correspondence to Lancet to commenting the <a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(20)30260-9/fulltext">article</a>. In the article, the authors stated that the generation interval is the sum of the incubation period and the infectious period. I argued that this statement holds only for a constant rate of transmission during the exponentially distributed infectious period (i.e., only a very limited case). Then, I showed that the generation interval varies if the infectious period distribution is different from the exponential distribution even with the constant rate of transmission. Following is the whole message. I now think I am glad that it was not published because I realized that <a href="https://www.sciencedirect.com/science/article/abs/pii/S0025556406002094?via%3Dihub">Svensson</a> wrote an article in 2007 to show a similar message in a more rigorous and general way. At least the message and arguments I presented were correct.</p>
</section>
<section id="the-main-text" class="level3">
<h3 class="anchored" data-anchor-id="the-main-text">The main text</h3>
<p>When confronted with a novel disease like the coronavirus disease 2019 (COVID-19), the incubation period and the serial interval are two critical epidemiological variables that are measured during the early stages of an outbreak. A transmission model can be constructed based on these variables to project potential scenarios of outbreak expansion or resolution and, importantly, define the basic reproduction number (<img src="https://latex.codecogs.com/png.latex?R_0">) for the disease. The recent article by <a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(20)30260-9/fulltext">Wu et al.</a>, published in The Lancet on January 31 of this year, one month after the first case was reported in Wuhan, China, uses a transmission model parameterized by data available at the time. This study provided important and timely insights into the spread of COVID-19 in China and elsewhere, concluding that, in addition to Wuhan, other major cities in China and well-connected cities outside China were likely to already have sustained localized outbreaks. The model utilized by Wu et al.&nbsp;makes a key statement, which has limited applications and may lead to unjustified assumptions in subsequent model iterations. The dynamic model requires an input on the length of the infectious period, which Wu et al.&nbsp;derived by assuming that the serial interval is equal to the sum of the infectious period and the latent period (on page 4 of the article by Wu et al.). Neither Wu et al.&nbsp;nor the <a href="https://www.science.org/doi/10.1126/science.1086616">study</a> to which they refer provides a clear rationale for this statement. The serial interval represents the time between the clinical onset of successive cases [3] and it is naturally expressed as the sum of the incubation period and disease age at transmission* <a href="https://link.springer.com/book/10.1007/978-90-481-2313-1">4</a>. Here we treat the incubation period (the time between infection and the onset of symptoms) as the same as latent period (the time between infection and the onset of infectiousness), for simplicity. The disease age at transmission represents the time between the onset of symptoms of a primary case and the time of infection of the associated secondary cases. Therefore, for the mean serial interval to be the same as the sum of mean incubation period and mean infectious period, the mean disease age at transmission must be equal to the mean infectious period. The mean disease age at transmission is indeed as long as the mean of the exponentially-distributed infectious period, which is often used for convenience in building a differential equation-based model (Table 1). However, for other distributions we explored, the mean disease age at transmission is shorter than mean infectious period, and it is only half of the mean infectious period† when the infectious period is constant. The gamma-distributed infectious period can also be easily adopted in a differential-equation based model to represent a more realistic representation of infectious period and in this case, following Wu et al.’s recipe will lead to a shorter serial interval than is intended. Moreover, each of the aforementioned arguments holds when transmission occurs at a constant rate over the infectious period, and violating this assumption of a constant rate (such as when viral load is high during the initial part of the infectious period and tapers off over time <a href="https://pubmed.ncbi.nlm.nih.gov/32080991/">5</a><a href="https://pubmed.ncbi.nlm.nih.gov/32074444/">6</a> will likely induce an even shorter disease age at transmission.</p>
<p>The assumption that the serial interval is the sum of incubation (or latent) period and infectious period seems to hold only when the infectious period is exponentially distributed for a constant transmission rate. For a wider application, one has to calculate the disease age at transmission that leads to a correct serial interval for a given distribution of the infectious period. We believe this is an important point and potentially unjustified assumptions in subsequent model iterations may result in providing outbreak responders with inaccurate projections on the characteristics of disease transmission.</p>
<p>Table 1. Time to infection since symptom onset under infectious period with different distributions.</p>
<table class="table">
<caption>Table 1. Time to infection since symptom onset under infectious period with different distributions.</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 14%">
<col style="width: 41%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th colspan="2">Infectious period</th>
<th colspan="2">Time to transmission (disease age)</th>
</tr>
<tr class="odd">
<th>Distribution</th>
<th>Expectation</th>
<th>Sample mean‡ [<img src="https://latex.codecogs.com/png.latex?2.5%5E%7Bth%7D">, <img src="https://latex.codecogs.com/png.latex?97.5%5E%7Bth%7D"> percentile]</th>
<th>Expectation§</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Exponential</td>
<td>5</td>
<td>5</td>
<td>5</td>
</tr>
<tr class="even">
<td>Gamma(2,5/2)¶</td>
<td>5</td>
<td>3.73 [3.75, 3.71]</td>
<td>3.75</td>
</tr>
<tr class="odd">
<td>Uniform(0,10)</td>
<td>5</td>
<td>3.34 [3.32, 3.35]</td>
<td>3.33</td>
</tr>
<tr class="even">
<td>Weibull(2,5/2)</td>
<td>5</td>
<td>3.17 [3.16, 3.19]</td>
<td>3.18</td>
</tr>
<tr class="odd">
<td>Lognormal(2,5/2)</td>
<td>5</td>
<td>2.90 [2.89, 2.91]</td>
<td>2.90</td>
</tr>
<tr class="even">
<td>Constant at 5</td>
<td>5</td>
<td>2.51 [2.49, 2.52]</td>
<td>2.50</td>
</tr>
</tbody>
</table>
<p>Footnotes *Taking statistical distribution into account, we can write the serial interval at time <img src="https://latex.codecogs.com/png.latex?t"> as the convolution of the distributions of disease age, <img src="https://latex.codecogs.com/png.latex?g">, and incubation period, <img src="https://latex.codecogs.com/png.latex?f">: <img src="https://latex.codecogs.com/png.latex?s(t)=%20%5Cint_0%5Et%20g(t-%5Ctau)f(%5Ctau)%5Ctextrm%7Bd%7D%5Ctau">. † Interestingly, the <a href="https://en.wikipedia.org/wiki/Serial_interval">Wikipedia article</a> says that the length of a serial interval is equal to the sum of incubation period and the half of the infectious period <a href="https://en.wikipedia.org/wiki/Serial_interval">7</a>. ‡To simulate disease age, we drew a random infectious period from each distribution and let transmission occur at a constant probability with R0 of 2.2 over the infectious period. We repeated the process 100000 times to calculate a mean and a <img src="https://latex.codecogs.com/png.latex?2.5%5E%7Bth%7D"> and <img src="https://latex.codecogs.com/png.latex?95%5E%7Bth%7D"> percentiles. §The probability density function for the disease age at transmission at time <img src="https://latex.codecogs.com/png.latex?t"> may be obtained by <img src="https://latex.codecogs.com/png.latex?g(t)%20=%20%5Cfrac%7BP(X%3Et)%7D%7B%E2%88%AB_0%5E%E2%88%9E%20P(X%3Et)dt%7D%20~%5Ctextrm%7Bfor%7D~%20t%E2%88%88(0,+%E2%88%9E)"> for infectious period <img src="https://latex.codecogs.com/png.latex?X">. The expected value can then be calculated as <img src="https://latex.codecogs.com/png.latex?%5Cint_0%5E%7B%5Cinfty%7D%20t%20g(t)%5Ctextrm%7Bd%7Dt">. ¶Gamma(shape, rate). This distribution can be produced by assuming two successive compartments with the exit rate of 2/5.</p>


</section>

 ]]></description>
  <category>generation interval</category>
  <category>reproduction number</category>
  <guid>https://kimfinale.github.io/myblog/posts/generation_interval1/index.html</guid>
  <pubDate>Wed, 06 Dec 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/generation_interval1/sample_figure.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Generation interval, growth rate, reproduction number</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/generation_interval/index.html</link>
  <description><![CDATA[ 




<section id="growth-rate-generation-interval-and-reproduction-number" class="level3">
<h3 class="anchored" data-anchor-id="growth-rate-generation-interval-and-reproduction-number">Growth rate, generation interval, and reproduction number</h3>
<p><a href="https://royalsocietypublishing.org/doi/10.1098/rspb.2006.3754?url_ver=Z39.88-2003&amp;rfr_id=ori%3Arid%3Acrossref.org&amp;rfr_dat=cr_pub++0pubmed">Wallinga and Lipsitch</a> wrote a highly cited paper about the reproduction number. It discusses how to derive reproduction number, <img src="https://latex.codecogs.com/png.latex?R">, given the growth rate, <img src="https://latex.codecogs.com/png.latex?r">, and the generation interval, <img src="https://latex.codecogs.com/png.latex?T_c">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0AR%20&amp;=%201%20+%20r/b%5C%5C%0AR%20&amp;=%20(1%20+%20r/b_1)(1%20+%20r/b_2)%5C%5C%0AR%20&amp;=%20%5Cfrac%7B(1%20+%20r/b_1)%5Ex%7D%7B%5Csum_%7Bi=1%7D%5Ey(1%20+%20r/b_2)%5E%7B-i%7D%7D%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p>I can seem to use the third equation to reproduce the answer to the example the authors provided. On page 603, the authors gave the example of Influenza A where the generation interval has a mean of 2.85 days with the standard deviation of 0.93 days. The epidemic growth rate <img src="https://latex.codecogs.com/png.latex?r%20=%200.2">. “The <img src="https://latex.codecogs.com/png.latex?R=1.57"> for the SIR epidemic model, a value of <img src="https://latex.codecogs.com/png.latex?R=1.65"> for the SEIR epidemic model and a value of <img src="https://latex.codecogs.com/png.latex?R=1.66"> the more complicated epidemic model with one latent stage and two infectious stages (equation (3.3), with <img src="https://latex.codecogs.com/png.latex?x=1,%20y=2">)”</p>
<p>I tried to reproduce the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">Tc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.85</span></span>
<span id="cb1-2">sigma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.93</span></span>
<span id="cb1-3">r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for the SIR model</span></span>
<span id="cb1-5">b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc</span>
<span id="cb1-6">(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>b)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.57</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for the SEIR model, assume that b1 and b2 are the same</span></span>
<span id="cb3-2">b1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> b2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc</span>
<span id="cb3-3">(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>b1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>b2))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.651225</code></pre>
</div>
</div>
<p>For the model with <img src="https://latex.codecogs.com/png.latex?x=1,%20y=2">, the <img src="https://latex.codecogs.com/png.latex?R"> is not the same as provided. <img src="https://latex.codecogs.com/png.latex?R"> can vary depending on how we set <img src="https://latex.codecogs.com/png.latex?b_1"> and <img src="https://latex.codecogs.com/png.latex?b_2">, but it is smaller than one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for the SEIR model with x=1, y=2 (i.e., two consecutive . assume that b1 and b2 are the same</span></span>
<span id="cb5-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-3">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-4">b1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc</span>
<span id="cb5-5">b2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc</span>
<span id="cb5-6"></span>
<span id="cb5-7">numer <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>b1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>x</span>
<span id="cb5-8">denom <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(y) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>y, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(i) (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>b2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>i)))</span>
<span id="cb5-9"></span>
<span id="cb5-10">(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">denom</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7828791</code></pre>
</div>
</div>
<p>The study also refers to <a href="https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0020174">Wearing et al.&nbsp;(2005)</a> study and the result is below. Again, it is not <img src="https://latex.codecogs.com/png.latex?R=1.66"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># as presented in Wearing et al.(2005)</span></span>
<span id="cb7-2"></span>
<span id="cb7-3">m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-4">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb7-5">b1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc</span>
<span id="cb7-6">b2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc</span>
<span id="cb7-7"></span>
<span id="cb7-8">numer <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(b1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>m)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>m</span>
<span id="cb7-9">denom <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> b2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(b2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n))</span>
<span id="cb7-10">(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> numer <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> denom)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.423909</code></pre>
</div>
</div>
<p>I implemented moment generating function to see if I can reproduce the results this way. One important aspect is that how we should set the rate to get the generation interval we want.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">mgf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(b, r) b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r)</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mgf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span>r)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.57</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">mgf_recursion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(c, b, r){</span>
<span id="cb11-2">  l <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(b)</span>
<span id="cb11-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (l <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb11-4">    c <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mgf</span>(b, r)</span>
<span id="cb11-5">  } </span>
<span id="cb11-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb11-7">    c[l] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mgf</span>(b[l], r) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mgf_recursion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(b[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(l<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)])), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span>b[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(l<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span>r)</span>
<span id="cb11-8">  }</span>
<span id="cb11-9">}</span>
<span id="cb11-10"></span>
<span id="cb11-11">c <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb11-12">b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc</span>
<span id="cb11-13"></span>
<span id="cb11-14">R0_recursion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(c,b,r){</span>
<span id="cb11-15">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(b))</span>
<span id="cb11-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(b)) {</span>
<span id="cb11-17">    out[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mgf_recursion</span>(c[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>i], b[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>i], r)</span>
<span id="cb11-18">  }</span>
<span id="cb11-19">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(out)</span>
<span id="cb11-20">}</span>
<span id="cb11-21"></span>
<span id="cb11-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">R0_recursion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.57</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">R0_recursion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.651225</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for y=2 (i.e., Gamma distribution with shape=2)</span></span>
<span id="cb15-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use the relationship </span></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># average time to infection = beta*(1+alpha)/2 where beta and alpha represent scale and shape</span></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># beta*(1+alpha)/2 = Tc/2</span></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rate = b = (1+alpha)/Tc</span></span>
<span id="cb15-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">R0_recursion</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Tc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.661816</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>generation interval</category>
  <category>growth rate</category>
  <category>reproduction number</category>
  <guid>https://kimfinale.github.io/myblog/posts/generation_interval/index.html</guid>
  <pubDate>Tue, 05 Dec 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/generation_interval/sample_figure.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Convolution</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/convolution/index.html</link>
  <description><![CDATA[ 




<section id="convolution" class="level3">
<h3 class="anchored" data-anchor-id="convolution">Convolution</h3>
<p>The following content was adapted from the post in Grant Sanderson’s <a href="https://www.youtube.com/watch?v=IaSGqQa5O-M&amp;t=567s">YouTube video</a> and the <a href="https://en.wikipedia.org/wiki/Convolution">Wikipedia article</a>.</p>
<p>Convolution is a fundamental concept in mathematics and statistics, playing a crucial role in various applications ranging from signal processing to probability theory. In this blog post, we’ll explore what convolution is, its significance, and how it’s used in mathematics and statistics. Additionally, I’ll include a practical example using R.</p>
<p>Convolution is a mathematical operation that combines two functions to produce a third function. It’s a way of ‘mixing’ two functions, often used to understand the way a system modifies a signal. In mathematical terms, the convolution of two functions, <img src="https://latex.codecogs.com/png.latex?f"> and <img src="https://latex.codecogs.com/png.latex?g">, is defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A(f*g)(t)%20=%20%5Cint_0%5E%7B%5Cinfty%7D%20f(%5Ctau)g(t-%5Ctau)%20%5Ctextrm%7Bd%7D%5Ctau%0A"> Let’s consider a simple example of convolution in R. We’ll convolve two functions, a sine wave and a cosine wave, to see how they interact.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the two functions</span></span>
<span id="cb1-2">f <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>(x)</span>
<span id="cb1-3">g <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cos</span>(x)</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a sequence of points</span></span>
<span id="cb1-6">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pi, pi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform the convolution</span></span>
<span id="cb1-9">convolved <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">convolve</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(x), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">g</span>(x), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"open"</span>)</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the original functions and their convolution</span></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(x), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>))</span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">g</span>(x), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>)</span>
<span id="cb1-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(x, convolved[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">199</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'green'</span>)</span>
<span id="cb1-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"f(x) = sin(x)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"g(x) = cos(x)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Convolved"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"green"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/convolution/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In compartmental modeling, it can be used to explore the distribution and features of the consecutive compartments. For example, in the SEIR model, the the length of a generation interval is given by the convolution of E and I compartments.</p>


</section>

 ]]></description>
  <category>particle filter</category>
  <guid>https://kimfinale.github.io/myblog/posts/convolution/index.html</guid>
  <pubDate>Mon, 04 Dec 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/convolution/sample_figure.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Idiosyncrasies and generalities</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/Idiosyncrasy_generality/index.html</link>
  <description><![CDATA[ 




<section id="idiosyncrasies-and-generalities" class="level3">
<h3 class="anchored" data-anchor-id="idiosyncrasies-and-generalities">Idiosyncrasies and generalities</h3>
<p>Debates in the population ecology <a href="https://www.science.org/doi/10.1126/science.1062226">Bjørnstad and Grenfell</a>.</p>
<ol type="1">
<li><p>Relative importance of “noise” (small-scale, high-frequency stochastic influences) versus climatic forcing (larger scale, often lower-frequency signals) versus nonlinear interactions between individuals of the same or different species.</p></li>
<li><p>The impact of intrinsic (i.e., intraspecific) processes, as opposed to extrinsic or community-level interactions</p></li>
<li><p>Nested within 2, “dimensionality” of population fluctuations; given that most populations are embedded in rich communities and affected by numerous interspecific interactions, can simple (low-dimensional) models involving one or a few species capture the patterns of fluctuations?</p></li>
</ol>
<p>“… To understand any system, we need to appreciate its idiosyncrasies; to encompass broad patterns, we need to extract generalities…”</p>
<p>Viewing infectious disease epidemiology as a subset of ecology can be highly beneficial. By doing so, we can apply all the components that influence the dynamics of animal species to infectious disease dynamics, to varying degrees.</p>
<p>In the context of COVID-19, the modeling of confirmed cases has primarily focused on the variation in transmission rates. Often, the variation within reasonable limits in the transmission rate alone is sufficient to produce the daily number of cases. However, there is a potential risk of overlooking other influential factors, which could lead to biased estimates for transmission.</p>
<p>By considering infectious disease dynamics from an ecological perspective, we can broaden our understanding and ensure that relevant factors beyond transmission rates are taken into account. This approach can enhance the accuracy of our modeling and contribute to more effective public health interventions in combating diseases like COVID-19.</p>


</section>

 ]]></description>
  <category>ecology</category>
  <category>idiosyncransy</category>
  <category>generality</category>
  <category>COVID-19</category>
  <guid>https://kimfinale.github.io/myblog/posts/Idiosyncrasy_generality/index.html</guid>
  <pubDate>Sun, 03 Dec 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/Idiosyncrasy_generality/sample_figure.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Euler-Lotka equation</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/Euler-Lotka/index.html</link>
  <description><![CDATA[ 




<section id="euler-lotka-equation" class="level3">
<h3 class="anchored" data-anchor-id="euler-lotka-equation">Euler-Lotka equation</h3>
<p>The following content was adapted from the <a href="https://en.wikipedia.org/wiki/Euler%E2%80%93Lotka_equation">Wikipedia article</a>.</p>
<p>The Euler-Lotka equation is a fundamental concept in demographic analysis and population ecology, offering critical insights into the age structure and growth rate of populations. At its core, the equation connects the reproductive rates across different ages to the overall population growth rate.</p>
<p>Let <img src="https://latex.codecogs.com/png.latex?B(t)dt"> be the number of births during the time interval from <img src="https://latex.codecogs.com/png.latex?t"> to <img src="https://latex.codecogs.com/png.latex?t+dt">. Also define the survival function <img src="https://latex.codecogs.com/png.latex?l(a)">, the fraction of individuals surviving to age <img src="https://latex.codecogs.com/png.latex?a">. Finally define <img src="https://latex.codecogs.com/png.latex?b(a)"> to be the birth rate for mothers of age <img src="https://latex.codecogs.com/png.latex?a">. The product <img src="https://latex.codecogs.com/png.latex?B(t-a)%20l(a)"> therefore denotes the number density of individuals born at <img src="https://latex.codecogs.com/png.latex?t-a"> and still alive at <img src="https://latex.codecogs.com/png.latex?t">, while <img src="https://latex.codecogs.com/png.latex?B(t-a)l(a)b(a)"> denotes the number of births in this cohort, which suggest the following Volterra integral equation for <img src="https://latex.codecogs.com/png.latex?B">: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0AB(t)%20&amp;=%20%5Cint_%7Ba=0%7D%5Et%20B(t-a)%20l(a)%20b(a)%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p>If we assume an exponential solution <img src="https://latex.codecogs.com/png.latex?B(t)=Q%20e%5E%7Brt%7D">, the equation becomes</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0AQe%5E%7Brt%7D%20&amp;=%20%5Cint_%7Ba=0%7D%5Et%20Qe%5E%7Br(t-a)%7D%20l(a)%20b(a)%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A1%20=%20%5Cint_%7Ba=0%7D%5Et%20e%5E%7B-ra%7D%20l(a)%20b(a)%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p>In R, we can simulate the Euler-Lotka equation to understand population dynamics better. The following code snippet provides a basic framework for this simulation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define age-specific fertility and survival rates</span></span>
<span id="cb1-2">ages <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Age range</span></span>
<span id="cb1-3">fertility_rates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(ages), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Random fertility rates</span></span>
<span id="cb1-4">survival_rates <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(ages), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Random survival rates</span></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Euler-Lotka Equation Function</span></span>
<span id="cb1-7">euler_lotka <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(r) {</span>
<span id="cb1-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(survival_rates <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> fertility_rates <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>r <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ages)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-9">}</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Finding the intrinsic rate of natural increase</span></span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rootSolve)</span>
<span id="cb1-13">r_estimated <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">uniroot</span>(euler_lotka, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>root</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Output the estimated intrinsic rate of natural increase</span></span>
<span id="cb1-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Estimated r:"</span>, r_estimated))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Estimated r: 0.140031822598998"</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>Euler-Lotka</category>
  <category>demography</category>
  <category>survival</category>
  <category>exponential</category>
  <guid>https://kimfinale.github.io/myblog/posts/Euler-Lotka/index.html</guid>
  <pubDate>Sat, 02 Dec 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/Euler-Lotka/sample_figure.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>SIR model in Stan: Euler method</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/index.html</link>
  <description><![CDATA[ 




<section id="sir-model-in-stan" class="level3">
<h3 class="anchored" data-anchor-id="sir-model-in-stan">SIR model in Stan</h3>
<p>I developed a SIR model and solved it an Euler method and generated a fake data as a sequence of noisy observation of daily incidence. I could have used the ODE solving routine available in Stan as in my previous <a href="https://www.jonghoonk.com/posts/ode-in-stan/">post</a>. However, an SIR model solved via the Euler method can be extended mor easily (e.g., stochatic model). I also suspect it would be easier to combine with the other statistical modeling techinques (e.g., hierarchical model), which I am going to post later.</p>
<section id="simulate-the-data" class="level4">
<h4 class="anchored" data-anchor-id="simulate-the-data">Simulate the data</h4>
<p>Generate <img src="https://latex.codecogs.com/png.latex?y_%7B1:N%7D"> as a sequence of noisy observations of a daily incidence. Almost the same Stan model is used twice: once to create fake data and the second time to estimate parameters via HMC.</p>
</section>
<section id="stan-model-to-create-fake-data" class="level4">
<h4 class="anchored" data-anchor-id="stan-model-to-create-fake-data">Stan model to create fake data</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">stan_code_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb1-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb1-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; N; // length of the data</span></span>
<span id="cb1-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; iter_per_day;</span></span>
<span id="cb1-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real dt;</span></span>
<span id="cb1-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; S0;</span></span>
<span id="cb1-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; I0;</span></span>
<span id="cb1-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; R0;</span></span>
<span id="cb1-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; CI0;</span></span>
<span id="cb1-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; phi;</span></span>
<span id="cb1-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; gamma;</span></span>
<span id="cb1-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; beta;</span></span>
<span id="cb1-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-18"></span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb1-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N] daily_inf;</span></span>
<span id="cb1-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] S;</span></span>
<span id="cb1-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] I;</span></span>
<span id="cb1-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] R;</span></span>
<span id="cb1-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] CI;</span></span>
<span id="cb1-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb1-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; st; // susceptible at time t</span></span>
<span id="cb1-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; it;</span></span>
<span id="cb1-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; rt;</span></span>
<span id="cb1-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; cit;  // cumulative infections at time t</span></span>
<span id="cb1-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n; // total population size</span></span>
<span id="cb1-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n_si; // number moving from S to I</span></span>
<span id="cb1-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n_ir; // number moving from I to R</span></span>
<span id="cb1-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb1-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  S[1] = S0;</span></span>
<span id="cb1-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  I[1] = I0;</span></span>
<span id="cb1-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  R[1] = R0;</span></span>
<span id="cb1-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  CI[1] = CI0;</span></span>
<span id="cb1-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb1-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 2:(N+1)) {</span></span>
<span id="cb1-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    st = S[i-1];</span></span>
<span id="cb1-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    it = I[i-1];</span></span>
<span id="cb1-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    rt = R[i-1];</span></span>
<span id="cb1-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    cit = CI[i-1];</span></span>
<span id="cb1-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (j in 1:iter_per_day) {</span></span>
<span id="cb1-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n = st + it + rt;</span></span>
<span id="cb1-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n_si = dt * beta * st * it / n;</span></span>
<span id="cb1-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n_ir = dt * gamma * it;</span></span>
<span id="cb1-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      st = st - n_si;</span></span>
<span id="cb1-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      it = it + n_si - n_ir;</span></span>
<span id="cb1-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      rt = rt + n_ir;</span></span>
<span id="cb1-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      cit = cit + n_si;</span></span>
<span id="cb1-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb1-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    S[i] = st;</span></span>
<span id="cb1-55"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    I[i] = it;</span></span>
<span id="cb1-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    R[i] = rt;</span></span>
<span id="cb1-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    CI[i] = cit;</span></span>
<span id="cb1-58"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb1-59"></span>
<span id="cb1-60"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 2:(N+1)) {</span></span>
<span id="cb1-61"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    daily_inf[i-1] = CI[i] - CI[i-1];</span></span>
<span id="cb1-62"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb1-63"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-64"></span>
<span id="cb1-65"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb1-66"></span>
<span id="cb1-67"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-68"></span>
<span id="cb1-69"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">generated quantities {</span></span>
<span id="cb1-70"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[N] int y_sim;</span></span>
<span id="cb1-71"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 1:N) {</span></span>
<span id="cb1-72"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_sim[i] = neg_binomial_2_rng(daily_inf[i] + 1e-6, phi);</span></span>
<span id="cb1-73"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    //y_sim[i] = poisson_rng(daily_inf[i] + 1e-6);</span></span>
<span id="cb1-74"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb1-75"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb1-76"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span></code></pre></div>
</div>
</section>
</section>
<section id="section" class="level1">
<h1></h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-4">mod_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_model</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model_code=</span>stan_code_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb2-5"></span>
<span id="cb2-6">N<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>31L </span>
<span id="cb2-7">S0<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">999</span></span>
<span id="cb2-8">I0<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-9">dt<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb2-10"></span>
<span id="cb2-11">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span>N,</span>
<span id="cb2-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S0=</span>S0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I0=</span>I0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">CI0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_per_day=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>dt),</span>
<span id="cb2-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gamma=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dt=</span>dt)</span>
<span id="cb2-14"></span>
<span id="cb2-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb2-16"></span>
<span id="cb2-17">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sampling</span>(mod_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data,</span>
<span id="cb2-18">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>,</span>
<span id="cb2-19">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb2-20">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb2-21">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">algorithm =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fixed_param"</span>)</span>
<span id="cb2-22"></span>
<span id="cb2-23">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(fit)</span>
<span id="cb2-24">y_sim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> df[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grepl</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^y_sim.*"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(df))]</span>
<span id="cb2-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>N, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_sim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,]))</span>
<span id="cb2-26"></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># saveRDS(y_sim, "stan_sir_daily_inc_NB.rds")</span></span></code></pre></div>
</div>
<section id="stan-model-to-estimate-parameters" class="level3">
<h3 class="anchored" data-anchor-id="stan-model-to-estimate-parameters">Stan model to estimate parameters</h3>
<p>Note that there are two parameters in the parameters block</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">stan_code_est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb3-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; N;</span></span>
<span id="cb3-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; iter_per_day;</span></span>
<span id="cb3-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real dt;</span></span>
<span id="cb3-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=0&gt; y[N];</span></span>
<span id="cb3-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; S0;</span></span>
<span id="cb3-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; I0;</span></span>
<span id="cb3-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; R0;</span></span>
<span id="cb3-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; CI0;</span></span>
<span id="cb3-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; phi;</span></span>
<span id="cb3-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; r;</span></span>
<span id="cb3-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-14"></span>
<span id="cb3-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb3-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; gamma;</span></span>
<span id="cb3-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; beta;</span></span>
<span id="cb3-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-19"></span>
<span id="cb3-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb3-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N] daily_inf;</span></span>
<span id="cb3-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] S;</span></span>
<span id="cb3-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] I;</span></span>
<span id="cb3-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] R;</span></span>
<span id="cb3-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N+1] CI;</span></span>
<span id="cb3-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb3-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; st; // susceptible at time t</span></span>
<span id="cb3-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; it;</span></span>
<span id="cb3-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; rt;</span></span>
<span id="cb3-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; cit;  // cumulative infections at time t</span></span>
<span id="cb3-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n; // total population size</span></span>
<span id="cb3-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n_si; // number moving from S to I</span></span>
<span id="cb3-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; n_ir; // number moving from I to R</span></span>
<span id="cb3-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb3-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  S[1] = S0;</span></span>
<span id="cb3-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  I[1] = I0;</span></span>
<span id="cb3-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  R[1] = R0;</span></span>
<span id="cb3-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  CI[1] = CI0;</span></span>
<span id="cb3-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb3-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 2:(N+1)) {</span></span>
<span id="cb3-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    st = S[i-1];</span></span>
<span id="cb3-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    it = I[i-1];</span></span>
<span id="cb3-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    rt = R[i-1];</span></span>
<span id="cb3-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    cit = CI[i-1];</span></span>
<span id="cb3-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (j in 1:iter_per_day) {</span></span>
<span id="cb3-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n = st + it + rt;</span></span>
<span id="cb3-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n_si = dt * beta * st * it / n;</span></span>
<span id="cb3-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      n_ir = dt * gamma * it;</span></span>
<span id="cb3-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      st = st - n_si;</span></span>
<span id="cb3-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      it = it + n_si - n_ir;</span></span>
<span id="cb3-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      rt = rt + n_ir;</span></span>
<span id="cb3-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      cit = cit + n_si;</span></span>
<span id="cb3-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    }</span></span>
<span id="cb3-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    S[i] = st;</span></span>
<span id="cb3-55"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    I[i] = it;</span></span>
<span id="cb3-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    R[i] = rt;</span></span>
<span id="cb3-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    CI[i] = cit;</span></span>
<span id="cb3-58"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb3-59"></span>
<span id="cb3-60"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (i in 2:(N+1)) {</span></span>
<span id="cb3-61"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    daily_inf[i-1] = CI[i] - CI[i-1];</span></span>
<span id="cb3-62"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb3-63"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-64"></span>
<span id="cb3-65"></span>
<span id="cb3-66"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb3-67"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  beta ~ exponential(r);</span></span>
<span id="cb3-68"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  gamma ~ exponential(r);</span></span>
<span id="cb3-69"></span>
<span id="cb3-70"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  y ~ neg_binomial_2(daily_inf + 1e-6, phi);</span></span>
<span id="cb3-71"></span>
<span id="cb3-72"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}"</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-4"></span>
<span id="cb4-5">mod_est <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_model</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model_code=</span>stan_code_est, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-6"></span>
<span id="cb4-7">y_sim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stan_sir_daily_inc_NB.rds"</span>)</span>
<span id="cb4-8"></span>
<span id="cb4-9">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(y_sim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,])</span>
<span id="cb4-10">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(y), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S0=</span>S0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I0=</span>I0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">CI0=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter_per_day=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>dt), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dt=</span>dt)</span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb4-13"></span>
<span id="cb4-14">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sampling</span>(mod_est, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data,</span>
<span id="cb4-15">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>,</span>
<span id="cb4-16">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,</span>
<span id="cb4-17">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb4-18"></span>
<span id="cb4-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># saveRDS(fit, "stan_sir_daily_inc_NB_fit.rds")</span></span></code></pre></div>
</div>
<p>Trace plot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb5-2">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stan_sir_daily_inc_NB_fit.rds"</span>)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">traceplot</span>(fit, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="plot-the-results" class="level4">
<h4 class="anchored" data-anchor-id="plot-the-results">Plot the results</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb6-2">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"win"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">quiet=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb6-4"></span>
<span id="cb6-5">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(fit)</span>
<span id="cb6-6">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>)]</span>
<span id="cb6-7">dlong <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(d, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>),</span>
<span id="cb6-8">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"param"</span>)        </span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dlong$param &lt;- as.factor(dlong$param)</span></span>
<span id="cb6-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb6-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(dlong)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>value))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>param, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dlong, param <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"beta"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dlong, param <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gamma"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("sir_euler_stan_param.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>


</section>
</section>
</section>

 ]]></description>
  <category>R</category>
  <category>Stan</category>
  <category>Euler method</category>
  <category>SIR model</category>
  <guid>https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/index.html</guid>
  <pubDate>Mon, 27 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/stan_sir_transformed_parameters/sir_euler_stan_param.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Estimating a time-to-event distribution in Stan</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://kimfinale.github.io/myblog/posts/truncation-in-stan/index.html</link>
  <description><![CDATA[ 




<section id="stan-instead-of-optim" class="level3">
<h3 class="anchored" data-anchor-id="stan-instead-of-optim">Stan instead of optim</h3>
<p>As in the previous post, let’s create a sample through a non-homogeneous process for the infection events and a Gamma distribution for the serial (or generation) interval.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb1-2">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-3">tmax <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># maximum time of first event</span></span>
<span id="cb1-4">r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.14</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># growth rate</span></span>
<span id="cb1-5">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"double"</span>, n)</span>
<span id="cb1-6">i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-7">ct <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate sample through a nonhomogeneous Poisson process</span></span>
<span id="cb1-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> (ct <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tmax) {</span>
<span id="cb1-10">  t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rexp</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>ct))</span>
<span id="cb1-11">  ct <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ct <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> t</span>
<span id="cb1-12">  X[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ct</span>
<span id="cb1-13">  i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-14">}</span>
<span id="cb1-15">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X[X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameters for the serial interval</span></span>
<span id="cb1-18">shape_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span></span>
<span id="cb1-19">scale_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.3</span></span>
<span id="cb1-20"></span>
<span id="cb1-21">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>X)</span>
<span id="cb1-22">si <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(X), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>shape_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>scale_true)</span>
<span id="cb1-23">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> si</span>
<span id="cb1-24"></span>
<span id="cb1-25">tau <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># truncation time</span></span>
<span id="cb1-26">under_tau <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tau </span>
<span id="cb1-27">newdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[under_tau,]</span>
<span id="cb1-28"></span>
<span id="cb1-29">numerator_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, y, parms){</span>
<span id="cb1-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb1-31">}</span>
<span id="cb1-32"></span>
<span id="cb1-33">denominator_func <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(t, parms, tmax) {</span>
<span id="cb1-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>t)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(tmax<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>t, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale=</span>parms[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]])</span>
<span id="cb1-35">}</span>
<span id="cb1-36"></span>
<span id="cb1-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># single likelihood</span></span>
<span id="cb1-38">ll_right_trunc_exp_growth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms,x,y,tmax){</span>
<span id="cb1-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numerator_func</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>parms)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integrate</span>(denominator_func,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">upper=</span>tmax, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>parms, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>value)</span>
<span id="cb1-40">}</span>
<span id="cb1-41"></span>
<span id="cb1-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sum of negative log likelihoods</span></span>
<span id="cb1-43">nll_right_trunc_exp_growth <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(parms, X, Y, tmax){</span>
<span id="cb1-44">  sll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-45">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(X)) {</span>
<span id="cb1-46">    sll <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sll <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ll_right_trunc_exp_growth</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms=</span>parms,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>X[i],<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>Y[i],<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax)</span>
<span id="cb1-47">  }</span>
<span id="cb1-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>sll)</span>
<span id="cb1-49">}</span>
<span id="cb1-50"></span>
<span id="cb1-51">res_optim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">par=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), </span>
<span id="cb1-52">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn=</span>nll_right_trunc_exp_growth, </span>
<span id="cb1-53">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X, </span>
<span id="cb1-54">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y,</span>
<span id="cb1-55">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tmax=</span>tmax,</span>
<span id="cb1-56">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nelder-Mead"</span>,</span>
<span id="cb1-57">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">maxit=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reltol=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-15</span>))</span></code></pre></div>
</div>
<section id="stan-program" class="level4">
<h4 class="anchored" data-anchor-id="stan-program">Stan program</h4>
<p>Gamma distribution accounting for truncation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">stan_code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb2-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb2-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int&lt;lower = 0&gt; N; // number of records</span></span>
<span id="cb2-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    vector&lt;lower = 0&gt;[N] X;</span></span>
<span id="cb2-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    vector&lt;lower = 0&gt;[N] Y;</span></span>
<span id="cb2-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real tau;</span></span>
<span id="cb2-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb2-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real shape;</span></span>
<span id="cb2-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real scale;</span></span>
<span id="cb2-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb2-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    shape ~ exponential(0.1);</span></span>
<span id="cb2-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    scale ~ exponential(0.1);</span></span>
<span id="cb2-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    target += gamma_lpdf(Y - X | shape, 1/scale) - gamma_lcdf(tau-X | shape, 1/scale);</span></span>
<span id="cb2-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}"</span>    </span></code></pre></div>
</div>
<p>Gamma distribution accounting for truncation and exponential growth of infections</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">stan_code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb3-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">functions {</span></span>
<span id="cb3-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real denominator_density(real x,</span></span>
<span id="cb3-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           real xc,                </span></span>
<span id="cb3-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           array[] real theta,     </span></span>
<span id="cb3-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           array[] real x_r,                        </span></span>
<span id="cb3-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           array[] int x_i){</span></span>
<span id="cb3-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real shape = theta[1];</span></span>
<span id="cb3-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real scale = theta[2];</span></span>
<span id="cb3-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  </span></span>
<span id="cb3-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    return exp(0.14 * x) * gamma_cdf(33 - x, shape, 1/scale);</span></span>
<span id="cb3-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb3-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-14"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb3-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int&lt;lower = 0&gt; N; // number of records</span></span>
<span id="cb3-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    vector&lt;lower = 0&gt;[N] X;</span></span>
<span id="cb3-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    vector&lt;lower = 0&gt;[N] Y;</span></span>
<span id="cb3-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real tau;</span></span>
<span id="cb3-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real r;</span></span>
<span id="cb3-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-21"></span>
<span id="cb3-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed data{     </span></span>
<span id="cb3-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[0] real x_r;</span></span>
<span id="cb3-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  array[0] int x_i;  </span></span>
<span id="cb3-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">} </span></span>
<span id="cb3-26"></span>
<span id="cb3-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb3-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real shape;</span></span>
<span id="cb3-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real scale;</span></span>
<span id="cb3-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-31"></span>
<span id="cb3-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb3-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] log_exp_r;</span></span>
<span id="cb3-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (n in 1:N)</span></span>
<span id="cb3-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    log_exp_r[n] = log(exp(r*X[n]));</span></span>
<span id="cb3-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb3-37"></span>
<span id="cb3-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb3-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    shape ~ exponential(0.1);</span></span>
<span id="cb3-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    scale ~ exponential(0.1);</span></span>
<span id="cb3-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb3-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    for (i in 1:N)</span></span>
<span id="cb3-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">      target += log(exp(r*X[i])) + gamma_lpdf(Y[i] - X[i] | shape, 1/scale) -                          log(integrate_1d(denominator_density, 0, tau,</span></span>
<span id="cb3-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">                           {shape, scale}, x_r, x_i, 1e-2));</span></span>
<span id="cb3-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">     </span></span>
<span id="cb3-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}"</span></span></code></pre></div>
</div>
</section>
<section id="compile-and-sample" class="level4">
<h4 class="anchored" data-anchor-id="compile-and-sample">Compile and sample</h4>
<p><code>integrate_1d(denominator_density, 0, tau, {shape, scale}, x_r, x_i, 1e-3)</code> cause errors. Four of the two samplers generated samples if the rel_tol is increased to 1e-2 for <code>seed=42</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-4">mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_model</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model_code=</span>stan_code, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb4-5">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(newdf), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>X, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Y=</span>newdf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tau=</span>tau, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span>r)</span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># smp &lt;- sampling(object=mod, data=data, seed=33, chains=4, iter=2000)</span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># saveRDS(smp, "stan_trunc_smp_20231124.rds")</span></span></code></pre></div>
</div>
<p>Let’s explore the posterior distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">smp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stan_trunc_smp_20231124.rds"</span>)</span>
<span id="cb5-2">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(smp)</span>
<span id="cb5-3">pr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)</span>
<span id="cb5-4">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(df[,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>)],</span>
<span id="cb5-5">                           <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span>pr)))</span>
<span id="cb5-6"></span>
<span id="cb5-7">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>)</span>
<span id="cb5-8">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(shape_true, scale_true)</span>
<span id="cb5-9">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>optim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> res_optim<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par</span>
<span id="cb5-10">d</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           50%     2.5%    97.5%  name true    optim
shape 2.085903 1.760453 2.448298 shape  2.2 2.090817
scale 3.484215 2.680270 4.770225 scale  3.3 3.482427</code></pre>
</div>
</div>
<p>Let’s plot the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(hrbrthemes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_ipsum_rc</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis_title_size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb7-3">extrafont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loadfonts</span>()</span>
<span id="cb7-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(d)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">2.5%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">97.5%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">50%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stan"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True value"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>optim, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Optim"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Stan"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>,</span>
<span id="cb7-10">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True value"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Optim"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Median estimates with 95% CrI"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.title=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>())<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>),</span>
<span id="cb7-14">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(theta[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(theta[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>()</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/truncation-in-stan/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggsave("right_trunc_stan.png", gg, units="in", width=3.4*2, height=2.7*2)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>)]</span>
<span id="cb9-2">dlong <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tidyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(d, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>),</span>
<span id="cb9-3">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"param"</span>)        </span>
<span id="cb9-4">dlong<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(dlong<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>param)</span>
<span id="cb9-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb9-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(dlong)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>value))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>param, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dlong, param <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span>shape_true), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_vline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(dlong, param <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"scale"</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xintercept=</span>scale_true), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://kimfinale.github.io/myblog/posts/truncation-in-stan/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>news</category>
  <category>code</category>
  <category>analysis</category>
  <guid>https://kimfinale.github.io/myblog/posts/truncation-in-stan/index.html</guid>
  <pubDate>Thu, 23 Nov 2023 15:00:00 GMT</pubDate>
  <media:content url="https://kimfinale.github.io/myblog/posts/truncation-in-stan/right_trunc_stan.png" medium="image" type="image/png" height="114" width="144"/>
</item>
</channel>
</rss>

---
title: "Vaccine effectiveness"
author: "Jong-Hoon Kim"
date: "2024-03-26"
categories: [SEIR, vaccine efficacy, direct, indirect, total, overall]
image: "study_design.png"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE) 
```

### Vaccine efficacy and effectiveness

Vaccine efficacy and effectiveness (VE) is generally estimated as one minus some measure of relative risk (RR) in the vaccinated group compared with the unvaccinated group [Halloran *et al*.](https://pubmed.ncbi.nlm.nih.gov/10520474/):

$$
\text{VE} = 1 - \text{RR}
$$

RR measures may relative infection probability given exposure, hazard ratio, or the ratio of cumulative incidence (or attack rate). I will explain different effects of the vaccine using the cumulative incidence ($C$) measure based on the notations from the [Study design for dependent happenings](https://pubmed.ncbi.nlm.nih.gov/1742381/).

![](study_design.png)

In population $A$, a fraction, $f$, of the population was vaccinated (denoted with $1$) and the rest, $1-f$, of the Population A remains unvaccinated (denoted with $0$). In Population $B$, no one was vaccinated. I can now use $C_{A0}$ and $C_{A1}$ to denote cumulative incidence, $C$, in the unvaccinated and vaccinated individuals of Population $A$. Similarly, I can use $C_{B0}$ to denote the cumulative incidence in the (unvaccinated) population $B$.

The VE can be divided into four different measures and they are direct, indirect, total, and overall VE, which are noted as DVE, IVE, TVE, and OVE, respectively.

$$
\text{DVE} = 1 - \frac{C_{A1}}{C_{A0}},~
\text{IVE} = 1 - \frac{C_{A0}}{C_{B0}},~
\text{TVE} = 1 - \frac{C_{A1}}{C_{B0}},~
\text{OVE} = 1 - \frac{f C_{A1}+(1-f) C_{A0}}{C_{B0}}.
$$

Using the above equation we can see the following is true

$$
\text{IVE} = 1-\frac{1-\text{TVE}}{1-\text{DVE}},~ \text{OVE} = 1-\left(f\left(1-\text{TVE}\right)+(1-f)\left(1-\text{IVE}\right)\right)
$$

Let's construct a simple $SEIR$ model to illustrate the different metrics of VE.

```{r}
seir_2grp <- function(t, y, params) {
  S0 <- y["S0"]; E0 <- y["E0"]; I0 <- y["I0"]; R0 <- y["R0"]; C0 <- y["C0"]
  S1 <- y["S1"]; E1 <- y["E1"]; I1 <- y["I1"]; R1 <- y["R1"]; C1 <- y["C1"]
 
  beta <- params["beta"]
  epsilon <- params["epsilon"]
  gamma <- params["gamma"]
  
  # vaccinated and unvaccinated population are well mixed
  muSE <- beta * (I1+I0) / (S1 + E1 + I1 + R1 + S0 + E0 + I0 + R0)
  muEI <- epsilon
  muIR <- gamma
  
  dS0 <- - muSE*S0
  dE0 <-  muSE*S0 - muEI*E0
  dI0 <-  muEI*E0 - muIR*I0
  dR0 <-  muIR*I0
  dC0 <-  muEI*E0 ## cumulative symtom onset
  
  dS1 <- - muSE*S1
  dE1 <-  muSE*S1 - muEI*E1
  dI1 <-  muEI*E1 - muIR*I1
  dR1 <-  muIR*I1
  dC1 <-  muEI*E1 ## cumulative symtom onset
  
  return(list(c(dS0,dE0,dI0,dR0,dC0,dS1,dE1,dI1,dR1,dC1)))
}
```

### Population B

No one in the population is vaccinated.

```{r}
N <- 1
pop_B <- c(N0=N)
tend <- 200
beta <- 2.5/4.5
epsilon <- 1/5.2
gamma <- 1/4.5
# no need for the vaccinated group
y0_B <- c(S0=pop_B[["N0"]], E0=0, I0=0.01, R0=0, C0=0, 
          S1=0.0, E1=0, I1=0.0, R1=0.0, C1=0)
times <- seq(from=0, to=tend, by=1)
params <- c(beta=beta, epsilon=epsilon, gamma=gamma)

out <- deSolve::ode(y=y0_B, times=times, func=seir_2grp, parms=params)
pop_B_out <- as.data.frame(out) 
```

### Population A

A fraction $f$ of the population A received the vaccine. Vaccine efficacy is VE. Vaccination can be implemented by assuming all-or-nothing vaccine. That is, the a fraction of vaccine recipients, $N*f*\text{VE}$, are completely protected from infection. Here, $N, f$, and VE represent population size, the fraction of the population that is vaccinated, and vaccine efficacy, respectively. In the SEIR model, by setting the initial population size for the $R$ compartment as $N*f*\text{VE}$, we can mimic the vaccination scenario.

```{r}
VE <- 0.7 # vaccine efficacy on susceptibility
f <- 0.3
N0 <- N*(1-f)
N1 <- N*f
pop_A <- c(N0=N0, N1=N1)
y0_A <- c(S0=N0, E0=0, I0=0.01, R0=0, C0=0, 
        S1=N1*(1-VE), E1=0, I1=0.0, R1=N1*VE, C1=0)

out <- deSolve::ode(y=y0_A, times=times, func=seir_2grp, parms=params)
pop_A_out <- as.data.frame(out)
```

Let's compute the four VE measures at the end of the simulation.

```{r}
(DVE <- 1 - (pop_A_out[tend,"C1"]/pop_A[["N1"]])/(pop_A_out[tend,"C0"]/pop_A[["N0"]]))
(IVE <- 1 - (pop_A_out[tend,"C0"]/pop_A[["N0"]])/(pop_B_out[tend,"C0"]/pop_B[["N0"]]))
(OVE <- 1 - ((1-f)*pop_A_out[tend,"C0"]/pop_A[["N0"]] + f*pop_A_out[tend,"C1"]/pop_A[["N1"]])/ (pop_B_out[tend,"C0"]/pop_B[["N0"]]))
(TVE <- 1 - (pop_A_out[tend,"C1"]/pop_A[["N1"]])/(pop_B_out[tend,"C0"]/pop_B[["N0"]]))
(IVE == 1 - (1-TVE)/(1-DVE))
(OVE == 1 - (f*(1-TVE)+(1-f)*(1-IVE)))
(IVE == 1 - (1 - OVE - f*(1-TVE))/(1-f))
(TVE == 1 - (1-DVE)*(1-IVE))
```

Dynamics of four VE measures

```{r}
dve <- 1 - (pop_A_out[,"C1"]/pop_A[["N1"]])/(pop_A_out[,"C0"]/pop_A[["N0"]])
ive <- 1 - (pop_A_out[,"C0"]/pop_A[["N0"]])/(pop_B_out[,"C0"]/pop_B[["N0"]])
ove <- 1 - ((1-f)*pop_A_out[,"C0"]/pop_A[["N0"]] + f*pop_A_out[,"C1"]/pop_A[["N1"]])/ (pop_B_out[,"C0"]/pop_B[["N0"]])
tve <- 1 - (pop_A_out[,"C1"]/pop_A[["N1"]])/(pop_B_out[,"C0"]/pop_B[["N0"]])

plot(ive)
lines(1 - (1-tve)/(1-dve), col=2, lty=1)
lines(1 - (1 - ove - f*(1-tve))/(1-f), col=3, lty=2)

plot(ove)
lines(1 - (f*(1-tve)+(1-f)*(1-ive)), col=2, lty=1)

# plot(ive, type="l")
# lines(1 - (1 - ove - f*(1-tve))/(1-f), col=2, lty=2)

plot(tve)
lines(1 - (1-dve)*(1-ive), col=2, lty=1)
```

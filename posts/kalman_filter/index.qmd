---
title: "Kalman filter in R: FKF package"
author: "Jong-Hoon Kim"
date: "2024-07-11"
categories: [kalman filter]
image: "kalman_filter.png"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE) 
```


### Kalman filter to estimate the instantaneous reproduction number



Generate infection time series

Generate infection times based on the SIR model in which $R_t$ varies First define Rt, which is the same as used in [the prior study](https://www.sciencedirect.com/science/article/pii/S2468042723000799)

Let's develop a SIR model as was used in my [previous post](https://www.jonghoonk.com/posts/sir_deSolve_odin_diffeqr/)

```{r}
library(diffeqr)
de <- diffeqr::diffeq_setup()

sir_julia <- function(u, p, t){
  N = sum(u[1:3])
  R = ifelse(t < 20, 2, ifelse(t < 40, 0.9, 1.4))
  p[1] = R * p[2]
  
  du1 = - p[1]*u[1]*u[2]/N
  du2 = + p[1]*u[1]*u[2]/N - p[2]*u[2]
  du3 = + p[2]*u[2]
  du4 = + p[1]*u[1]*u[2]/N  
  
  return(c(du1,du2,du3,du4))
}

u0 <- c(0.99, 0.01, 0.0, 0.0)
tspan <- c(0.0, 50.0)
p <- c(0.4, 0.2)
prob <- de$ODEProblem(sir_julia, u0, tspan, p)

# prob_jit <- diffeqr::jitoptimize_ode(de, prob)
sol <- de$solve(prob, de$Tsit5(), saveat=1)

mat <- sapply(sol$u, identity)
udf <- as.data.frame(t(mat))
tudf <- cbind(data.frame(t=sol$t), udf)

library(ggplot2)
ggplot(tudf, aes(x=t)) +
  geom_line(aes(y=V1, color="S")) +
  geom_line(aes(y=V2, color="I")) +
  geom_line(aes(y=V3, color="R")) +
  scale_color_manual("", 
                     values=c("S"="steelblue", "I"="firebrick",
                              "R"="darkgreen"))+
  labs(y="Number of individuals", x="Time", color="")
```

```{r}
gamma <- 0.2
I <- diff(tudf$V4)
 # <- rpois(length(thetat), 100000*thetat)
n <- length(I)
rt <- (I[2:n]-I[1:(n-1)])/I[1:(n-1)]
t <- 1:100
R_true <- ifelse(t < 20, 2, ifelse(t < 40, 0.9, 1.4))

Rhat <- rt/gamma + 1

plot(Rhat, R_true[1:length(Rhat)], xlim=c(0,3), ylim=c(0,3), )
abline(a=0,b=1)
```

$$\frac{I_t-I_{t-1}}{I_{t-1}}\equiv r_t = \gamma(R_t-1) + \epsilon_i$$ $$R_t = R_{t-1} + \eta_i$$

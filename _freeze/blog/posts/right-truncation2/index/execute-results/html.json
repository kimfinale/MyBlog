{
  "hash": "67adf5ba373f3e113881a0514615b78c",
  "result": {
    "markdown": "---\ntitle: \"Estimating a time-to-event distribution from right-truncated data\"\nauthor: \"Jong-Hoon Kim\"\ndate: \"2023-11-23\"\ncategories: [right truncation, exponential growth, Poisson process]\nimage: \"right_trunc2.png\"\neditor_options: \n  chunk_output_type: console\n---\n\n\n\n\n[Seamen writes](https://pubmed.ncbi.nlm.nih.gov/34931911/): Data on time to an event are said to be right truncated if they come from a set of individuals who have been randomly sampled from a population using a sampling mechanism that selects only individuals who have experienced the event by a given time, called the truncation time.\n\nThe analysis of right-truncated data requires statistical methods that account for the fact that each of the sampled individuals must have experienced the final event by their truncation time.\n\nLet's assume that we are interested in estimating the serial interval and let $X$ and $Y$ denote the times of symptom onset of the infector and the infectee, with $0\\leq X \\leq Y$. Let $T=Y-X$ denote the serial interval. Let $f_T^∗(t)$ and $F_T^∗(t)$ denote, respectively, the probability density (or mass) function of $T$ and the distribution function of $T$. We obtain an i.i.d. sample, $(x_1, t_1), . . . , (x_n, t_n)$, from the probability distribution of $(X, T)$ given $X + T ≤ \\tau$ for some $\\tau > 0$.\n\n$$f_{X, T}(x,t|X+T \\leq \\tau) = \\frac{f_X(x) f^*_T(t)I(x+t \\leq \\tau)}{\\int_0^{\\tau} f_X(x') F^*_T(\\tau-x')\\text{d}x'}$$ , where $f_X (x)$ denotes the conditional probability density (or mass) function of $X$ given $X \\leq \\tau$, and $I(\\cdot)$ denotes the indicator function. If $X$ and $T$ are discrete, we shall assume, without loss of generality, that $\\tau$ is an integer. We should like to estimate $F^∗_T(t)$\n\nIf we assume no truncation (i.e., $F^*_T(\\tau-x)=1~ \\forall x$)\n\n### During an initial period of an epidemic\n\n[Seamen](https://pubmed.ncbi.nlm.nih.gov/34931911/) provides two approaches to formulating a likelihood that can be applied during the initial period of an epidemic. The first approach is: $$f_X (x;r) =  \\frac{\\text{exp}(rx)}{\\int_0^{\\tau}\\text{exp}(rs)ds }=\\frac{r\\text{exp}(rx)}{\\text{exp}(r\\tau) - 1 } \\propto \\text{exp}(rx)$$, and $T \\sim \\text{Gamma}(\\theta_1, \\theta_2)$.\n\n### Experiment\n\nLet's first create samples where infectees ($X$) are created through a non-homogeneous Poisson process where rate, $h$, is modeled as an exponential growth with a rate, $r$, (i.e., $h=\\text{exp}(rt)$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(42)\nn <- 1000\ntmax_i <- 30 # first events that happened only before time 30\nr <- 0.14 # growth rate\nX <- vector(\"double\", n)\ni <- 1\nct <- 0\n# generate sample through a nonhomogeneous Poisson process\nwhile (ct < tmax_i) {\n  t <- rexp(1, rate=exp(r*ct))\n  ct <- ct + t\n  X[i] <- ct\n  i <- i+1\n}\nX <- X[X > 0]\n\n# parameters for the serial interval\nshape_true <- 2.2\nscale_true <- 3.3\n\ndf <- data.frame(X=X)\nsi <- rgamma(length(X), shape=shape_true, scale=scale_true)\ndf$Y <- df$X + si\n\ntmax <- 33 # truncation time\nunder_tmax <- df$Y < tmax \nnewdf <- df[under_tmax,]\n\nnll <- function(parms, X, Y) -sum(dgamma(Y-X, shape=parms[[1]], scale=parms[[2]], log=TRUE))\nres1 = optim(par=c(1,2), fn=nll, X=newdf$X, Y=newdf$Y,\n             method = \"Nelder-Mead\",\n            control = list(maxit=2e4, reltol=1e-15))\n\n# \nnll_right_trunc <- function(parms, X, Y, tmax) -sum(log(dgamma(Y-X, shape=parms[[1]], scale=parms[[2]])/pgamma(tmax-X, shape=parms[[1]], scale=parms[[2]])))\n\n# the following would not work. why?\n# nll_right_trunc <- function(parms, X, Y, tmax) -sum(log(dgamma(Y-X, shape=parms[[1]], scale=parms[[2]])/pgamma(tmax, shape=parms[[1]], scale=parms[[2]])))\n\nres2 = optim(par=c(1,2), \n             fn=nll_right_trunc, \n             X=newdf$X, \n             Y=newdf$Y,\n             tmax=tmax,\n             method = \"Nelder-Mead\",\n             control = list(maxit=2e4, reltol=1e-15))\n```\n:::\n\n\n### Exponential growth for $X$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnumerator_func <- function(x, y, parms){\n  exp(r*x)*dgamma(y-x, shape=parms[[1]], scale=parms[[2]])\n}\n\n# using the full probability density function\n# numerator_func <- function(x, y, parms){\n#   exp(r*x)/(exp(r*tmax)-1)*dgamma(y-x, shape=parms[[1]], scale=parms[[2]])\n# }\n\n# uniform distribution - same as the vanilla truncation assumption\n# numerator_func <- function(x, y, parms){\n#   dgamma(y-x, shape=parms[[1]], scale=parms[[2]])\n# }\n\n# NB: x is not used in this formuation but is included as params to make consistent w/ other alternative formulations\ndenominator_func <- function(t, x, parms, tmax) {\n  exp(r*t)*pgamma(tmax-t, shape=parms[[1]], scale=parms[[2]])\n}\n\n# the following would not give the correct answer. why?\n# denominator_func <- function(t, x, parms, tmax) {\n#   exp(r*t)*pgamma(tmax-x-t, shape=parms[[1]], scale=parms[[2]])\n# }\n\n# same as the vanialla truncation model\n# denominator_func <- function(t, x, parms, tmax) {\n#   dgamma(tmax-x-t, shape=parms[[1]], scale=parms[[2]])\n# }\n\n# single likelihood\nll_right_trunc_exp_growth <- function(parms,x,y,tmax){\n  log(numerator_func(x=x, y=y, parms=parms)) - log(integrate(denominator_func,lower=0, upper=tmax, x=x, parms=parms, tmax=tmax)$value)\n}\n\n# sum of negative log likelihoods\nnll_right_trunc_exp_growth <- function(parms, X, Y, tmax){\n  sll <- 0\n  for(i in seq_along(X)) {\n    sll <- sll + ll_right_trunc_exp_growth(parms=parms,x=X[i],y=Y[i],tmax=tmax)\n  }\n  return(-sll)\n}\n\nres3 = optim(par=c(1,2), \n             fn=nll_right_trunc_exp_growth, \n             X=newdf$X, \n             Y=newdf$Y,\n             tmax=tmax,\n             method = \"Nelder-Mead\",\n             control = list(maxit=2e4, reltol=1e-15))\n\nparmdf <- data.frame(true = c(shape_true, scale_true, shape_true*scale_true))\nparmdf$no_trunc <- c(res1$par, prod(res1$par))\nparmdf$trunc <- c(res2$par, prod(res2$par))\nparmdf$trunc_exp_growth <- c(res3$par, prod(res3$par))\n\nparmdf\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  true no_trunc    trunc trunc_exp_growth\n1 2.20 2.115872 1.932797         2.100084\n2 3.30 2.273549 3.684688         3.427339\n3 7.26 4.810538 7.121754         7.197701\n```\n:::\n:::\n\n\nParameter estimates based on the methods that account for right truncation and exponential growth appear to match better with the true values than the those based on the method that accounts only for right truncation.\n\n### Plot\n\nLet's plot the distribution\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 1e5\nx0 <- rgamma(n, shape=shape_true, scale=scale_true)\nx1 <- rgamma(n, shape=res1$par[[1]], scale=res1$par[[2]])\nx2 <- rgamma(n, shape=res2$par[[1]], scale=res2$par[[2]])\nx3 <- rgamma(n, shape=res3$par[[1]], scale=res3$par[[2]])\n\ndf = data.frame(model=rep(c(\"True\",\"No truncation\", \"Right truncated\", \"Right truncated, exp growth\"), each=n), val=c(x0,x1,x2,x3))\n\nlibrary(ggplot2)\nextrafont::loadfonts()\ntheme_set(hrbrthemes::theme_ipsum_rc(base_size=14, subtitle_size=16, axis_title_size=12))\n\ndf |> ggplot(aes(x=val, fill=model))+\n  geom_density(alpha=0.2) +\n  labs(x=\"value\", y=\"density\")+\n  theme(legend.position = \"bottom\", \n        legend.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(\"right_trunc2.png\", gg, units=\"in\", width=3.4*2, height=2.7*2)\n```\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
{
  "hash": "277cc0531751139351e1dd93563d5d7a",
  "result": {
    "markdown": "---\ntitle: \"Maximum Likelihood and Profile Likelihood for the SEIR model\"\nauthor: \"Jong-Hoon Kim\"\ndate: \"2023-08-14\"\ncategories: [parameter estimation, R, maximum likelihood, profile likelihood]\nimage: \"image.jpg\"\neditor_options: \n  chunk_output_type: console\n---\n\n\n\n\n통계학은 많은 부분 확률모형의 모수를 추정하는 (inferential statistics) 과정이고 모수 추정방법으로 가장 많이 사용되는 방법이 maximum likelihood (ML)이다. 이번 포스트는 2014년 출간된 Cole *et al*.의 [Maximum Likelihood, Profile Likelihood, and Penalized Likelihood: A Primer](https://academic.oup.com/aje/article/179/2/252/123902)을 차용하여 maximum likelihood (ML) 와 profile likelihood에 대하여 기술하여 보고자 한다.\n\n### 최대 가능도 (ML)\n\n잠복기를 추정하기 위해 증상 발현일과 기존 감염자와의 접촉일을 묻는 설문조사를 했다고 하자. $n$ 명을 인터뷰하고 동일한 개수의 관찰값 $\\bf{y} = (y_1, y_2, ..., y_n)$ 을 얻었다고 하자. 확률모형 $f (y|\\bf{β})$ 은 주어진 모수$\\bf{β}=(β_0, β_1, ..., β_J)$ 하에서 $Y=y$ 일 확률을 나타낸다.\n\n최대 가능도 방법은 미지의 모수 하에서 관찰값의 확률, 즉 확률 모형을 $f(y|\\bf{\\beta})$을 $Y$의 함수가 아닌 $Y$를 관찰값에 고정한 채 $\\bf{β})$의 함수로 표현하게 된다. 따라서 확률모형과는 다르게 다음과 같은 식 $L(\\bf{\\beta};y_i)$ 을 사용한다. 즉, 우리가 관심있어 하는 것은 확률모형 $f (y|\\bf{\\beta})$이 $Y$ 가 아니고 $\\bf{\\beta}$ 에 따라 어떻게 변하는가 하는 것이다.\n\n$L(\\bf{\\beta};y_i})$를 $i$ 번째 관찰값이 가능도에 영향을 미치는 정도로 생각할 수 있고 관찰값이 상호독립적이라고 가정하면\n\n$$L(\\bf{\\beta};\\bf{y}) = \\prod_{i=1}^{n} L(\\bf{\\beta};y_i) = \\prod_{i=1}^{n} f(y_i;\\bf{\\beta})$$\n\n$L(\\bf{\\beta};\\bf{y})$ 는 $\\bf{\\beta}$에 대한 확률을 알 수는 없기 때문에 확률모형이 아닌 가능도 (혹은 우도) 함수라고 한다.\n\n\n수리 모형을 이용하여 연구를 하게되면 관찰값을 이용하여 모형의 모수를 보정하는 과정을 거치게 된다. 이 과정을 소위 결과 (관찰값)로 부터 원인 (모형)을 알아내는 과정이라 하여 [inverse problem](https://en.wikipedia.org/wiki/Inverse_problem) 이라 부르기도 한다. 이 글에서는 SEIR 모형과 중국 우한 에서의 초기 코로나-19 발열자 자료를 이용하여 모형의 모수 (기초재감염지수)와 신뢰구간을 구해본다. 모수는 푸아송 (Poisson) 분포를 이용한 최대 우도 (maximum likelihood) 방법으로 그리고 신뢰구간은 profile likelihood 방법을 사용한다.\\\n아래에 SEIR 모형의 R 코드는 이전에 사용했던 모형에 변수 $C$를 추가하였는데 이는 누적 발열자수를 나타내고 일별 발열자 수를 쉽게 구하기 위함이다.\n\n### 푸아송 추정 예\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1220)\nn <- 50\ny <- rpois(n, lambda=27)\nm <- mean(y)\ns <- sd(y)\n# Wald confidence limits\ncat(m-1.96*s/sqrt(n),\", \", m+1.96*s/sqrt(n))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n26.3428 ,  28.8572\n```\n:::\n\n```{.r .cell-code}\n# maximum likelihood using a probability model\n# nll <- function(theta, y){\n#   - sum(dpois(y,lambda=exp(theta), log=T))  \n# }\n# res = optim(par=log(10), fn=nll, y=y)\n# exp(res$par)\n\nnll_theta <- function(theta){\n  - sum(dpois(y, lambda=theta, log=T))  \n}\nres = optimize(f=nll_theta, interval=c(0, 1e6))\nres\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$minimum\n[1] 27.60001\n\n$objective\n[1] 146.6757\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# ODE-based SEIR model\nseir <- function(t, y, params) {\n  S <- y[1]; E <- y[2]; I <- y[3]; R <- y[4]; C <- y[5]\n  beta <- params[\"beta\"]\n  sigma <- params[\"sigma\"]\n  gamma <- params[\"gamma\"]\n  \n  muSE <- beta * I / (S + E + I + R)\n  muEI <- sigma\n  muIR <- gamma\n  \n  dS <- - muSE*S\n  dE <-  muSE*S - muEI*E\n  dI <-  muEI*E - muIR*I\n  dR <-  muIR*I\n  dC <-  muEI*E ## cumulative symtom onset\n  \n  return(list(c(dS, dE, dI, dR, dC)))\n}\n```\n:::\n\n\n일별 발열자수는 $$ \\int_{\\tau=t}^{\\tau=t+1} \\beta S I / N ~\\mathrm{d}\\tau, ~\\mathrm{for}~N= S+E+I+R$$ 이고 누적 발열자수를 나타내는 $C$의 일별 차이로서 구할 수 있다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# daily symptomatic case\ndaily_case <- function(params=NULL) { \n  y0 <- c(S = 11e6 - 1, E = 0, I = 1, R = 0, C = 1) # initial values (Wuhan population size)\n  times <- seq(from = 0, to = 35, by = 1)\n  if(is.null(params)){\n    params <- c(beta = 2.5/4.5, sigma = 1/5.2, gamma = 1/4.5)\n  }\n  out <- ode(y = y0, times = times, func = seir, parms = params)\n  x <- as.data.frame(out) \n  n <- nrow(x)\n  daily = diff(x[,\"C\"])\n  return (daily)\n} \n```\n:::\n\n\n우한에서 발생한 초기 일별 코로나19 환자수는 [Kucharski *et al*.](https://www.thelancet.com/article/S1473-3099(20)30144-4/fulltext) 에 보고된 자료를 기반으로 하였다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwuhan <- \n  data.frame(date = seq(as.Date(\"2019-12-13\"), \n                        as.Date(\"2020-01-16\"), by = \"day\"),\n             case = c(0,0,0,0,0,0,0,2,2,3,0,1,1,0,0,1,0,1,2,\n                      3,4,3,3,1,2,5,6,8,3,8,8,5,17,7,13))\n```\n:::\n\n\npmc 함수에 사용된 또 다른 함수 assign_weights를 아래에 구현하였다.\n\n$$ y_t \\sim \\mathrm{Poisson}(Y_t) $$ $$ \\mathcal{L}(\\theta) = \\prod_{t=1}^{n} f(y_t \\vert \\theta) = \\prod_{t=1}^{n} \\frac{Y_t^{y_t} e^{-Y_t}}{y_t!} $$ 우도 계산식을 아래와 같이 R로 구현할 수 있다. 물론 우도함수는 수치 안정성을 위해서 log 를 취한 값을 사용하고 (즉 log likelihood) 최적화 알고리듬은 최소값을 찾기 때문에 음의값으로 치환한 negative log likelihood를 사용한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnegloglik <- function(par) {\n  params <- c(beta = par, sigma = 1/5.2, gamma = 1/4.5)\n  model <- daily_case(params = params)\n  - sum(dpois(x = wuhan$case, lambda = model, log = TRUE)) # sum of negative log likelihood\n}\n```\n:::\n\n\nSEIR 모형에는 세 개의 모수 ($\\beta, \\sigma, \\gamma$)가 있는데 $\\sigma, \\gamma$는 각각 잠복기와 회복까지 걸리는 시간을 나타내고 환자들을 관찰하여 그 값을 추정할 수 있는 경우가 많다. 이에 반해 $\\beta$는 수리 모형의 예측값을 관찰된 유행 곡선과 비교하여 추정한다. 이 과정이 negloglik 함수에 구현된 것이고 optim 함수를 사용하여 negloglik를 최소화하는 \\$\\beta \\$를 구한다.\\\n$$ \\hat{\\theta} = \\textrm{argmax}_{\\theta}\\{{\\mathrm{log} \\mathcal{L}(\\theta)} \\}$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(45)\n# gamma and x0 are set to the same as the model used to generate the data\nparm = list(gamma=0.3)\nx0 = c(S=9990, I=10, R=0, Inc=0)# initial condition\nniter = 50\n# out = pmc(params = parm, x0 = x0, y=y, npart=10000, niter=niter,\n#    tend = length(y), dt=0.1, prior_mean=0.5, prior_sd=0.1, prior_lb=0,\n#    prior_ub=2)\n# saveRDS(out, \"out_20230811.rds\")\n\n# out <- readRDS(\"out_20230811.rds\")\n# hist(out$theta[niter,], xlab=expression(beta), main=\"\")\n# abline(v=truebeta, col=2, lwd=2)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}